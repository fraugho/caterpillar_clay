<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caterpillar Clay</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <!-- Clerk -->
    <script async crossorigin="anonymous" data-clerk-publishable-key="YOUR_CLERK_PUBLISHABLE_KEY" src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js" type="text/javascript"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;image-rendering:pixelated}
        body{font-family:'Press Start 2P',cursive;background:#f0e6d2;cursor:none;min-height:100vh}
        .pixel{box-shadow:4px 0 0 #4a2c2a,-4px 0 0 #4a2c2a,0 4px 0 #4a2c2a,0 -4px 0 #4a2c2a}
        .btn{background:#8b5e3c;color:#fff;padding:12px 16px;font-family:inherit;font-size:8px;border:none;cursor:none}
        .btn:hover{background:#6b4e2c}
        .btn:disabled{background:#ccc;cursor:not-allowed}
        .btn-sm{padding:8px 12px;font-size:6px}
        input,textarea{width:100%;padding:12px;font-family:inherit;font-size:8px;margin-bottom:16px;border:none}
        #caterpillar{position:fixed;pointer-events:none;z-index:9999;will-change:transform;left:0;top:0}
        .loading{opacity:0.6;pointer-events:none}
        .product-img{width:100%;height:320px;object-fit:cover;background:#d1fae5;border:4px solid #000;margin-bottom:12px}
        .order-card{background:#f0fdf4;padding:16px;margin-bottom:12px}
        .status{display:inline-block;padding:4px 8px;font-size:6px;background:#eab308;color:#000}
        .status-paid{background:#22c55e}
        .status-shipped{background:#8b5cf6;color:#fff}
        .status-delivered{background:#10b981;color:#fff}
        .auth-btn{background:transparent;border:2px solid #fff;color:#fff;padding:8px 12px;font-family:inherit;font-size:8px;cursor:none}
        .auth-btn:hover{background:rgba(255,255,255,0.1)}
        .user-menu{position:relative}
        .user-dropdown{display:none;position:absolute;right:0;top:100%;background:#8b5e3c;padding:8px;min-width:150px;z-index:100}
        .user-dropdown.show{display:block}
        .user-dropdown a{display:block;color:#fff;text-decoration:none;padding:8px;font-size:8px}
        .user-dropdown a:hover{background:#6b4e2c}
    </style>
</head>
<body x-data="shop()">

    <canvas id="caterpillar" width="72" height="40"></canvas>

    <nav style="background:#8b5e3c;padding:20px;border-bottom:8px solid #4a2c2a">
        <div style="max-width:900px;margin:auto;display:flex;justify-content:space-between;align-items:center;color:#fff">
            <span style="font-size:12px">CATERPILLAR CLAY</span>
            <div style="display:flex;gap:24px;font-size:10px;align-items:center">
                <a href="#" @click.prevent="page='home'" style="color:#fff;text-decoration:none">HOME</a>
                <a href="#" @click.prevent="page='cart'" style="color:#fff;text-decoration:none">CART (<span x-text="cart.length"></span>)</a>
                <template x-if="user">
                    <a href="#" @click.prevent="page='orders'" style="color:#fff;text-decoration:none">MY ORDERS</a>
                </template>
                <template x-if="!user">
                    <button class="auth-btn" @click="signIn()">SIGN IN</button>
                </template>
                <template x-if="user">
                    <div class="user-menu">
                        <button class="auth-btn" @click="showUserMenu = !showUserMenu" x-text="user.firstName || 'Account'"></button>
                        <div class="user-dropdown" :class="{ show: showUserMenu }">
                            <a href="#" @click.prevent="page='orders'; showUserMenu=false">My Orders</a>
                            <template x-if="user.isAdmin">
                                <a href="/admin/">Admin Panel</a>
                            </template>
                            <a href="#" @click.prevent="signOut()">Sign Out</a>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </nav>

    <main style="max-width:900px;margin:40px auto;padding:0 20px">
        <!-- Home / Products -->
        <template x-if="page=='home'">
            <div class="pixel" style="background:#fff;padding:32px">
                <h2 style="font-size:14px;margin-bottom:24px">Fresh from the Kiln</h2>
                <div :class="{ loading: loadingProducts }" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:32px">
                    <template x-for="p in products" :key="p.id">
                        <div class="pixel" style="padding:20px;background:#f0fdf4;text-align:center">
                            <template x-if="p.image_url">
                                <img :src="p.image_url" :alt="p.name" class="product-img">
                            </template>
                            <template x-if="!p.image_url">
                                <div class="product-img" style="display:flex;align-items:center;justify-content:center;font-size:10px">[IMAGE]</div>
                            </template>
                            <p style="font-size:10px;margin-bottom:10px" x-text="p.name"></p>
                            <p style="font-size:12px;color:#22c55e;margin-bottom:10px">$<span x-text="p.price.toFixed(2)"></span></p>
                            <p style="font-size:8px;color:#666;margin-bottom:14px" x-text="p.stock_quantity > 0 ? 'In Stock' : 'Out of Stock'"></p>
                            <button class="btn pixel" @click="addToCart(p)" :disabled="p.stock_quantity <= 0">ADD TO CART</button>
                        </div>
                    </template>
                </div>
                <template x-if="!loadingProducts && products.length === 0">
                    <p style="font-size:10px;text-align:center;color:#666">No products available yet. Check back soon!</p>
                </template>
            </div>
        </template>

        <!-- Cart -->
        <template x-if="page=='cart'">
            <div class="pixel" style="background:#fff;padding:32px">
                <h2 style="font-size:14px;margin-bottom:24px">Your Cart</h2>
                <template x-if="!cart.length"><p style="font-size:10px">Cart is empty</p></template>
                <template x-for="(item,i) in cart" :key="i">
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:2px dashed #ccc;font-size:10px">
                        <span x-text="item.name"></span>
                        <div style="display:flex;align-items:center;gap:12px">
                            <span>$<span x-text="item.price.toFixed(2)"></span></span>
                            <button class="btn btn-sm" @click="removeFromCart(i)" style="background:#dc2626">X</button>
                        </div>
                    </div>
                </template>
                <template x-if="cart.length">
                    <div style="margin-top:24px">
                        <p style="font-size:12px;margin-bottom:16px">Total: $<span x-text="cartTotal.toFixed(2)"></span></p>
                        <button class="btn pixel" @click="page='checkout';step=1">CHECKOUT</button>
                    </div>
                </template>
            </div>
        </template>

        <!-- Checkout -->
        <template x-if="page=='checkout'">
            <div class="pixel" style="background:#fff;padding:32px">
                <h2 style="font-size:14px;margin-bottom:24px">Checkout</h2>
                <div style="display:flex;align-items:center;justify-content:center;margin-bottom:32px;gap:4px">
                    <div class="pixel" :style="`width:28px;height:28px;background:${step>=1?'#4a7c4e':'#ccc'};border-radius:4px;position:relative`">
                        <div style="display:flex;justify-content:space-around;padding-top:8px">
                            <div style="width:4px;height:4px;background:#000;border-radius:50%"></div>
                            <div style="width:4px;height:4px;background:#000;border-radius:50%"></div>
                        </div>
                        <div :style="`position:absolute;bottom:4px;left:50%;transform:translateX(-50%);width:${step<3?'6':'10'}px;height:${step<2?'2':step<4?'4':'6'}px;background:#3d6840;border-radius:${step<2?'0':'0 0 50px 50px'}`"></div>
                    </div>
                    <template x-for="i in 3" :key="i">
                        <div class="pixel" :style="`width:22px;height:22px;background:${i<step?'#4a7c4e':'#ccc'};border-radius:4px`"></div>
                    </template>
                </div>

                <!-- Step 1: Auth Check -->
                <template x-if="step==1">
                    <div>
                        <p style="font-size:10px;margin-bottom:16px">Step 1: Sign In</p>
                        <template x-if="!user">
                            <div>
                                <p style="font-size:8px;margin-bottom:16px;color:#666">Please sign in to continue with your order.</p>
                                <button class="btn pixel" @click="signIn()">SIGN IN</button>
                            </div>
                        </template>
                        <template x-if="user">
                            <div>
                                <p style="font-size:8px;margin-bottom:16px;color:#22c55e">Signed in as <span x-text="user.emailAddresses[0]?.emailAddress"></span></p>
                                <button class="btn pixel" @click="step=2">CONTINUE</button>
                            </div>
                        </template>
                    </div>
                </template>

                <!-- Step 2: Shipping -->
                <template x-if="step==2">
                    <div>
                        <p style="font-size:10px;margin-bottom:16px">Step 2: Shipping Address</p>
                        <input type="text" x-model="shipping.name" placeholder="Full Name" class="pixel">
                        <input type="text" x-model="shipping.street" placeholder="Street Address" class="pixel">
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                            <input type="text" x-model="shipping.city" placeholder="City" class="pixel">
                            <input type="text" x-model="shipping.state" placeholder="State" class="pixel">
                        </div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                            <input type="text" x-model="shipping.zip" placeholder="ZIP Code" class="pixel">
                            <input type="text" x-model="shipping.country" placeholder="Country" class="pixel" value="USA">
                        </div>
                        <button class="btn pixel" @click="step=3" :disabled="!isShippingValid">NEXT</button>
                    </div>
                </template>

                <!-- Step 3: Review -->
                <template x-if="step==3">
                    <div>
                        <p style="font-size:10px;margin-bottom:16px">Step 3: Review Order</p>
                        <div style="margin-bottom:16px">
                            <template x-for="item in cart" :key="item.id">
                                <p style="font-size:8px;margin-bottom:4px"><span x-text="item.name"></span> - $<span x-text="item.price.toFixed(2)"></span></p>
                            </template>
                        </div>
                        <p style="font-size:10px;margin-bottom:8px">Shipping to:</p>
                        <p style="font-size:8px;color:#666;margin-bottom:16px" x-text="`${shipping.name}, ${shipping.street}, ${shipping.city}, ${shipping.state} ${shipping.zip}`"></p>
                        <p style="font-size:12px;margin-bottom:16px;color:#22c55e">Total: $<span x-text="cartTotal.toFixed(2)"></span></p>
                        <button class="btn pixel" @click="placeOrder()" :disabled="processingOrder">
                            <span x-text="processingOrder ? 'PROCESSING...' : 'PLACE ORDER'"></span>
                        </button>
                    </div>
                </template>

                <!-- Step 4: Complete -->
                <template x-if="step==4">
                    <div style="text-align:center">
                        <p style="font-size:12px;margin-bottom:8px">Order Complete!</p>
                        <p style="font-size:8px;color:#666;margin-bottom:16px">The caterpillar is happy</p>
                        <p style="font-size:8px;color:#666;margin-bottom:16px" x-text="orderMessage"></p>
                        <button class="btn pixel" @click="page='orders'">VIEW MY ORDERS</button>
                    </div>
                </template>
            </div>
        </template>

        <!-- Orders -->
        <template x-if="page=='orders'">
            <div class="pixel" style="background:#fff;padding:32px">
                <h2 style="font-size:14px;margin-bottom:24px">My Orders</h2>
                <template x-if="!user">
                    <div>
                        <p style="font-size:10px;margin-bottom:16px">Please sign in to view your orders.</p>
                        <button class="btn pixel" @click="signIn()">SIGN IN</button>
                    </div>
                </template>
                <template x-if="user && loadingOrders">
                    <p style="font-size:10px">Loading orders...</p>
                </template>
                <template x-if="user && !loadingOrders && orders.length === 0">
                    <p style="font-size:10px">No orders yet. <a href="#" @click.prevent="page='home'" style="color:#8b5e3c">Start shopping!</a></p>
                </template>
                <template x-for="order in orders" :key="order.id">
                    <div class="order-card pixel">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                            <span style="font-size:8px">Order #<span x-text="order.id.substring(0,8)"></span></span>
                            <span class="status" :class="'status-' + order.status" x-text="order.status.toUpperCase()"></span>
                        </div>
                        <p style="font-size:10px;margin-bottom:8px">$<span x-text="order.total.toFixed(2)"></span></p>
                        <p style="font-size:6px;color:#666;margin-bottom:8px" x-text="new Date(order.created_at).toLocaleDateString()"></p>
                        <template x-if="order.tracking_number">
                            <p style="font-size:8px;color:#8b5e3c">Tracking: <span x-text="order.tracking_number"></span></p>
                        </template>
                        <div style="margin-top:8px">
                            <template x-for="item in order.items" :key="item.product_id">
                                <p style="font-size:6px;color:#666"><span x-text="item.product_name"></span> x<span x-text="item.quantity"></span></p>
                            </template>
                        </div>
                    </div>
                </template>
            </div>
        </template>
    </main>

    <script>
        function shop(){
            return{
                page:'home',
                step:1,
                cart:[],
                products:[],
                orders:[],
                user:null,
                showUserMenu:false,
                loadingProducts:true,
                loadingOrders:false,
                processingOrder:false,
                orderMessage:'',
                shipping:{name:'',street:'',city:'',state:'',zip:'',country:'USA'},

                get cartTotal(){
                    return this.cart.reduce((a,b)=>a+b.price,0);
                },

                get isShippingValid(){
                    return this.shipping.name && this.shipping.street && this.shipping.city && this.shipping.state && this.shipping.zip;
                },

                async init(){
                    await this.loadProducts();
                    this.initClerk();
                },

                async initClerk(){
                    try {
                        await window.Clerk.load();
                        this.user = window.Clerk.user;
                        if(this.user){
                            await this.syncUser();
                            this.loadOrders();
                        }
                        window.Clerk.addListener(({user})=>{
                            this.user = user;
                            if(user){
                                this.syncUser();
                                this.loadOrders();
                            }
                        });
                    } catch(e){
                        console.log('Clerk not configured');
                    }
                },

                async syncUser(){
                    try {
                        await fetch('/api/auth/sync',{
                            method:'POST',
                            headers:{'Content-Type':'application/json'},
                            body:JSON.stringify({clerk_id:this.user.id})
                        });
                    }catch(e){
                        console.error('Failed to sync user:',e);
                    }
                },

                async signIn(){
                    if(window.Clerk){
                        window.Clerk.openSignIn();
                    }
                },

                async signOut(){
                    if(window.Clerk){
                        await window.Clerk.signOut();
                        this.user = null;
                        this.orders = [];
                        this.showUserMenu = false;
                        this.page = 'home';
                    }
                },

                async loadProducts(){
                    this.loadingProducts = true;
                    try {
                        const res = await fetch('/api/products');
                        this.products = await res.json();
                    }catch(e){
                        console.error('Failed to load products:',e);
                        this.products = [];
                    }
                    this.loadingProducts = false;
                },

                async loadOrders(){
                    if(!this.user) return;
                    this.loadingOrders = true;
                    try {
                        const token = await window.Clerk.session.getToken();
                        const res = await fetch('/api/orders',{
                            headers:{'Authorization':`Bearer ${token}`}
                        });
                        if(res.ok){
                            this.orders = await res.json();
                        }
                    }catch(e){
                        console.error('Failed to load orders:',e);
                    }
                    this.loadingOrders = false;
                },

                addToCart(product){
                    this.cart.push({...product});
                },

                removeFromCart(index){
                    this.cart.splice(index,1);
                },

                async placeOrder(){
                    if(!this.user || this.processingOrder) return;

                    this.processingOrder = true;
                    try {
                        const token = await window.Clerk.session.getToken();
                        const items = this.cart.map(p=>({product_id:p.id,quantity:1}));

                        const res = await fetch('/api/checkout',{
                            method:'POST',
                            headers:{
                                'Content-Type':'application/json',
                                'Authorization':`Bearer ${token}`
                            },
                            body:JSON.stringify({
                                items,
                                shipping_address:this.shipping
                            })
                        });

                        if(res.ok){
                            const data = await res.json();
                            if(data.checkout_url){
                                window.location.href = data.checkout_url;
                            } else {
                                this.cart = [];
                                this.step = 4;
                                this.orderMessage = 'Your order has been placed!';
                                await this.loadOrders();
                            }
                        } else {
                            const err = await res.json();
                            alert(err.error || 'Failed to place order');
                        }
                    }catch(e){
                        console.error('Failed to place order:',e);
                        alert('Failed to place order. Please try again.');
                    }
                    this.processingOrder = false;
                }
            }
        }

        (function caterpillar(){
            const el=document.getElementById('caterpillar');
            const ctx=el.getContext('2d');

            let posX=100,posY=100,mouseX=0,mouseY=0,velX=0,velY=0;
            let frame=0,idleTime=0,idleAnim=null,idleFrame=0;
            let lastState='',lastFK=-1,facingRight=true,lastTS=0;

            function draw(state,af){
                const fk=~~af%4;
                if(state===lastState&&fk===lastFK)return;
                lastState=state;lastFK=fk;
                ctx.clearRect(0,0,72,40);

                const w=state==='walk',sl=state==='sleep',al=state==='alert';
                const leg=fk%2,wv=w?Math.sin(fk*1.5):0,bob=w?Math.abs(wv)*2:sl?2:0;

                for(let i=0;i<4;i++){
                    const sx=4+i*12+(w?wv*i*.3:0),sy=18+(w?Math.sin(fk*1.5+(3-i))*1.5:0);
                    if(!sl){ctx.fillStyle='#5a3d2b';ctx.fillRect(sx+2,sy+6+(leg&&i%2?-1:0),3,4);ctx.fillRect(sx+9,sy+6+(leg&&i%2?0:-1),3,4);}
                    ctx.fillStyle='#4a7c4e';ctx.fillRect(sx,sy,14,10);
                    ctx.fillStyle='#3d6840';ctx.fillRect(sx,sy,14,2);ctx.fillRect(sx,sy+8,14,2);
                }

                const hx=52,hy=16-bob;
                ctx.fillStyle='#5a3d2b';ctx.fillRect(hx+4,hy-6,2,6);ctx.fillRect(hx+10,hy-6,2,6);
                ctx.fillStyle='#4a7c4e';ctx.beginPath();ctx.arc(hx+5,hy-8,3,0,6.28);ctx.arc(hx+11,hy-8,3,0,6.28);ctx.fill();
                ctx.fillRect(hx,hy,16,12);ctx.fillStyle='#3d6840';ctx.fillRect(hx,hy,16,2);ctx.fillRect(hx,hy+10,16,2);
                if(!sl){ctx.fillStyle='#5a3d2b';ctx.fillRect(hx+3,hy+10,3,4);ctx.fillRect(hx+10,hy+10,3,4);}
                ctx.fillStyle='#1a1a1a';
                if(sl){ctx.fillRect(hx+3,hy+4,4,2);ctx.fillRect(hx+9,hy+4,4,2);ctx.font='8px sans-serif';ctx.fillText('z',hx+18,hy-2+(fk%2?0:-2));}
                else if(al){ctx.fillRect(hx+3,hy+3,5,5);ctx.fillRect(hx+9,hy+3,5,5);}
                else{ctx.fillRect(hx+4,hy+3,3,4);ctx.fillRect(hx+10,hy+3,3,4);}
            }

            document.addEventListener('mousemove',e=>{mouseX=e.clientX;mouseY=e.clientY});

            function update(ts){
                const dt=lastTS?(ts-lastTS)/1000:.016;lastTS=ts;frame+=dt*8;
                const dx=mouseX-posX,dy=mouseY-posY,dist=Math.sqrt(dx*dx+dy*dy);

                if(dist<48){
                    velX*=.9;velY*=.9;idleTime+=dt;
                    if(idleTime>8&&!idleAnim&&Math.random()<.005){idleAnim='sleep';idleFrame=0;}
                    if(idleAnim==='sleep'){idleFrame+=dt*4;draw('sleep',idleFrame);if(idleFrame>80)idleAnim=null;}
                    else draw('idle',frame);
                }else if(idleTime>.05){
                    draw('alert',0);idleTime=Math.max(0,idleTime-dt*8);
                }else{
                    idleAnim=null;
                    velX+=(dx/dist*150-velX)*.12;velY+=(dy/dist*150-velY)*.12;
                    posX+=velX*dt;posY+=velY*dt;
                    posX=Math.max(36,Math.min(posX,innerWidth-36));
                    posY=Math.max(20,Math.min(posY,innerHeight-20));
                    if(Math.abs(velX)>5)facingRight=velX>0;
                    draw('walk',frame);
                }
                el.style.transform=`translate3d(${posX-36}px,${posY-20}px,0)scaleX(${facingRight?1:-1})`;
                requestAnimationFrame(update);
            }
            draw('idle',0);requestAnimationFrame(update);
        })();
    </script>
</body>
</html>
