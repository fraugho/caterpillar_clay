<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caterpillar Clay</title>
    <link rel="icon" type="image/png" href="/favicon.png" id="favicon">
    <script>
        fetch('/api/site').then(r=>r.json()).then(d=>{if(d.favicon)document.getElementById('favicon').href=d.favicon});
    </script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <!-- Clerk -->
    <script async crossorigin="anonymous" data-clerk-publishable-key="pk_test_Y2FyaW5nLWpheWJpcmQtODYuY2xlcmsuYWNjb3VudHMuZGV2JA" src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js" type="text/javascript"></script>
    <style>
        :root{
            --bg-primary:#F8F8F8;
            --bg-secondary:#FFFFFF;
            --bg-card:#FFFFFF;
            --text-primary:#18191B;
            --text-secondary:#666666;
            --accent:#97BAD9;
            --accent-hover:#7BA3C9;
            --border:#E0E0E0;
            --caterpillar-body:#97BAD9;
            --caterpillar-shadow:#7BA3C9;
        }
        @media(prefers-color-scheme:dark){
            :root{
                --bg-primary:#18191B;
                --bg-secondary:#1E2022;
                --bg-card:#252729;
                --text-primary:#F8F8F8;
                --text-secondary:#A0A0A0;
                --accent:#97BAD9;
                --accent-hover:#AECCE8;
                --border:#333537;
                --caterpillar-body:#97BAD9;
                --caterpillar-shadow:#7BA3C9;
            }
        }
        *{margin:0;padding:0;box-sizing:border-box;image-rendering:pixelated}
        body{font-family:'Press Start 2P',cursive;background:var(--bg-primary);color:var(--text-primary);cursor:none;min-height:100vh;transition:background .3s,color .3s;position:relative}
        .stars{position:fixed;inset:0;pointer-events:none;z-index:0;overflow:hidden}
        .star{position:absolute;background:var(--accent);opacity:0.4}
        .star.twinkle{animation:twinkle 2s ease-in-out infinite}
        @keyframes twinkle{0%,100%{opacity:0.2}50%{opacity:0.6}}
        .card{background:var(--bg-card);border:2px solid var(--border);border-radius:12px}
        .btn{background:var(--accent);color:#18191B;padding:14px 20px;font-family:inherit;font-size:8px;border:none;cursor:none;border-radius:8px;width:100%;transition:background .2s}
        .btn:hover{background:var(--accent-hover)}
        .btn:disabled{background:var(--border);cursor:not-allowed}
        .btn-sm{padding:8px 12px;font-size:6px;width:auto;border-radius:6px}
        input,textarea{width:100%;padding:12px;font-family:inherit;font-size:8px;margin-bottom:16px;border:2px solid var(--border);border-radius:8px;background:var(--bg-secondary);color:var(--text-primary)}
        #caterpillar{position:fixed;pointer-events:none;z-index:9999;will-change:transform;left:0;top:0}
        [x-cloak]{display:none !important}
        .loading{opacity:0.6;pointer-events:none}
        .product-img{width:100%;height:380px;object-fit:cover;background:var(--bg-secondary);border:2px solid var(--border);border-radius:8px;margin-bottom:12px;transition:transform .2s}
        .product-card{cursor:none;transition:transform .2s,box-shadow .2s;will-change:transform;backface-visibility:hidden}
        .product-card:hover{transform:translateY(-4px);box-shadow:0 8px 24px rgba(0,0,0,0.1)}
        .product-card:hover .product-img{transform:scale(1.02)}
        .order-card{background:var(--bg-card);padding:16px;margin-bottom:12px;border:2px solid var(--border);border-radius:12px}
        .status{display:inline-block;padding:4px 8px;font-size:6px;background:#eab308;color:#000;border-radius:6px}
        .status-paid{background:#22c55e}
        .status-shipped{background:#8b5cf6;color:#fff}
        .status-delivered{background:#10b981;color:#fff}
        .auth-btn{background:transparent;border:2px solid #fff;color:#fff;padding:8px 12px;font-family:inherit;font-size:8px;cursor:none;border-radius:6px;width:auto}
        .auth-btn:hover{background:rgba(255,255,255,0.1)}
        .user-menu{position:relative}
        .user-dropdown{display:none;position:absolute;right:0;top:100%;background:#5a8ab5;padding:8px;min-width:150px;z-index:100;border-radius:8px;margin-top:8px}
        .user-dropdown.show{display:block}
        .user-dropdown a{display:block;color:#fff;text-decoration:none;padding:8px;font-size:8px;border-radius:4px}
        .user-dropdown a:hover{background:#4a7a9f}
        .detail-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:var(--bg-primary);z-index:1000;overflow-y:auto;padding:80px 20px 20px 20px}
        .detail-overlay .stars{position:absolute;inset:0;z-index:0;pointer-events:none}
        .detail-overlay .detail-content{position:relative;z-index:1;display:block}
        .gallery-img{width:100%;max-width:600px;border-radius:12px;margin-bottom:20px;border:2px solid var(--border)}
        .back-btn{position:fixed;top:20px;left:20px;z-index:1002;background:var(--accent);color:#18191B;padding:12px 16px;font-family:inherit;font-size:8px;border:none;cursor:none;border-radius:8px}
        .back-btn:hover{background:var(--accent-hover)}
        .carousel{position:relative;width:100%;height:380px;overflow:hidden;border-radius:8px;border:2px solid var(--border);margin-bottom:12px;background:var(--bg-secondary)}
        .carousel-inner{display:flex;transition:transform 0.3s ease;height:100%}
        .carousel-inner img{min-width:100%;height:100%;object-fit:cover;background:var(--bg-secondary)}
        .carousel-btn{position:absolute;top:50%;transform:translateY(-50%);background:rgba(0,0,0,0.5);color:#fff;border:none;padding:10px 14px;cursor:none;font-size:14px;border-radius:6px;z-index:10}
        .carousel-btn.prev{left:8px}
        .carousel-btn.next{right:8px}
        .carousel-dots{position:absolute;bottom:12px;left:50%;transform:translateX(-50%);display:flex;gap:6px;z-index:10}
        .carousel-dot{width:10px;height:10px;border-radius:50%;background:rgba(255,255,255,0.5);border:none;cursor:none}
        .carousel-dot.active{background:#fff}
        .detail-carousel{width:100%;height:650px;margin:0 auto 32px;background:var(--bg-secondary)}
        .carousel-inner img{background:var(--bg-secondary)}
        .img-placeholder{background:var(--bg-secondary);display:flex;align-items:center;justify-content:center}
        .qty-controls{display:flex;align-items:center;justify-content:center;gap:0;width:100%}
        .qty-btn{background:var(--accent);color:#18191B;padding:14px 18px;font-family:inherit;font-size:12px;border:none;cursor:none;transition:background .2s}
        .qty-btn:hover{background:var(--accent-hover)}
        .qty-btn.minus{border-radius:8px 0 0 8px}
        .qty-btn.plus{border-radius:0 8px 8px 0}
        .qty-display{background:var(--bg-secondary);color:var(--text-primary);padding:14px 20px;font-family:inherit;font-size:10px;border-top:2px solid var(--border);border-bottom:2px solid var(--border);min-width:50px;text-align:center}
        @media(max-width:768px){
            .detail-carousel{height:300px;margin:0 auto 20px}
            .detail-content>div{margin-top:20px !important}
        }
    </style>
</head>
<body x-data="shop()">

    <div class="stars" id="stars"></div>
    <canvas id="caterpillar" width="72" height="40"></canvas>

    <!-- Product Detail Overlay -->
    <template x-if="selectedProduct && !initializing">
        <div class="detail-overlay" x-data="{ detailIdx: 0, imgReady: false, selectedStyleId: null, get selectedStyle() { return selectedStyleId ? (selectedProduct.styles || []).find(s => s.id === selectedStyleId) : null; }, get hasStyles() { return selectedProduct.styles && selectedProduct.styles.length > 0; }, get stockInfo() { if (this.hasStyles) { if (!this.selectedStyle) { const total = selectedProduct.styles.reduce((sum, s) => sum + s.stock_quantity, 0); return { quantity: total, text: total > 0 ? 'Select a style' : 'Out of Stock' }; } return { quantity: this.selectedStyle.stock_quantity, text: this.selectedStyle.stock_quantity > 0 ? 'In Stock' : 'Out of Stock' }; } return { quantity: selectedProduct.stock_quantity, text: selectedProduct.stock_quantity > 0 ? 'In Stock' : 'Out of Stock' }; } }" x-init="$nextTick(() => window.generateStarsIn($el.querySelector('.stars')))" @style-select.window="if($event.detail.productId === selectedProduct.id && $event.detail.imageIndex !== undefined) detailIdx = $event.detail.imageIndex">
            <div class="stars"></div>
            <div class="detail-content">
                <div style="max-width:900px;margin:0 auto;padding:0 20px">
                    <div class="card" style="padding:40px;text-align:center;overflow:hidden;display:block" x-show="imgReady || !selectedProduct.images || selectedProduct.images.length === 0" x-transition.opacity.duration.200ms>
                    <div class="carousel detail-carousel">
                        <template x-if="selectedProduct.images && selectedProduct.images.length > 0">
                            <div class="carousel-inner" :style="`transform: translateX(-${detailIdx * 100}%)`">
                                <template x-for="(img, i) in selectedProduct.images" :key="img">
                                    <img :src="img" :alt="selectedProduct.name" @load="if(i===0) imgReady = true">
                                </template>
                            </div>
                        </template>
                        <template x-if="selectedProduct.images && selectedProduct.images.length > 1">
                            <button class="carousel-btn prev" @click="detailIdx = (detailIdx - 1 + selectedProduct.images.length) % selectedProduct.images.length">&lt;</button>
                        </template>
                        <template x-if="selectedProduct.images && selectedProduct.images.length > 1">
                            <button class="carousel-btn next" @click="detailIdx = (detailIdx + 1) % selectedProduct.images.length">&gt;</button>
                        </template>
                        <template x-if="selectedProduct.images && selectedProduct.images.length > 1">
                            <div class="carousel-dots">
                                <template x-for="(img, idx) in selectedProduct.images" :key="img">
                                    <button class="carousel-dot" :class="{ active: idx === detailIdx }" @click="detailIdx = idx"></button>
                                </template>
                            </div>
                        </template>
                    </div>
                    <div style="display:block;width:100%">
                        <h1 style="font-size:20px;margin-bottom:20px;display:block" x-text="selectedProduct.name"></h1>
                        <p style="font-size:18px;color:var(--accent);margin-bottom:20px;display:block">$<span x-text="selectedProduct.price.toFixed(2)"></span></p>
                        <p style="font-size:12px;color:var(--text-secondary);margin-bottom:28px;display:block" x-text="selectedProduct.stock_quantity > 0 ? 'In Stock' : 'Out of Stock'"></p>
                        <template x-if="selectedProduct.description">
                            <p style="font-size:10px;color:var(--text-secondary);margin-bottom:28px;line-height:2;display:block" x-text="selectedProduct.description"></p>
                        </template>

                        <!-- Style Selector -->
                        <template x-if="hasStyles">
                            <div style="max-width:700px;margin:0 auto 28px;display:block">
                                <p style="font-size:12px;color:var(--text-secondary);margin-bottom:16px;text-align:center">Select Style:</p>
                                <div style="display:flex;flex-wrap:wrap;gap:12px;justify-content:center">
                                    <template x-for="style in selectedProduct.styles" :key="style.id">
                                        <button
                                            :style="{
                                                background: selectedStyleId === style.id ? 'var(--accent)' : (style.stock_quantity > 0 ? 'var(--bg-secondary)' : '#4b5563'),
                                                color: selectedStyleId === style.id ? '#18191B' : 'var(--text-primary)',
                                                border: '3px solid ' + (selectedStyleId === style.id ? 'var(--accent-hover)' : 'var(--border)'),
                                                opacity: style.stock_quantity === 0 ? 0.7 : 1,
                                                padding: '16px 20px',
                                                borderRadius: '10px',
                                                fontFamily: 'inherit',
                                                fontSize: '9px',
                                                cursor: 'none',
                                                transition: 'all 0.2s',
                                                transform: selectedStyleId === style.id ? 'scale(1.05)' : 'scale(1)',
                                                minWidth: '140px'
                                            }"
                                            @click="selectedStyleId = style.id; if(style.image_index !== null && style.image_index !== undefined) detailIdx = style.image_index"
                                        >
                                            <span x-text="style.name" style="display:block;margin-bottom:4px"></span>
                                            <span style="font-size:7px;display:block" :style="{ color: style.stock_quantity > 0 ? (selectedStyleId === style.id ? '#18191B' : '#22c55e') : '#ef4444' }" x-text="style.stock_quantity > 0 ? style.stock_quantity + ' available' : 'Out of Stock'"></span>
                                        </button>
                                    </template>
                                </div>
                            </div>
                        </template>

                        <p style="font-size:12px;color:var(--text-secondary);margin-bottom:28px;display:block" x-text="stockInfo.text"></p>

                        <!-- No styles: simple add to cart -->
                        <template x-if="!hasStyles && selectedProduct.stock_quantity > 0 && getCartQuantity(selectedProduct.id) === 0">
                            <button class="btn" style="max-width:500px;margin:0 auto;padding:18px 24px;font-size:10px;display:block" @click="addToCart(selectedProduct)">ADD TO CART</button>
                        </template>
                        <template x-if="!hasStyles && selectedProduct.stock_quantity > 0 && getCartQuantity(selectedProduct.id) > 0">
                            <div class="qty-controls" style="max-width:500px;margin:0 auto">
                                <button class="qty-btn minus" style="padding:18px 24px" @click="updateCartQuantity(selectedProduct.id, -1)">-</button>
                                <span class="qty-display" style="padding:18px 24px;font-size:12px" x-text="getCartQuantity(selectedProduct.id)"></span>
                                <button class="qty-btn plus" style="padding:18px 24px" @click="addToCart(selectedProduct)">+</button>
                            </div>
                        </template>
                        <template x-if="!hasStyles && selectedProduct.stock_quantity <= 0">
                            <div style="max-width:500px;margin:0 auto">
                                <template x-if="notifyProductId !== selectedProduct.id && !isProductNotified(selectedProduct.id)">
                                    <button class="btn" style="background:#f59e0b;color:#18191B;padding:18px 24px;font-size:10px;width:100%" @click="showNotifyForm(selectedProduct.id)">NOTIFY ME WHEN AVAILABLE</button>
                                </template>
                                <template x-if="isProductNotified(selectedProduct.id)">
                                    <button class="btn" style="background:#22c55e;padding:18px 24px;font-size:10px;width:100%" disabled>YOU'LL BE NOTIFIED</button>
                                </template>
                                <template x-if="notifyProductId === selectedProduct.id">
                                    <div style="text-align:center">
                                        <p style="font-size:10px;margin-bottom:16px;color:var(--text-secondary)">Get notified when this item is back in stock</p>
                                        <input type="email" x-model="notifyEmail" placeholder="your@email.com" style="margin-bottom:12px">
                                        <div style="display:flex;gap:12px">
                                            <button class="btn" style="flex:1;background:var(--border);color:var(--text-primary)" @click="closeNotifyForm()">CANCEL</button>
                                            <button class="btn" style="flex:1" @click="subscribeProductNotify(selectedProduct.id)" :disabled="notifyingProduct || !notifyEmail">
                                                <span x-text="notifyingProduct ? 'SUBSCRIBING...' : 'NOTIFY ME'"></span>
                                            </button>
                                        </div>
                                        <p x-show="notifyMessage" x-text="notifyMessage" style="font-size:8px;margin-top:12px" :style="{ color: notifySuccess ? '#22c55e' : '#ef4444' }"></p>
                                    </div>
                                </template>
                            </div>
                        </template>

                        <!-- Has styles: show add to cart or notify based on selected style -->
                        <template x-if="hasStyles && selectedStyle && selectedStyle.stock_quantity > 0">
                            <div style="max-width:500px;margin:0 auto">
                                <template x-if="getCartQuantity(selectedProduct.id, selectedStyleId) === 0">
                                    <button class="btn" style="padding:18px 24px;font-size:10px;width:100%" @click="addToCartWithStyle(selectedProduct, selectedStyleId, selectedStyle.name)">ADD TO CART</button>
                                </template>
                                <template x-if="getCartQuantity(selectedProduct.id, selectedStyleId) > 0">
                                    <div class="qty-controls">
                                        <button class="qty-btn minus" style="padding:18px 24px" @click="updateCartQuantity(selectedProduct.id, -1, selectedStyleId)">-</button>
                                        <span class="qty-display" style="padding:18px 24px;font-size:12px" x-text="getCartQuantity(selectedProduct.id, selectedStyleId)"></span>
                                        <button class="qty-btn plus" style="padding:18px 24px" @click="addToCartWithStyle(selectedProduct, selectedStyleId, selectedStyle.name)">+</button>
                                    </div>
                                </template>
                            </div>
                        </template>
                        <template x-if="hasStyles && selectedStyle && selectedStyle.stock_quantity === 0">
                            <div style="max-width:500px;margin:0 auto">
                                <template x-if="notifyProductId !== selectedProduct.id && !isStyleNotified(selectedProduct.id, selectedStyleId)">
                                    <button class="btn" style="background:#f59e0b;color:#18191B;padding:18px 24px;font-size:10px;width:100%" @click="showNotifyForm(selectedProduct.id, selectedStyleId)">NOTIFY ME WHEN AVAILABLE</button>
                                </template>
                                <template x-if="isStyleNotified(selectedProduct.id, selectedStyleId)">
                                    <button class="btn" style="background:#22c55e;padding:18px 24px;font-size:10px;width:100%" disabled>YOU'LL BE NOTIFIED</button>
                                </template>
                                <template x-if="notifyProductId === selectedProduct.id">
                                    <div style="text-align:center">
                                        <p style="font-size:10px;margin-bottom:16px;color:var(--text-secondary)">Get notified when <span x-text="selectedStyle.name"></span> is back in stock</p>
                                        <input type="email" x-model="notifyEmail" placeholder="your@email.com" style="margin-bottom:12px">
                                        <div style="display:flex;gap:12px">
                                            <button class="btn" style="flex:1;background:var(--border);color:var(--text-primary)" @click="closeNotifyForm()">CANCEL</button>
                                            <button class="btn" style="flex:1" @click="subscribeStyleNotify(selectedProduct.id, selectedStyleId)" :disabled="notifyingProduct || !notifyEmail">
                                                <span x-text="notifyingProduct ? 'SUBSCRIBING...' : 'NOTIFY ME'"></span>
                                            </button>
                                        </div>
                                        <p x-show="notifyMessage" x-text="notifyMessage" style="font-size:8px;margin-top:12px" :style="{ color: notifySuccess ? '#22c55e' : '#ef4444' }"></p>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- You may also like -->
                <template x-if="products.filter(p => p.id !== selectedProduct.id).length > 0">
                    <div style="margin-top:40px" x-show="imgReady || !selectedProduct.images || selectedProduct.images.length === 0">
                        <h3 style="font-size:12px;margin-bottom:20px;text-align:center">You may also like</h3>
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px">
                            <template x-for="p in products.filter(p => p.id !== selectedProduct.id)" :key="p.id">
                                <div class="card product-card" style="padding:16px;text-align:center;cursor:none" @click="detailIdx = 0; imgReady = false; selectedProduct = p; history.pushState({ page: page, productId: p.id }, '', `/product/${p.id}`)">
                                    <div style="width:100%;height:280px;border-radius:8px;border:2px solid var(--border);margin-bottom:12px;background:var(--bg-secondary);overflow:hidden">
                                        <template x-if="p.images && p.images.length > 0">
                                            <img :src="p.images[0]" :alt="p.name" style="width:100%;height:100%;object-fit:cover">
                                        </template>
                                        <template x-if="!p.images || p.images.length === 0">
                                            <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:8px">[IMAGE]</div>
                                        </template>
                                    </div>
                                    <p style="font-size:10px;margin-bottom:8px" x-text="p.name"></p>
                                    <p style="font-size:11px;color:var(--accent)">$<span x-text="p.price.toFixed(2)"></span></p>
                                </div>
                            </template>
                        </div>
                    </div>
                </template>
            </div>
            </div>
        </div>
    </template>

    <nav x-cloak x-show="!initializing" style="background:var(--accent);padding:20px;position:relative;z-index:1001">
        <div style="max-width:900px;margin:auto;display:flex;justify-content:space-between;align-items:center;color:#fff">
            <div style="flex:1;display:flex;gap:16px;font-size:10px">
                <a href="/artist.html" style="color:#fff;text-decoration:none">ARTIST</a>
            </div>
            <a href="#" @click.prevent="navigateToPage('home')" style="font-size:14px;color:#fff;text-decoration:none;cursor:none;text-align:center">CATERPILLAR CLAY</a>
            <div style="flex:1;display:flex;gap:16px;font-size:10px;align-items:center;justify-content:flex-end">
                <a href="#" @click.prevent="navigateToPage('cart')" style="color:#fff;text-decoration:none">CART (<span x-text="cartItemCount"></span>)</a>
                <template x-if="!user">
                    <button class="auth-btn" @click="signIn()">SIGN IN</button>
                </template>
                <template x-if="user">
                    <div class="user-menu">
                        <button class="auth-btn" @click="showUserMenu = !showUserMenu" x-text="user.firstName || 'Account'"></button>
                        <div class="user-dropdown" :class="{ show: showUserMenu }">
                            <a href="#" @click.prevent="navigateToPage('orders')">My Orders</a>
                            <a href="/account.html">Account Settings</a>
                            <template x-if="user.isAdmin">
                                <a href="/gallium/">Admin Panel</a>
                            </template>
                            <a href="#" @click.prevent="signOut()">Sign Out</a>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </nav>

    <main x-cloak x-show="!initializing" style="max-width:900px;margin:40px auto;padding:0 20px">
        <!-- Home / Products -->
        <template x-if="page=='home'">
            <div class="card" style="padding:32px">
                <h2 style="font-size:14px;margin-bottom:24px">Fresh from the Kiln</h2>
                <div :class="{ loading: loadingProducts }" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:32px">
                    <template x-for="p in products" :key="p.id">
                        <div class="card product-card" style="padding:20px;text-align:center" @click="navigateToProduct(p)" x-data="{ imgLoaded: false }" x-show="imgLoaded || !p.images || p.images.length === 0" x-transition.opacity.duration.200ms>
                            <template x-if="p.images && p.images.length > 0">
                                <img :src="p.images[0]" :alt="p.name" class="product-img" @load="imgLoaded = true">
                            </template>
                            <template x-if="!p.images || p.images.length === 0">
                                <div class="product-img" style="display:flex;align-items:center;justify-content:center;font-size:10px">[IMAGE]</div>
                            </template>
                            <p style="font-size:10px;margin-bottom:10px" x-text="p.name"></p>
                            <p style="font-size:12px;color:var(--accent);margin-bottom:10px">$<span x-text="p.price.toFixed(2)"></span></p>
                            <p style="font-size:8px;color:var(--text-secondary);margin-bottom:14px" x-text="p.stock_quantity > 0 ? 'In Stock' : 'Out of Stock'"></p>
                            <template x-if="p.stock_quantity > 0 && getCartQuantity(p.id) === 0">
                                <button class="btn" @click.stop="addToCart(p)">ADD TO CART</button>
                            </template>
                            <template x-if="p.stock_quantity > 0 && getCartQuantity(p.id) > 0">
                                <div class="qty-controls" @click.stop>
                                    <button class="qty-btn minus" @click.stop="updateCartQuantity(p.id, -1)">-</button>
                                    <span class="qty-display" x-text="getCartQuantity(p.id)"></span>
                                    <button class="qty-btn plus" @click.stop="addToCart(p)">+</button>
                                </div>
                            </template>
                            <template x-if="p.stock_quantity <= 0">
                                <div @click.stop>
                                    <template x-if="notifyProductId !== p.id && !isProductNotified(p.id)">
                                        <button class="btn" style="background:#f59e0b;color:#18191B" @click.stop="showNotifyForm(p.id)">NOTIFY ME</button>
                                    </template>
                                    <template x-if="isProductNotified(p.id)">
                                        <button class="btn" style="background:#22c55e" disabled>NOTIFIED</button>
                                    </template>
                                    <template x-if="notifyProductId === p.id">
                                        <div style="text-align:center">
                                            <input type="email" x-model="notifyEmail" placeholder="your@email.com" style="margin-bottom:8px;font-size:7px;padding:10px" @click.stop>
                                            <div style="display:flex;gap:8px">
                                                <button class="btn btn-sm" style="flex:1;background:var(--border);color:var(--text-primary)" @click.stop="closeNotifyForm()">CANCEL</button>
                                                <button class="btn btn-sm" style="flex:1" @click.stop="subscribeProductNotify(p.id)" :disabled="notifyingProduct || !notifyEmail">
                                                    <span x-text="notifyingProduct ? '...' : 'NOTIFY'"></span>
                                                </button>
                                            </div>
                                            <p x-show="notifyMessage" x-text="notifyMessage" style="font-size:6px;margin-top:8px" :style="{ color: notifySuccess ? '#22c55e' : '#ef4444' }"></p>
                                        </div>
                                    </template>
                                </div>
                            </template>
                        </div>
                    </template>
                </div>
                <template x-if="!loadingProducts && products.length === 0">
                    <p style="font-size:10px;text-align:center;color:var(--text-secondary)">No products available yet. Check back soon!</p>
                </template>
            </div>
        </template>

        <!-- Cart -->
        <template x-if="page=='cart'">
            <div class="card" style="padding:32px">
                <h2 style="font-size:14px;margin-bottom:24px">Your Cart</h2>
                <template x-if="!cart.length"><p style="font-size:10px">Cart is empty</p></template>
                <template x-for="item in cart" :key="item.id + ':' + (item.styleId || '')">
                    <div style="display:flex;align-items:center;padding:16px 0;border-bottom:2px dashed var(--border);gap:16px">
                        <template x-if="item.images && item.images.length > 0">
                            <img :src="item.images[0]" :alt="item.name" style="width:80px;height:80px;object-fit:cover;border-radius:8px;border:2px solid var(--border)">
                        </template>
                        <template x-if="!item.images || item.images.length === 0">
                            <div style="width:80px;height:80px;background:var(--bg-secondary);border-radius:8px;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:6px;color:var(--text-secondary)">[IMG]</div>
                        </template>
                        <div style="flex:1">
                            <p style="font-size:10px;margin-bottom:6px">
                                <span x-text="item.name"></span>
                                <template x-if="item.styleName">
                                    <span style="color:var(--text-secondary)"> - <span x-text="item.styleName"></span></span>
                                </template>
                            </p>
                            <p style="font-size:10px;color:var(--accent)">$<span x-text="(item.price * item.quantity).toFixed(2)"></span></p>
                        </div>
                        <div class="qty-controls" style="width:auto">
                            <button class="qty-btn minus" style="padding:10px 14px" @click="updateCartQuantity(item.id, -1, item.styleId)">-</button>
                            <span class="qty-display" style="padding:10px 16px;font-size:8px" x-text="item.quantity"></span>
                            <button class="qty-btn plus" style="padding:10px 14px" @click="item.styleId ? addToCartWithStyle(item, item.styleId, item.styleName) : addToCart(item)">+</button>
                        </div>
                        <button class="btn btn-sm" @click="removeFromCart(item.id)" style="background:#dc2626">X</button>
                    </div>
                </template>
                <template x-if="cart.length">
                    <div style="margin-top:24px">
                        <p style="font-size:12px;margin-bottom:16px">Total: $<span x-text="cartTotal.toFixed(2)"></span></p>
                        <button class="btn" @click="navigateToPage('checkout');step=1">CHECKOUT</button>
                    </div>
                </template>
            </div>
        </template>

        <!-- Checkout -->
        <template x-if="page=='checkout'">
            <div class="card" style="padding:32px">
                <h2 style="font-size:14px;margin-bottom:24px">Checkout</h2>
                <div style="display:flex;align-items:center;justify-content:center;margin-bottom:32px;gap:8px">
                    <template x-for="i in 5" :key="i">
                        <div :style="`width:24px;height:24px;background:${i<=step?'var(--accent)':'var(--border)'};border-radius:50%;transition:background .3s`"></div>
                    </template>
                </div>

                <!-- Step 1: Auth Check -->
                <template x-if="step==1">
                    <div>
                        <p style="font-size:10px;margin-bottom:16px">Step 1: Sign In</p>
                        <template x-if="!user">
                            <div>
                                <p style="font-size:8px;margin-bottom:16px;color:var(--text-secondary)">Please sign in to continue with your order.</p>
                                <button class="btn" @click="signIn()">SIGN IN</button>
                            </div>
                        </template>
                        <template x-if="user">
                            <div>
                                <p style="font-size:8px;margin-bottom:16px;color:var(--accent)">Signed in as <span x-text="user.emailAddresses[0]?.emailAddress"></span></p>
                                <button class="btn" @click="step=2">CONTINUE</button>
                            </div>
                        </template>
                    </div>
                </template>

                <!-- Step 2: Shipping Address -->
                <template x-if="step==2">
                    <div>
                        <p style="font-size:10px;margin-bottom:16px">Step 2: Shipping Address</p>
                        <input type="text" x-model="shipping.name" placeholder="Full Name">
                        <input type="text" x-model="shipping.street" placeholder="Street Address">
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                            <input type="text" x-model="shipping.city" placeholder="City">
                            <input type="text" x-model="shipping.state" placeholder="State">
                        </div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                            <input type="text" x-model="shipping.zip" placeholder="ZIP Code">
                            <input type="text" x-model="shipping.country" placeholder="Country" value="USA">
                        </div>
                        <button class="btn" @click="fetchShippingRates()" :disabled="!isShippingValid || loadingShippingRates">
                            <span x-text="loadingShippingRates ? 'CALCULATING SHIPPING...' : 'NEXT'"></span>
                        </button>
                    </div>
                </template>

                <!-- Step 3: Shipping Method -->
                <template x-if="step==3">
                    <div>
                        <p style="font-size:10px;margin-bottom:16px">Step 3: Select Shipping Method</p>
                        <template x-if="shippingRates.length === 0 && !loadingShippingRates">
                            <div>
                                <p style="font-size:8px;color:var(--text-secondary);margin-bottom:16px">No shipping rates available. Please check your address.</p>
                                <button class="btn" style="background:var(--border);color:var(--text-primary)" @click="step=2">BACK</button>
                            </div>
                        </template>
                        <template x-if="shippingRates.length > 0">
                            <div>
                                <div style="display:flex;flex-direction:column;gap:12px;margin-bottom:20px">
                                    <template x-for="rate in shippingRates" :key="rate.rate_id">
                                        <label style="display:flex;align-items:center;gap:12px;padding:16px;background:var(--bg-secondary);border:2px solid var(--border);border-radius:8px;cursor:none" :style="{ borderColor: selectedShippingRate && selectedShippingRate.rate_id === rate.rate_id ? 'var(--accent)' : 'var(--border)' }" @click="selectedShippingRate = rate">
                                            <input type="radio" name="shipping_rate" :value="rate.rate_id" :checked="selectedShippingRate && selectedShippingRate.rate_id === rate.rate_id" style="width:auto;margin:0">
                                            <div style="flex:1">
                                                <p style="font-size:9px;margin-bottom:4px"><span x-text="rate.carrier"></span> - <span x-text="rate.service"></span></p>
                                                <p style="font-size:7px;color:var(--text-secondary)" x-text="rate.estimated_days ? 'Est. ' + rate.estimated_days + ' days' : rate.duration_terms || ''"></p>
                                            </div>
                                            <p style="font-size:10px;color:var(--accent)">$<span x-text="(rate.price_cents / 100).toFixed(2)"></span></p>
                                        </label>
                                    </template>
                                </div>
                                <div style="display:flex;gap:12px">
                                    <button class="btn" style="flex:1;background:var(--border);color:var(--text-primary)" @click="step=2">BACK</button>
                                    <button class="btn" style="flex:1" @click="step=4" :disabled="!selectedShippingRate">NEXT</button>
                                </div>
                            </div>
                        </template>
                    </div>
                </template>

                <!-- Step 4: Review -->
                <template x-if="step==4">
                    <div>
                        <p style="font-size:10px;margin-bottom:16px">Step 4: Review Order</p>
                        <div style="margin-bottom:16px">
                            <template x-for="item in cart" :key="item.id + ':' + (item.styleId || '')">
                                <p style="font-size:8px;margin-bottom:4px">
                                    <span x-text="item.name"></span>
                                    <template x-if="item.styleName"><span style="color:var(--text-secondary)"> (<span x-text="item.styleName"></span>)</span></template>
                                    x<span x-text="item.quantity"></span> - $<span x-text="(item.price * item.quantity).toFixed(2)"></span>
                                </p>
                            </template>
                        </div>
                        <p style="font-size:10px;margin-bottom:8px">Shipping to:</p>
                        <p style="font-size:8px;color:var(--text-secondary);margin-bottom:12px" x-text="`${shipping.name}, ${shipping.street}, ${shipping.city}, ${shipping.state} ${shipping.zip}`"></p>
                        <template x-if="selectedShippingRate">
                            <div style="margin-bottom:16px">
                                <p style="font-size:10px;margin-bottom:8px">Shipping Method:</p>
                                <p style="font-size:8px;color:var(--text-secondary)" x-text="`${selectedShippingRate.carrier} - ${selectedShippingRate.service}`"></p>
                            </div>
                        </template>
                        <div style="border-top:2px dashed var(--border);padding-top:16px;margin-bottom:16px">
                            <p style="font-size:9px;margin-bottom:8px">Subtotal: $<span x-text="cartTotal.toFixed(2)"></span></p>
                            <template x-if="selectedShippingRate">
                                <p style="font-size:9px;margin-bottom:8px">Shipping: $<span x-text="(selectedShippingRate.price_cents / 100).toFixed(2)"></span></p>
                            </template>
                            <p style="font-size:12px;color:var(--accent)">Total: $<span x-text="orderTotal.toFixed(2)"></span></p>
                        </div>
                        <div style="display:flex;gap:12px">
                            <button class="btn" style="flex:1;background:var(--border);color:var(--text-primary)" @click="step=3">BACK</button>
                            <button class="btn" style="flex:1" @click="placeOrder()" :disabled="processingOrder">
                                <span x-text="processingOrder ? 'PROCESSING...' : 'PLACE ORDER'"></span>
                            </button>
                        </div>
                    </div>
                </template>

                <!-- Step 5: Complete -->
                <template x-if="step==5">
                    <div style="text-align:center">
                        <p style="font-size:12px;margin-bottom:8px">Order Complete!</p>
                        <p style="font-size:8px;color:var(--text-secondary);margin-bottom:16px">The caterpillar is happy</p>
                        <p style="font-size:8px;color:var(--text-secondary);margin-bottom:16px" x-text="orderMessage"></p>
                        <button class="btn" @click="navigateToPage('orders')">VIEW MY ORDERS</button>
                    </div>
                </template>
            </div>
        </template>

        <!-- Orders -->
        <template x-if="page=='orders'">
            <div class="card" style="padding:32px">
                <h2 style="font-size:14px;margin-bottom:24px">My Orders</h2>
                <template x-if="!user">
                    <div>
                        <p style="font-size:10px;margin-bottom:16px">Please sign in to view your orders.</p>
                        <button class="btn" @click="signIn()">SIGN IN</button>
                    </div>
                </template>
                <template x-if="user && loadingOrders">
                    <p style="font-size:10px">Loading orders...</p>
                </template>
                <template x-if="user && !loadingOrders && orders.length === 0">
                    <p style="font-size:10px">No orders yet. <a href="#" @click.prevent="navigateToPage('home')" style="color:var(--accent)">Start shopping!</a></p>
                </template>
                <template x-for="order in orders" :key="order.id">
                    <div class="order-card">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                            <span style="font-size:8px">Order #<span x-text="order.id.substring(0,8)"></span></span>
                            <span class="status" :class="'status-' + order.status" x-text="order.status.toUpperCase()"></span>
                        </div>
                        <p style="font-size:10px;margin-bottom:8px">$<span x-text="order.total.toFixed(2)"></span></p>
                        <p style="font-size:6px;color:var(--text-secondary);margin-bottom:8px" x-text="new Date(order.created_at).toLocaleDateString()"></p>
                        <template x-if="order.tracking_number">
                            <p style="font-size:8px;color:var(--accent)">Tracking: <span x-text="order.tracking_number"></span></p>
                        </template>
                        <div style="margin-top:8px">
                            <template x-for="item in order.items" :key="item.product_id">
                                <p style="font-size:6px;color:var(--text-secondary)"><span x-text="item.product_name"></span> x<span x-text="item.quantity"></span></p>
                            </template>
                        </div>
                    </div>
                </template>
            </div>
        </template>
    </main>

    <!-- Newsletter Signup -->
    <footer x-cloak x-show="!initializing && page === 'home' && !selectedProduct" style="background:var(--bg-card);border-top:2px solid var(--border);padding:40px 20px;margin-top:40px;position:relative;z-index:1">
        <div style="max-width:500px;margin:0 auto;text-align:center">
            <h3 style="font-size:12px;color:var(--accent);margin-bottom:16px">STAY IN THE LOOP</h3>
            <p style="font-size:8px;color:var(--text-secondary);margin-bottom:20px;line-height:2">Get notified when we add new handmade pottery pieces</p>
            <form @submit.prevent="subscribeNewsletter()" style="display:flex;gap:12px;max-width:400px;margin:0 auto">
                <input type="email" x-model="newsletterEmail" placeholder="your@email.com" style="flex:1;margin-bottom:0" required>
                <button type="submit" class="btn" style="width:auto;padding:12px 20px" :disabled="subscribing">
                    <span x-text="subscribing ? '...' : 'SUBSCRIBE'"></span>
                </button>
            </form>
            <p x-show="newsletterMessage" x-text="newsletterMessage" style="font-size:8px;margin-top:12px" :style="{ color: newsletterSuccess ? '#22c55e' : '#ef4444' }"></p>
        </div>
    </footer>

    <script>
        function shop(){
            return{
                page:'home',
                step:1,
                cart:[],
                products:[],
                orders:[],
                user:null,
                showUserMenu:false,
                initializing:true,
                loadingProducts:true,
                loadingOrders:false,
                newsletterEmail:'',
                subscribing:false,
                newsletterMessage:'',
                newsletterSuccess:false,
                subscribedEmails:new Set(),
                processingOrder:false,
                orderMessage:'',
                selectedProduct:null,
                pendingProductId:null,
                shipping:{name:'',street:'',city:'',state:'',zip:'',country:'USA'},
                shippingRates:[],
                selectedShippingRate:null,
                loadingShippingRates:false,
                notifyEmail:'',
                notifyProductId:null,
                notifyStyleIds:[],
                notifyingProduct:false,
                notifyMessage:'',
                notifySuccess:false,
                notifiedProducts:new Set(),

                get cartTotal(){
                    return this.cart.reduce((a,b)=>a+(b.price * b.quantity),0);
                },

                get orderTotal(){
                    const subtotal = this.cartTotal;
                    const shipping = this.selectedShippingRate ? this.selectedShippingRate.price_cents / 100 : 0;
                    return subtotal + shipping;
                },

                get cartItemCount(){
                    return this.cart.reduce((a,b)=>a+b.quantity,0);
                },

                getCartQuantity(productId, styleId = null){
                    const item = this.cart.find(c => c.id === productId && c.styleId === styleId);
                    return item ? item.quantity : 0;
                },

                updateCartQuantity(productId, delta, styleId = null){
                    const idx = this.cart.findIndex(c => c.id === productId && c.styleId === styleId);
                    if(idx === -1) return;
                    this.cart[idx].quantity += delta;
                    if(this.cart[idx].quantity <= 0){
                        this.cart.splice(idx, 1);
                    }
                },

                isProductNotified(productId){
                    // Check if any email has been notified for this product (without style)
                    for(const key of this.notifiedProducts){
                        if(key.endsWith(':' + productId + ':')) return true;
                    }
                    return false;
                },

                isStyleNotified(productId, styleId){
                    // Check if this specific style has been notified
                    for(const key of this.notifiedProducts){
                        if(key.endsWith(':' + productId + ':' + styleId)) return true;
                    }
                    return false;
                },

                addToCartWithStyle(product, styleId, styleName){
                    // Find existing item with same product+style
                    const existing = this.cart.find(c => c.id === product.id && c.styleId === styleId);
                    if(existing){
                        existing.quantity++;
                    } else {
                        this.cart.push({
                            id: product.id,
                            styleId: styleId,
                            styleName: styleName,
                            name: product.name,
                            price: product.price,
                            images: product.images,
                            quantity: 1
                        });
                    }
                },

                showNotifyForm(productId, styleId = null){
                    this.notifyProductId = productId;
                    this.notifyStyleIds = styleId ? [styleId] : [];
                    this.notifyMessage = '';
                },

                async subscribeStyleNotify(productId, styleId){
                    const email = this.notifyEmail.toLowerCase().trim();
                    if(!email || !styleId) return;
                    const key = `${email}:${productId}:${styleId}`;
                    if(this.notifiedProducts.has(key)) return;
                    this.notifyingProduct = true;
                    this.notifyMessage = '';
                    try {
                        const res = await fetch(`/api/products/${productId}/notify`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email: email, style_ids: [styleId] })
                        });
                        const data = await res.json();
                        this.notifySuccess = data.success;
                        this.notifyMessage = data.message;
                        if(data.success) {
                            this.notifiedProducts.add(key);
                            localStorage.setItem('notifiedProducts', JSON.stringify([...this.notifiedProducts]));
                            setTimeout(() => this.closeNotifyForm(), 2000);
                        }
                    } catch(e) {
                        this.notifySuccess = false;
                        this.notifyMessage = 'Something went wrong. Please try again.';
                    } finally {
                        this.notifyingProduct = false;
                    }
                },

                get isShippingValid(){
                    return this.shipping.name && this.shipping.street && this.shipping.city && this.shipping.state && this.shipping.zip;
                },

                async init(){
                    // Check URL for pending product before loading
                    const path = window.location.pathname;
                    if (path.startsWith('/product/')) {
                        this.pendingProductId = path.replace('/product/', '');
                    } else if (path === '/cart') {
                        this.page = 'cart';
                    } else if (path === '/orders') {
                        this.page = 'orders';
                    } else if (path === '/checkout') {
                        this.page = 'checkout';
                    }

                    // Load cart from localStorage
                    const savedCart = localStorage.getItem('cart');
                    if (savedCart) {
                        try {
                            const parsed = JSON.parse(savedCart);
                            // Migrate old cart format: add quantity if missing, dedupe by id+styleId
                            const cartMap = new Map();
                            for (const item of parsed) {
                                if (!item.id) continue;
                                const key = item.id + ':' + (item.styleId || '');
                                if (cartMap.has(key)) {
                                    cartMap.get(key).quantity += (item.quantity || 1);
                                } else {
                                    cartMap.set(key, {...item, quantity: item.quantity || 1, styleId: item.styleId || null});
                                }
                            }
                            this.cart = Array.from(cartMap.values());
                        } catch(e) {
                            this.cart = [];
                        }
                    }

                    // Watch cart changes and save to localStorage
                    this.$watch('cart', (value) => {
                        localStorage.setItem('cart', JSON.stringify(value));
                    });

                    // Load notifiedProducts from localStorage
                    const savedNotified = localStorage.getItem('notifiedProducts');
                    if (savedNotified) {
                        try {
                            const arr = JSON.parse(savedNotified);
                            this.notifiedProducts = new Set(arr);
                        } catch(e) {
                            this.notifiedProducts = new Set();
                        }
                    }

                    await this.loadProducts();

                    // Now handle pending product after products loaded
                    if (this.pendingProductId) {
                        const p = this.products.find(pr => pr.id === this.pendingProductId);
                        if (p) {
                            this.selectedProduct = p;
                        }
                        this.pendingProductId = null;
                    }

                    this.initClerk();
                    this.initHistory();
                    this.initializing = false;
                },

                initHistory(){
                    // Handle browser back/forward buttons
                    window.addEventListener('popstate', (e) => {
                        if(e.state){
                            if(e.state.productId){
                                const p = this.products.find(pr => pr.id === e.state.productId);
                                if(p) this.selectedProduct = p;
                                else this.selectedProduct = null;
                            } else {
                                this.selectedProduct = null;
                            }
                            if(e.state.page) this.page = e.state.page;
                        } else {
                            this.selectedProduct = null;
                            this.page = 'home';
                        }
                    });

                    // Set initial history state based on current URL
                    const path = window.location.pathname;
                    if (path.startsWith('/product/') && this.selectedProduct) {
                        history.replaceState({ page: this.page, productId: this.selectedProduct.id }, '', path);
                    } else if (path === '/cart' || path === '/orders' || path === '/checkout') {
                        history.replaceState({ page: this.page }, '', path);
                    } else {
                        history.replaceState({ page: 'home' }, '', '/');
                    }
                },

                navigateToProduct(product){
                    this.selectedProduct = product;
                    history.pushState({ page: this.page, productId: product.id }, '', `/product/${product.id}`);
                },

                closeProduct(){
                    this.selectedProduct = null;
                    history.pushState({ page: this.page }, '', '/');
                },

                navigateToPage(pageName){
                    this.page = pageName;
                    this.selectedProduct = null;
                    const url = pageName === 'home' ? '/' : `/${pageName}`;
                    history.pushState({ page: pageName }, '', url);
                },

                async initClerk(){
                    try {
                        await window.Clerk.load();
                        this.user = window.Clerk.user;
                        if(this.user){
                            await this.syncUser();
                            this.loadOrders();
                        }
                        window.Clerk.addListener(({user})=>{
                            this.user = user;
                            if(user){
                                this.syncUser();
                                this.loadOrders();
                            }
                        });
                    } catch(e){
                        console.log('Clerk not configured');
                    }
                },

                async syncUser(){
                    try {
                        await fetch('/api/auth/sync',{
                            method:'POST',
                            headers:{'Content-Type':'application/json'},
                            body:JSON.stringify({clerk_id:this.user.id})
                        });
                    }catch(e){
                        console.error('Failed to sync user:',e);
                    }
                },

                async signIn(){
                    window.location.href = '/login.html?redirect=' + encodeURIComponent(window.location.pathname);
                },

                async signOut(){
                    if(window.Clerk){
                        await window.Clerk.signOut();
                        this.user = null;
                        this.orders = [];
                        this.showUserMenu = false;
                        this.page = 'home';
                    }
                },

                async subscribeNewsletter(){
                    const email = this.newsletterEmail.toLowerCase().trim();
                    if(!email || this.subscribedEmails.has(email)) return;
                    this.subscribing = true;
                    this.newsletterMessage = '';
                    try {
                        const res = await fetch('/api/newsletter/subscribe', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email: email })
                        });
                        const data = await res.json();
                        this.newsletterSuccess = data.success;
                        this.newsletterMessage = data.message;
                        if(data.success) this.subscribedEmails.add(email);
                    } catch(e) {
                        this.newsletterSuccess = false;
                        this.newsletterMessage = 'Something went wrong. Please try again.';
                    } finally {
                        this.subscribing = false;
                    }
                },

                showNotifyForm(productId){
                    this.notifyProductId = productId;
                    this.notifyEmail = this.user?.emailAddresses?.[0]?.emailAddress || '';
                    this.notifyMessage = '';
                },

                closeNotifyForm(){
                    this.notifyProductId = null;
                    this.notifyEmail = '';
                    this.notifyMessage = '';
                },

                async subscribeProductNotify(productId){
                    const email = this.notifyEmail.toLowerCase().trim();
                    if(!email) return;
                    const key = `${email}:${productId}:`;
                    if(this.notifiedProducts.has(key)) return;
                    this.notifyingProduct = true;
                    this.notifyMessage = '';
                    try {
                        const res = await fetch(`/api/products/${productId}/notify`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email: email })
                        });
                        const data = await res.json();
                        this.notifySuccess = data.success;
                        this.notifyMessage = data.message;
                        if(data.success) {
                            this.notifiedProducts.add(key);
                            localStorage.setItem('notifiedProducts', JSON.stringify([...this.notifiedProducts]));
                            setTimeout(() => this.closeNotifyForm(), 2000);
                        }
                    } catch(e) {
                        this.notifySuccess = false;
                        this.notifyMessage = 'Something went wrong. Please try again.';
                    } finally {
                        this.notifyingProduct = false;
                    }
                },

                async loadProducts(){
                    this.loadingProducts = true;
                    try {
                        const res = await fetch('/api/products');
                        this.products = await res.json();
                    }catch(e){
                        console.error('Failed to load products:',e);
                        this.products = [];
                    }
                    this.loadingProducts = false;
                },

                async loadOrders(){
                    if(!this.user) return;
                    this.loadingOrders = true;
                    try {
                        const token = await window.Clerk.session.getToken();
                        const res = await fetch('/api/orders',{
                            headers:{'Authorization':`Bearer ${token}`}
                        });
                        if(res.ok){
                            this.orders = await res.json();
                        }
                    }catch(e){
                        console.error('Failed to load orders:',e);
                    }
                    this.loadingOrders = false;
                },

                async fetchShippingRates(){
                    this.loadingShippingRates = true;
                    this.shippingRates = [];
                    this.selectedShippingRate = null;
                    try {
                        const items = this.cart.map(p => ({ product_id: p.id, quantity: p.quantity }));
                        const res = await fetch('/api/shipping/rates', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                items: items,
                                destination: this.shipping
                            })
                        });
                        if (res.ok) {
                            const data = await res.json();
                            this.shippingRates = data.rates || [];
                            // Auto-select first rate
                            if (this.shippingRates.length > 0) {
                                this.selectedShippingRate = this.shippingRates[0];
                            }
                            this.step = 3;
                        } else {
                            const err = await res.json();
                            alert(err.error || 'Failed to get shipping rates');
                        }
                    } catch (e) {
                        console.error('Failed to fetch shipping rates:', e);
                        alert('Failed to calculate shipping. Please try again.');
                    }
                    this.loadingShippingRates = false;
                },

                addToCart(product){
                    const existing = this.cart.find(c => c.id === product.id);
                    if(existing){
                        existing.quantity++;
                    } else {
                        this.cart.push({...product, quantity: 1});
                    }
                },

                removeFromCart(productId){
                    const idx = this.cart.findIndex(c => c.id === productId);
                    if(idx !== -1) this.cart.splice(idx, 1);
                },

                async placeOrder(){
                    if(!this.user || this.processingOrder) return;

                    this.processingOrder = true;
                    try {
                        const token = await window.Clerk.session.getToken();
                        const items = this.cart.map(p=>({product_id:p.id,quantity:p.quantity}));

                        const checkoutData = {
                            items,
                            shipping_address: this.shipping
                        };

                        // Include shipping rate details if selected
                        if (this.selectedShippingRate) {
                            checkoutData.shipping_rate_id = this.selectedShippingRate.rate_id;
                            checkoutData.shipping_cents = this.selectedShippingRate.price_cents;
                            checkoutData.shipping_carrier = this.selectedShippingRate.carrier;
                            checkoutData.shipping_service = this.selectedShippingRate.service;
                            checkoutData.estimated_delivery_days = this.selectedShippingRate.estimated_days;
                        }

                        const res = await fetch('/api/checkout',{
                            method:'POST',
                            headers:{
                                'Content-Type':'application/json',
                                'Authorization':`Bearer ${token}`
                            },
                            body:JSON.stringify(checkoutData)
                        });

                        if(res.ok){
                            const data = await res.json();
                            if(data.checkout_url){
                                window.location.href = data.checkout_url;
                            } else {
                                this.cart = [];
                                localStorage.removeItem('cart');
                                this.step = 5;
                                this.orderMessage = 'Your order has been placed!';
                                await this.loadOrders();
                            }
                        } else {
                            const err = await res.json();
                            alert(err.error || 'Failed to place order');
                        }
                    }catch(e){
                        console.error('Failed to place order:',e);
                        alert('Failed to place order. Please try again.');
                    }
                    this.processingOrder = false;
                }
            }
        }

        // Generate pixel stars (squares only) - global for Alpine access
        window.generateStarsIn = function(container, count = 60) {
            if (!container) return;
            container.innerHTML = '';
            const sizes = [2, 4, 6, 8];
            for (let i = 0; i < count; i++) {
                const star = document.createElement('div');
                star.className = 'star' + (Math.random() > 0.6 ? ' twinkle' : '');
                const size = sizes[Math.floor(Math.random() * sizes.length)];
                star.style.width = size + 'px';
                star.style.height = size + 'px';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 2 + 's';
                container.appendChild(star);
            }
        };

        // Generate stars for main page
        window.generateStarsIn(document.getElementById('stars'));

        (function caterpillar(){
            const el=document.getElementById('caterpillar');
            const ctx=el.getContext('2d');
            const bodyColor='#97BAD9';
            const shadowColor='#7BA3C9';
            const legColor='#5a6a7a';

            let posX=100,posY=100,mouseX=0,mouseY=0,velX=0,velY=0;
            let frame=0,idleTime=0,idleAnim=null,idleFrame=0;
            let lastState='',lastFK=-1,facingRight=true,lastTS=0;

            function draw(state,af){
                const fk=~~af%4;
                if(state===lastState&&fk===lastFK)return;
                lastState=state;lastFK=fk;
                ctx.clearRect(0,0,72,40);

                const w=state==='walk',sl=state==='sleep',al=state==='alert';
                const leg=fk%2,wv=w?Math.sin(fk*1.5):0,bob=w?Math.abs(wv)*2:sl?2:0;

                for(let i=0;i<4;i++){
                    const sx=4+i*12+(w?wv*i*.3:0),sy=18+(w?Math.sin(fk*1.5+(3-i))*1.5:0);
                    if(!sl){ctx.fillStyle=legColor;ctx.fillRect(sx+2,sy+6+(leg&&i%2?-1:0),3,4);ctx.fillRect(sx+9,sy+6+(leg&&i%2?0:-1),3,4);}
                    ctx.fillStyle=bodyColor;ctx.fillRect(sx,sy,14,10);
                    ctx.fillStyle=shadowColor;ctx.fillRect(sx,sy,14,2);ctx.fillRect(sx,sy+8,14,2);
                }

                const hx=52,hy=16-bob;
                ctx.fillStyle=legColor;ctx.fillRect(hx+4,hy-6,2,6);ctx.fillRect(hx+10,hy-6,2,6);
                ctx.fillStyle=bodyColor;ctx.beginPath();ctx.arc(hx+5,hy-8,3,0,6.28);ctx.arc(hx+11,hy-8,3,0,6.28);ctx.fill();
                ctx.fillRect(hx,hy,16,12);ctx.fillStyle=shadowColor;ctx.fillRect(hx,hy,16,2);ctx.fillRect(hx,hy+10,16,2);
                if(!sl){ctx.fillStyle=legColor;ctx.fillRect(hx+3,hy+10,3,4);ctx.fillRect(hx+10,hy+10,3,4);}
                ctx.fillStyle='#1a1a1a';
                if(sl){ctx.fillRect(hx+3,hy+4,4,2);ctx.fillRect(hx+9,hy+4,4,2);ctx.font='8px sans-serif';ctx.fillText('z',hx+18,hy-2+(fk%2?0:-2));}
                else if(al){ctx.fillRect(hx+3,hy+3,5,5);ctx.fillRect(hx+9,hy+3,5,5);}
                else{ctx.fillRect(hx+4,hy+3,3,4);ctx.fillRect(hx+10,hy+3,3,4);}
            }

            document.addEventListener('mousemove',e=>{mouseX=e.clientX;mouseY=e.clientY});

            function update(ts){
                const dt=lastTS?(ts-lastTS)/1000:.016;lastTS=ts;frame+=dt*8;
                const dx=mouseX-posX,dy=mouseY-posY,dist=Math.sqrt(dx*dx+dy*dy);

                if(dist<48){
                    velX*=.9;velY*=.9;idleTime+=dt;
                    if(idleTime>8&&!idleAnim&&Math.random()<.005){idleAnim='sleep';idleFrame=0;}
                    if(idleAnim==='sleep'){idleFrame+=dt*4;draw('sleep',idleFrame);if(idleFrame>80)idleAnim=null;}
                    else draw('idle',frame);
                }else if(idleTime>.05){
                    draw('alert',0);idleTime=Math.max(0,idleTime-dt*8);
                }else{
                    idleAnim=null;
                    velX+=(dx/dist*150-velX)*.12;velY+=(dy/dist*150-velY)*.12;
                    posX+=velX*dt;posY+=velY*dt;
                    posX=Math.max(36,Math.min(posX,innerWidth-36));
                    posY=Math.max(20,Math.min(posY,innerHeight-20));
                    if(Math.abs(velX)>5)facingRight=velX>0;
                    draw('walk',frame);
                }
                el.style.transform=`translate3d(${posX-36}px,${posY-20}px,0)scaleX(${facingRight?1:-1})`;
                requestAnimationFrame(update);
            }
            draw('idle',0);requestAnimationFrame(update);
        })();
    </script>
</body>
</html>
