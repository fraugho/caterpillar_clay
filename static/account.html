<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Settings - Caterpillar Clay</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preload" href="https://fonts.gstatic.com/s/pressstart2p/v15/e3t4euO8T-267oIAQAu6jDQyK3nVivM.woff2" as="font" type="font/woff2" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=block" rel="stylesheet">
    <!-- Clerk -->
    <script async crossorigin="anonymous" data-clerk-publishable-key="pk_test_Y2FyaW5nLWpheWJpcmQtODYuY2xlcmsuYWNjb3VudHMuZGV2JA" src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js" type="text/javascript"></script>
    <style>
        :root{
            --bg-primary:#F8F8F8;
            --bg-secondary:#FFFFFF;
            --bg-card:#FFFFFF;
            --text-primary:#18191B;
            --text-secondary:#666666;
            --accent:#97BAD9;
            --accent-hover:#7BA3C9;
            --border:#E0E0E0;
        }
        @media(prefers-color-scheme:dark){
            :root{
                --bg-primary:#18191B;
                --bg-secondary:#1E2022;
                --bg-card:#252729;
                --text-primary:#F8F8F8;
                --text-secondary:#A0A0A0;
                --accent:#97BAD9;
                --accent-hover:#AECCE8;
                --border:#333537;
            }
        }
        *{margin:0;padding:0;box-sizing:border-box;image-rendering:pixelated}
        body{font-family:'Press Start 2P',cursive;background:var(--bg-primary);color:var(--text-primary);min-height:100vh;display:flex;flex-direction:column}
        #caterpillar{position:fixed;pointer-events:none;z-index:9999;will-change:transform;left:0;top:0;contain:strict}
        .stars{position:fixed;inset:0;pointer-events:none;z-index:0;overflow:hidden;contain:strict}
        .star{position:absolute;background:var(--accent);opacity:0.4;contain:strict}
        .star.twinkle{animation:twinkle 2s ease-in-out infinite;will-change:opacity}
        @keyframes twinkle{0%,100%{opacity:0.2}50%{opacity:0.6}}
        nav{display:flex;align-items:center}
        @media(max-width:768px){
            .nav-title{font-size:10px !important}
            .container{padding:20px 12px}
            .account-card{padding:16px}
            /* Clerk root and cards - no scroll, grow to fit */
            .cl-rootBox{font-size:6px !important;max-width:100% !important;overflow:visible !important}
            .cl-card{padding:12px !important;max-width:100% !important;overflow:visible !important;height:auto !important;max-height:none !important}
            .cl-cardBox{padding:0 !important;max-width:100% !important;overflow:visible !important;height:auto !important;max-height:none !important}
            .cl-userProfile-root{max-width:100% !important;overflow:visible !important;height:auto !important;max-height:none !important}
            .cl-pageScrollBox{max-width:100% !important;overflow:visible !important;height:auto !important;max-height:none !important}
            .cl-scrollBox{max-width:100% !important;overflow:visible !important;height:auto !important;max-height:none !important}
            .cl-modalContent{overflow:visible !important;height:auto !important;max-height:none !important}
            .cl-formContainer{overflow:visible !important;height:auto !important}
            .cl-main{overflow:visible !important;height:auto !important}
            .account-card{overflow-x:hidden !important}
            /* Headers */
            .cl-headerTitle{font-size:9px !important}
            .cl-headerSubtitle{font-size:5px !important}
            /* All buttons */
            .cl-button{font-size:6px !important;padding:8px 10px !important}
            .cl-formButtonPrimary{font-size:9px !important;padding:12px 14px !important}
            .cl-formButtonReset{font-size:6px !important}
            .cl-profileSectionPrimaryButton{font-size:9px !important;padding:10px 14px !important}
            /* Form elements */
            .cl-formFieldInput{font-size:6px !important;padding:8px !important;min-height:36px !important}
            .cl-formFieldLabel{font-size:6px !important}
            .cl-formFieldHintText{font-size:5px !important}
            /* Profile sections - larger titles */
            .cl-profileSectionTitle{font-size:9px !important}
            .cl-profileSectionTitleText{font-size:9px !important}
            .cl-profileSectionContent{font-size:6px !important}
            .cl-profileSectionItem,.cl-activeDeviceListItem,.cl-activeDevice{padding:8px !important;margin-bottom:6px !important}
            /* Navbar */
            .cl-navbar{padding:8px !important}
            .cl-navbarButton{font-size:6px !important;padding:6px !important}
            /* Accordion and other elements */
            .cl-accordionTriggerButton{font-size:6px !important}
            .cl-accordionContent{font-size:6px !important}
            .cl-badge{font-size:4px !important;padding:2px 4px !important}
            /* User preview - hide name, keep avatar */
            .cl-userPreview{font-size:6px !important}
            .cl-userPreviewMainIdentifier{display:none !important}
            .cl-userPreviewSecondaryIdentifier{font-size:5px !important}
            .cl-userPreviewTextContainer{display:none !important}
            /* Connect account - wrap text */
            .cl-socialButtonsBlockButton{font-size:6px !important;padding:8px !important;white-space:normal !important;word-wrap:break-word !important;height:auto !important;min-height:auto !important;flex-wrap:wrap !important}
            .cl-socialButtonsBlockButtonText{font-size:6px !important;white-space:normal !important;overflow-wrap:break-word !important;word-break:break-word !important}
            .cl-socialButtonsBlockButton span{white-space:normal !important;word-break:break-word !important}
            .cl-socialButtonsBlockButton *{white-space:normal !important}
            [class*="socialButtonsBlockButton"]{white-space:normal !important;height:auto !important}
            [class*="socialButtonsBlockButton"] *{white-space:normal !important}
            /* Connected accounts section button */
            .cl-profileSection__connectedAccounts button{white-space:normal !important;height:auto !important;word-break:break-word !important}
            .cl-profileSection__connectedAccounts button span{white-space:normal !important}
            .cl-profileSection__connectedAccounts .cl-profileSectionPrimaryButton{white-space:normal !important;height:auto !important}
            [class*="connectedAccounts"] button{white-space:normal !important;height:auto !important;line-height:1.4 !important}
            [class*="connectedAccounts"] button *{white-space:normal !important}
            /* Add email address - wrap text */
            .cl-profileSectionPrimaryButton{white-space:normal !important;word-wrap:break-word !important;line-height:1.4 !important;height:auto !important;min-height:auto !important}
            .cl-profileSectionPrimaryButton span{white-space:normal !important}
            .cl-button{white-space:normal !important;height:auto !important}
            /* Avatar */
            .cl-avatarBox{width:48px !important;height:48px !important}
            .cl-userButtonAvatarBox{width:32px !important;height:32px !important}
            /* Page content */
            .cl-pageScrollBox{padding:12px !important}
            .cl-page{gap:12px !important}
            /* Menus and actions */
            .cl-menuButton{font-size:6px !important}
            .cl-menuItem{font-size:6px !important}
            .cl-actionCard{padding:10px !important}
            /* Development mode - centered */
            .cl-internal-b3fm6y,.cl-developmentMode,[class*="developmentMode"]{text-align:center !important;width:100% !important;display:flex !important;justify-content:center !important}
            .cl-footer{text-align:center !important;display:flex !important;justify-content:center !important;width:100% !important}
            .cl-footerAction{text-align:center !important;justify-content:center !important}
            .cl-footerPages{text-align:center !important;justify-content:center !important;width:100% !important}
            .cl-footerPagesLink{text-align:center !important}
            [class*="footer"]{text-align:center !important}
            .cl-userProfile-root .cl-footer,.cl-card .cl-footer{justify-content:center !important}
            /* Delete section - centered */
            #delete-section{text-align:center}
            #delete-section h3{font-size:10px}
            #delete-section p{font-size:6px}
            #delete-section button{font-size:6px;padding:10px 14px}
            /* Update profile closer to avatar */
            .cl-profileSection__profile .cl-profileSectionContent{gap:8px !important}
            .cl-profileSection__profile{gap:8px !important}
            /* Account text in navbar larger */
            .cl-navbarMobileMenuButton{font-size:8px !important}
            .cl-userButtonTrigger{font-size:8px !important}
            .cl-organizationSwitcherTrigger{font-size:8px !important}
            .cl-navbarButton__account,.cl-navbarButton[data-localization-key*="account"]{font-size:8px !important}
            #confirm-modal h3{font-size:10px}
            #confirm-modal p{font-size:6px}
            #confirm-modal button{font-size:6px;padding:10px 14px}
        }
        .container{flex:1;display:flex;align-items:flex-start;justify-content:center;padding:40px 20px;position:relative;z-index:10}
        .account-card{background:var(--bg-card);border:2px solid var(--border);border-radius:12px;padding:40px;max-width:800px;width:100%}
        #clerk-profile{display:flex;justify-content:center}

        /* Override Clerk styles to match theme */
        .cl-rootBox{
            --clerk-font-family:'Press Start 2P',cursive;
            width:100% !important;
        }
        .cl-card{
            background:var(--bg-card) !important;
            border:none !important;
            box-shadow:none !important;
        }
        .cl-headerTitle{
            font-family:'Press Start 2P',cursive !important;
            color:var(--text-primary) !important;
            font-size:12px !important;
        }
        .cl-headerSubtitle{
            font-family:'Press Start 2P',cursive !important;
            font-size:8px !important;
            color:var(--text-secondary) !important;
        }
        .cl-formButtonPrimary{
            background:var(--accent) !important;
            font-family:'Press Start 2P',cursive !important;
            font-size:8px !important;
            border-radius:8px !important;
        }
        .cl-formButtonPrimary:hover{
            background:var(--accent-hover) !important;
        }
        .cl-formFieldInput{
            background:var(--bg-secondary) !important;
            border:2px solid var(--border) !important;
            color:var(--text-primary) !important;
            font-family:'Press Start 2P',cursive !important;
            font-size:8px !important;
        }
        .cl-formFieldLabel{
            color:var(--text-primary) !important;
            font-family:'Press Start 2P',cursive !important;
            font-size:8px !important;
        }
        .cl-profileSectionTitle{
            font-family:'Press Start 2P',cursive !important;
            font-size:10px !important;
            color:var(--text-primary) !important;
        }
        .cl-profileSectionContent{
            font-family:'Press Start 2P',cursive !important;
            font-size:8px !important;
        }
        .cl-userButtonPopoverActionButton{
            font-family:'Press Start 2P',cursive !important;
            font-size:8px !important;
        }
        .cl-navbar{
            background:var(--bg-secondary) !important;
            border-right:2px solid var(--border) !important;
        }
        .cl-navbarButton{
            font-family:'Press Start 2P',cursive !important;
            font-size:8px !important;
            color:var(--text-primary) !important;
        }
        .cl-navbarButton:hover, .cl-navbarButton[data-active="true"]{
            background:var(--accent) !important;
            color:#18191B !important;
        }
        .cl-pageScrollBox{
            background:var(--bg-card) !important;
        }
        .cl-profilePage{
            background:var(--bg-card) !important;
        }
        .cl-accordionTriggerButton{
            font-family:'Press Start 2P',cursive !important;
            font-size:8px !important;
        }
        .cl-formButtonReset{
            font-family:'Press Start 2P',cursive !important;
            font-size:8px !important;
            color:var(--accent) !important;
        }
        .cl-badge{
            font-family:'Press Start 2P',cursive !important;
            font-size:6px !important;
            background:#22c55e !important;
            color:#fff !important;
            padding:4px 8px !important;
            border-radius:4px !important;
        }
        .cl-badge[data-localization-key*="primary"],
        .cl-badge__primary{
            background:#22c55e !important;
            color:#fff !important;
        }
        .cl-badge[data-localization-key*="thisDevice"],
        .cl-badge__thisDevice{
            background:#8b5cf6 !important;
            color:#fff !important;
        }
        /* Make section items more visible */
        .cl-profileSectionItem,
        .cl-activeDeviceListItem,
        .cl-activeDevice{
            background:var(--bg-secondary) !important;
            border:2px solid var(--border) !important;
            border-radius:8px !important;
            padding:12px !important;
            margin-bottom:8px !important;
        }
        .cl-profileSectionItemList{
            gap:8px !important;
        }
        .cl-profileSectionContent__emailAddresses,
        .cl-profileSectionContent__activeDevices{
            background:transparent !important;
        }
        .cl-userPreview,
        .cl-deviceInfo{
            color:var(--text-primary) !important;
        }
        .cl-userPreviewSecondaryIdentifier,
        .cl-activeDeviceLabel{
            color:var(--text-secondary) !important;
        }
        /* Hide Clerk's built-in delete account section */
        .cl-profileSection__danger,
        .cl-profileSection__deleteAccount,
        [data-localization-key="userProfile.start.dangerSection.title"],
        .cl-profileSectionPrimaryButton__danger{
            display:none !important;
        }
    </style>
</head>
<body x-data="{cart: JSON.parse(localStorage.getItem('cart') || '[]'), get cartItemCount() { return this.cart.reduce((a,b) => a + (b.quantity || 1), 0); }}">
    <div class="stars" id="stars"></div>
    <canvas id="caterpillar" width="72" height="40"></canvas>

    <nav style="background:var(--accent);position:relative;z-index:1001;height:60px;padding:0 12px">
        <div style="width:100%;max-width:900px;margin:auto;display:flex;justify-content:space-between;align-items:center;color:#fff;height:100%">
            <a href="/about.html" style="color:#fff;text-decoration:none;font-size:8px">ABOUT ME</a>
            <a href="/" class="nav-title" style="font-size:14px;color:#fff;text-decoration:none;text-align:center">CATERPILLAR CLAY</a>
            <a href="/" style="color:#fff;text-decoration:none;font-size:8px">CART (<span x-text="cartItemCount">0</span>)</a>
        </div>
    </nav>

    <div class="container">
        <div class="account-card">
            <div id="clerk-profile"></div>

            <!-- Custom Delete Account Section -->
            <div id="delete-section" style="display:none;margin-top:32px;padding-top:32px;border-top:2px solid var(--border)">
                <h3 style="font-size:12px;margin-bottom:16px;color:#dc2626">Delete Account</h3>
                <p style="font-size:8px;color:var(--text-secondary);margin-bottom:16px;line-height:1.8">
                    Permanently delete your account and all associated data. This action cannot be undone.
                </p>
                <button id="delete-btn" style="background:#dc2626;color:#fff;padding:14px 20px;font-family:inherit;font-size:8px;border:none;cursor:pointer;border-radius:8px">
                    DELETE MY ACCOUNT
                </button>
            </div>

            <!-- Confirmation Modal -->
            <div id="confirm-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:1000;align-items:center;justify-content:center">
                <div style="background:var(--bg-card);border:2px solid var(--border);border-radius:12px;padding:32px;max-width:400px;text-align:center">
                    <h3 style="font-size:12px;margin-bottom:16px;color:#dc2626">Are you sure?</h3>
                    <p style="font-size:8px;color:var(--text-secondary);margin-bottom:24px;line-height:1.8">
                        This will permanently delete your account, order history, and all data. This cannot be undone.
                    </p>
                    <div style="display:flex;gap:12px;justify-content:center">
                        <button id="cancel-btn" style="background:var(--accent);color:#18191B;padding:14px 20px;font-family:inherit;font-size:8px;border:none;cursor:pointer;border-radius:8px">
                            CANCEL
                        </button>
                        <button id="confirm-delete-btn" style="background:#dc2626;color:#fff;padding:14px 20px;font-family:inherit;font-size:8px;border:none;cursor:pointer;border-radius:8px">
                            YES, DELETE
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Generate pixel stars
        (function generateStars(){
            const container=document.getElementById('stars');
            const sizes=[2,3,4,6,8];
            for(let i=0;i<60;i++){
                const star=document.createElement('div');
                star.className='star'+(Math.random()>0.8?' twinkle':'');
                const size=sizes[Math.floor(Math.random()*sizes.length)];
                star.style.width=size+'px';
                star.style.height=size+'px';
                star.style.left=Math.random()*100+'%';
                star.style.top=Math.random()*100+'%';
                star.style.animationDelay=Math.random()*2+'s';
                container.appendChild(star);
            }
        })();

        // Initialize Clerk user profile
        window.addEventListener('load', async () => {
            try {
                await window.Clerk.load();

                // If not signed in, redirect to login
                if (!window.Clerk.user) {
                    window.location.href = '/login.html?redirect=/account.html';
                    return;
                }

                const profileDiv = document.getElementById('clerk-profile');
                const styles = getComputedStyle(document.documentElement);
                const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

                window.Clerk.mountUserProfile(profileDiv, {
                    appearance: {
                        variables: {
                            colorPrimary: '#97BAD9',
                            colorDanger: '#dc2626',
                            colorText: styles.getPropertyValue('--text-primary').trim(),
                            colorTextSecondary: styles.getPropertyValue('--text-secondary').trim(),
                            colorBackground: styles.getPropertyValue('--bg-card').trim(),
                            colorInputBackground: styles.getPropertyValue('--bg-secondary').trim(),
                            colorInputText: styles.getPropertyValue('--text-primary').trim(),
                            borderRadius: '8px',
                        },
                        elements: {
                            card: {
                                backgroundColor: isDark ? '#252729' : '#FFFFFF',
                                border: 'none',
                                boxShadow: 'none'
                            },
                            navbar: {
                                backgroundColor: isDark ? '#1E2022' : '#FFFFFF',
                                borderRight: '2px solid ' + (isDark ? '#333537' : '#E0E0E0')
                            },
                            navbarButton: {
                                '&:hover': { backgroundColor: '#97BAD9', color: '#18191B' },
                                '&[data-active="true"]': { backgroundColor: '#97BAD9', color: '#18191B' }
                            }
                        }
                    }
                });

                // Show delete section
                document.getElementById('delete-section').style.display = 'block';

                // Delete account handlers
                const modal = document.getElementById('confirm-modal');

                document.getElementById('delete-btn').addEventListener('click', () => {
                    modal.style.display = 'flex';
                });

                document.getElementById('cancel-btn').addEventListener('click', () => {
                    modal.style.display = 'none';
                });

                document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
                    try {
                        document.getElementById('confirm-delete-btn').textContent = 'DELETING...';
                        document.getElementById('confirm-delete-btn').disabled = true;

                        await window.Clerk.user.delete();
                        window.location.href = '/?deleted=1';
                    } catch(e) {
                        console.error('Failed to delete account:', e);
                        alert('Failed to delete account. Please try again.');
                        modal.style.display = 'none';
                        document.getElementById('confirm-delete-btn').textContent = 'YES, DELETE';
                        document.getElementById('confirm-delete-btn').disabled = false;
                    }
                });

            } catch(e) {
                console.error('Failed to load Clerk:', e);
                document.getElementById('clerk-profile').innerHTML = '<p style="color:var(--text-secondary);font-size:8px">Account service unavailable</p>';
            }
        });

    </script>
    <script src="/scripts/caterpillar.js"></script>
</body>
</html>
