<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caterpillar Clay - Admin</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root{
            --bg-primary:#F8F8F8;
            --bg-secondary:#FFFFFF;
            --bg-card:#FFFFFF;
            --text-primary:#18191B;
            --text-secondary:#666666;
            --accent:#97BAD9;
            --accent-hover:#7BA3C9;
            --border:#E0E0E0;
        }
        @media(prefers-color-scheme:dark){
            :root{
                --bg-primary:#18191B;
                --bg-secondary:#1E2022;
                --bg-card:#252729;
                --text-primary:#F8F8F8;
                --text-secondary:#A0A0A0;
                --accent:#97BAD9;
                --accent-hover:#AECCE8;
                --border:#333537;
            }
        }
        *{margin:0;padding:0;box-sizing:border-box;image-rendering:pixelated}
        body{font-family:'Press Start 2P',cursive;background:var(--bg-primary);color:var(--text-primary);min-height:100vh;position:relative}
        .stars{position:fixed;inset:0;pointer-events:none;z-index:0;overflow:hidden}
        .star{position:absolute;background:var(--accent);opacity:0.3}
        .star.twinkle{animation:twinkle 2s ease-in-out infinite}
        @keyframes twinkle{0%,100%{opacity:0.15}50%{opacity:0.4}}
        .container{max-width:1200px;margin:0 auto;padding:20px;position:relative;z-index:1}
        nav{background:var(--accent);padding:20px;margin-bottom:20px;position:relative;z-index:1}
        nav .inner{max-width:1200px;margin:0 auto;display:flex;justify-content:space-between;align-items:center}
        nav h1{font-size:14px;color:#18191B}
        .tabs{display:flex;gap:8px;margin-bottom:20px}
        .tab{background:var(--bg-card);color:var(--text-secondary);padding:12px 16px;font-family:inherit;font-size:8px;border:2px solid var(--border);border-radius:8px;cursor:pointer}
        .tab.active{background:var(--accent);color:#18191B;border-color:var(--accent)}
        .tab:hover{border-color:var(--accent)}
        .card{background:var(--bg-card);padding:20px;margin-bottom:20px;border:2px solid var(--border);border-radius:12px}
        .card h2{font-size:12px;margin-bottom:16px;color:var(--accent)}
        .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:20px}
        .stat{background:var(--bg-card);padding:16px;text-align:center;border:2px solid var(--border);border-radius:12px}
        .stat-value{font-size:18px;color:var(--accent);margin-bottom:8px}
        .stat-label{font-size:8px;color:var(--text-secondary)}
        table{width:100%;border-collapse:collapse;font-size:8px}
        th,td{padding:12px;text-align:left;border-bottom:1px solid var(--border)}
        th{color:var(--accent)}
        .btn{background:var(--accent);color:#18191B;padding:10px 14px;font-family:inherit;font-size:8px;border:none;cursor:pointer;border-radius:8px;transition:background .2s}
        .btn:hover{background:var(--accent-hover)}
        .btn-danger{background:#dc2626;color:#fff}
        .btn-danger:hover{background:#b91c1c}
        .btn-success{background:#16a34a;color:#fff}
        .btn-sm{padding:6px 10px;font-size:6px;border-radius:6px}
        input,textarea,select{width:100%;padding:10px;font-family:inherit;font-size:8px;margin-bottom:12px;background:var(--bg-secondary);color:var(--text-primary);border:2px solid var(--border);border-radius:8px}
        input:focus,textarea:focus,select:focus{outline:none;border-color:var(--accent)}
        .form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
        label{display:block;font-size:8px;margin-bottom:4px;color:var(--text-secondary)}
        .status{padding:4px 8px;font-size:6px;border-radius:6px}
        .status-pending{background:#eab308;color:#000}
        .status-paid{background:#22c55e;color:#000}
        .status-processing{background:#3b82f6;color:#fff}
        .status-shipped{background:#8b5cf6;color:#fff}
        .status-delivered{background:#10b981;color:#fff}
        .status-cancelled{background:#ef4444;color:#fff}
        .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;align-items:center;justify-content:center}
        .modal.active{display:flex}
        .modal-content{background:var(--bg-card);padding:24px;max-width:900px;width:90%;max-height:90vh;overflow-y:auto;border-radius:12px;border:2px solid var(--border)}
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
        .modal-header h3{font-size:10px;color:var(--accent)}
        .close-btn{background:none;border:none;color:var(--text-secondary);font-size:16px;cursor:pointer}
        .product-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:32px}
        .product-card{background:var(--bg-card);padding:20px;border:2px solid var(--border);border-radius:12px;text-align:center;transition:transform .2s,box-shadow .2s}
        .product-card:hover{transform:translateY(-4px);box-shadow:0 8px 24px rgba(0,0,0,0.1)}
        .product-card img,.product-card .placeholder-img{width:100%;height:380px;object-fit:cover;background:var(--bg-secondary);margin-bottom:12px;border:2px solid var(--border);border-radius:8px}
        .product-card .placeholder-img{display:flex;align-items:center;justify-content:center;font-size:10px;color:var(--text-secondary)}
        .product-card h4{font-size:10px;margin-bottom:10px}
        .product-card .price{color:var(--accent);font-size:12px;margin-bottom:10px}
        .product-card .stock{font-size:8px;color:var(--text-secondary);margin-bottom:14px}
        .product-actions{display:flex;gap:8px;margin-top:12px;justify-content:center}
        .alert{padding:12px;margin-bottom:16px;font-size:8px;border-radius:8px}
        .alert-warning{background:#fef3c7;color:#92400e}
        .alert-success{background:#d1fae5;color:#065f46}
        .toggle{position:relative;display:inline-block;width:40px;height:20px}
        .toggle input{opacity:0;width:0;height:0}
        .toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:var(--border);transition:.3s;border-radius:10px}
        .toggle-slider:before{position:absolute;content:"";height:14px;width:14px;left:3px;bottom:3px;background:var(--text-secondary);transition:.3s;border-radius:50%}
        .toggle input:checked+.toggle-slider{background:#22c55e}
        .toggle input:checked+.toggle-slider:before{transform:translateX(20px);background:#fff}
        .preview-section{display:grid;grid-template-columns:1fr 1fr;gap:24px}
        .form-section,.preview-card{padding:20px}
        .preview-card{background:var(--bg-secondary);border:2px solid var(--border);border-radius:12px;text-align:center}
        .preview-card h4{font-size:10px;margin-bottom:10px}
        .preview-card .price{color:var(--accent);font-size:12px;margin-bottom:10px}
        .preview-card .stock{font-size:8px;color:var(--text-secondary);margin-bottom:14px}
        .preview-card img,.preview-card .preview-placeholder{width:100%;height:300px;object-fit:cover;background:var(--bg-primary);border:2px solid var(--border);border-radius:8px;margin-bottom:12px}
        .preview-card .preview-placeholder{display:flex;align-items:center;justify-content:center;font-size:10px;color:var(--text-secondary)}
        .preview-btn{background:var(--accent);color:#18191B;padding:14px 20px;font-family:inherit;font-size:8px;border:none;border-radius:8px;width:100%}
        .image-upload{border:2px dashed var(--border);border-radius:8px;padding:20px;text-align:center;cursor:pointer;transition:border-color .2s}
        .image-upload:hover{border-color:var(--accent)}
        .image-upload input{display:none}
        .image-upload img{max-width:100%;max-height:200px;margin-top:12px;border-radius:8px}
        @media(max-width:768px){.preview-section{grid-template-columns:1fr}}
    </style>
</head>
<body x-data="admin()">
    <div class="stars" id="stars"></div>

    <nav>
        <div class="inner">
            <h1>CATERPILLAR CLAY ADMIN</h1>
            <button class="btn btn-sm" @click="logout()">LOGOUT</button>
        </div>
    </nav>

    <div class="container">
        <div class="tabs">
            <button class="tab" :class="{ active: tab === 'dashboard' }" @click="tab = 'dashboard'">DASHBOARD</button>
            <button class="tab" :class="{ active: tab === 'products' }" @click="tab = 'products'; loadProducts()">PRODUCTS</button>
            <button class="tab" :class="{ active: tab === 'orders' }" @click="tab = 'orders'; loadOrders()">ORDERS</button>
        </div>

        <!-- Dashboard -->
        <template x-if="tab === 'dashboard'">
            <div>
                <div class="stats">
                    <div class="stat">
                        <div class="stat-value" x-text="dashboard.total_orders || 0"></div>
                        <div class="stat-label">TOTAL ORDERS</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">$<span x-text="(dashboard.total_revenue || 0).toFixed(2)"></span></div>
                        <div class="stat-label">TOTAL REVENUE</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" x-text="dashboard.total_products || 0"></div>
                        <div class="stat-label">PRODUCTS</div>
                    </div>
                </div>

                <template x-if="dashboard.low_stock_products && dashboard.low_stock_products.length">
                    <div class="card">
                        <h2>LOW STOCK ALERTS</h2>
                        <template x-for="p in dashboard.low_stock_products" :key="p.id">
                            <div class="alert alert-warning">
                                <span x-text="p.name"></span> - Only <span x-text="p.stock_quantity"></span> left
                            </div>
                        </template>
                    </div>
                </template>

                <div class="card">
                    <h2>RECENT ORDERS</h2>
                    <table>
                        <thead>
                            <tr><th>ID</th><th>STATUS</th><th>TOTAL</th><th>DATE</th></tr>
                        </thead>
                        <tbody>
                            <template x-for="o in dashboard.recent_orders || []" :key="o.id">
                                <tr>
                                    <td x-text="o.id.substring(0,8)"></td>
                                    <td><span class="status" :class="'status-' + o.status" x-text="o.status.toUpperCase()"></span></td>
                                    <td>$<span x-text="o.total.toFixed(2)"></span></td>
                                    <td x-text="new Date(o.created_at).toLocaleDateString()"></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </template>

        <!-- Products -->
        <template x-if="tab === 'products'">
            <div>
                <div style="margin-bottom: 16px;">
                    <button class="btn" @click="openProductModal()">+ ADD PRODUCT</button>
                </div>

                <div class="product-grid">
                    <template x-for="p in products" :key="p.id">
                        <div class="product-card">
                            <template x-if="p.image_url">
                                <img :src="p.image_url" :alt="p.name">
                            </template>
                            <template x-if="!p.image_url">
                                <div class="placeholder-img">[NO IMAGE]</div>
                            </template>
                            <h4 x-text="p.name"></h4>
                            <div class="price">$<span x-text="p.price.toFixed(2)"></span></div>
                            <div class="stock" x-text="p.stock_quantity > 0 ? 'In Stock (' + p.stock_quantity + ')' : 'Out of Stock'"></div>
                            <div style="margin-top: 8px;">
                                <label class="toggle">
                                    <input type="checkbox" :checked="p.is_active" @change="toggleProductActive(p)">
                                    <span class="toggle-slider"></span>
                                </label>
                                <span style="font-size: 6px; margin-left: 4px;" x-text="p.is_active ? 'Active' : 'Inactive'"></span>
                            </div>
                            <div class="product-actions">
                                <button class="btn btn-sm" @click="editProduct(p)">EDIT</button>
                                <button class="btn btn-sm btn-danger" @click="deleteProduct(p.id)">DELETE</button>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </template>

        <!-- Orders -->
        <template x-if="tab === 'orders'">
            <div class="card">
                <h2>ALL ORDERS</h2>
                <table>
                    <thead>
                        <tr><th>ID</th><th>CUSTOMER</th><th>STATUS</th><th>TOTAL</th><th>DATE</th><th>ACTIONS</th></tr>
                    </thead>
                    <tbody>
                        <template x-for="o in orders" :key="o.id">
                            <tr>
                                <td x-text="o.id.substring(0, 8)"></td>
                                <td x-text="o.user ? o.user.email : 'Guest'"></td>
                                <td>
                                    <select class="btn btn-sm" :value="o.status" @change="updateOrderStatus(o.id, $event.target.value)" style="width: auto;">
                                        <option value="pending">Pending</option>
                                        <option value="paid">Paid</option>
                                        <option value="processing">Processing</option>
                                        <option value="shipped">Shipped</option>
                                        <option value="delivered">Delivered</option>
                                        <option value="cancelled">Cancelled</option>
                                    </select>
                                </td>
                                <td>$<span x-text="o.total.toFixed(2)"></span></td>
                                <td x-text="new Date(o.created_at).toLocaleDateString()"></td>
                                <td>
                                    <button class="btn btn-sm" @click="viewOrder(o)">VIEW</button>
                                    <template x-if="!o.tracking_number && o.status !== 'pending'">
                                        <button class="btn btn-sm btn-success" @click="openTrackingModal(o)">ADD TRACKING</button>
                                    </template>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </template>
    </div>

    <!-- Product Modal -->
    <div class="modal" :class="{ active: showProductModal }">
        <div class="modal-content">
            <div class="modal-header">
                <h3 x-text="editingProduct ? 'EDIT PRODUCT' : 'ADD PRODUCT'"></h3>
                <button class="close-btn" @click="showProductModal = false">&times;</button>
            </div>
            <div class="preview-section">
                <div class="form-section">
                    <form @submit.prevent="saveProduct()">
                        <label>Product Image</label>
                        <div class="image-upload" @click="$refs.imageInput.click()">
                            <input type="file" x-ref="imageInput" @change="handleImageSelect($event)" accept="image/*">
                            <template x-if="!previewImage">
                                <p style="font-size:8px;color:var(--text-secondary)">Click to upload image</p>
                            </template>
                            <template x-if="previewImage">
                                <img :src="previewImage" alt="Preview">
                            </template>
                        </div>

                        <label>Name</label>
                        <input type="text" x-model="productForm.name" required>

                        <label>Description</label>
                        <textarea x-model="productForm.description" rows="3"></textarea>

                        <div class="form-row">
                            <div>
                                <label>Price ($)</label>
                                <input type="number" step="0.01" x-model="productForm.price" required>
                            </div>
                            <div>
                                <label>Stock</label>
                                <input type="number" x-model="productForm.stock_quantity">
                            </div>
                        </div>

                        <button type="submit" class="btn" style="width: 100%; margin-top: 8px;">SAVE PRODUCT</button>
                    </form>
                </div>
                <div class="preview-card">
                    <p style="font-size:8px;color:var(--text-secondary);margin-bottom:12px">LISTING PREVIEW</p>
                    <template x-if="previewImage">
                        <img :src="previewImage" alt="Preview">
                    </template>
                    <template x-if="!previewImage">
                        <div class="preview-placeholder">[IMAGE]</div>
                    </template>
                    <h4 x-text="productForm.name || 'Product Name'"></h4>
                    <div class="price">$<span x-text="(parseFloat(productForm.price) || 0).toFixed(2)"></span></div>
                    <div class="stock" x-text="productForm.stock_quantity > 0 ? 'In Stock' : 'Out of Stock'"></div>
                    <button class="preview-btn" disabled>ADD TO CART</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Detail Modal -->
    <div class="modal" :class="{ active: showOrderModal }">
        <div class="modal-content" style="max-width:500px">
            <div class="modal-header">
                <h3>ORDER DETAILS</h3>
                <button class="close-btn" @click="showOrderModal = false">&times;</button>
            </div>
            <template x-if="selectedOrder">
                <div>
                    <p style="font-size: 8px; margin-bottom: 8px;"><strong>ID:</strong> <span x-text="selectedOrder.id"></span></p>
                    <p style="font-size: 8px; margin-bottom: 8px;"><strong>Status:</strong> <span x-text="selectedOrder.status"></span></p>
                    <p style="font-size: 8px; margin-bottom: 8px;"><strong>Total:</strong> $<span x-text="selectedOrder.total.toFixed(2)"></span></p>

                    <template x-if="selectedOrder.shipping_address">
                        <div style="margin-bottom: 12px;">
                            <p style="font-size: 8px; color: var(--accent); margin-bottom: 4px;">SHIPPING ADDRESS</p>
                            <p style="font-size: 8px;" x-text="selectedOrder.shipping_address.name"></p>
                            <p style="font-size: 8px;" x-text="selectedOrder.shipping_address.street"></p>
                            <p style="font-size: 8px;" x-text="`${selectedOrder.shipping_address.city}, ${selectedOrder.shipping_address.state} ${selectedOrder.shipping_address.zip}`"></p>
                        </div>
                    </template>

                    <template x-if="selectedOrder.tracking_number">
                        <p style="font-size: 8px; margin-bottom: 8px;"><strong>Tracking:</strong> <span x-text="selectedOrder.tracking_number"></span></p>
                    </template>

                    <p style="font-size: 8px; color: var(--accent); margin: 12px 0 4px;">ITEMS</p>
                    <template x-for="item in selectedOrder.items" :key="item.product_id">
                        <p style="font-size: 8px; margin-bottom: 4px;">
                            <span x-text="item.product_name"></span> x<span x-text="item.quantity"></span> - $<span x-text="(item.price_cents / 100).toFixed(2)"></span>
                        </p>
                    </template>
                </div>
            </template>
        </div>
    </div>

    <!-- Tracking Modal -->
    <div class="modal" :class="{ active: showTrackingModal }">
        <div class="modal-content" style="max-width:400px">
            <div class="modal-header">
                <h3>ADD TRACKING</h3>
                <button class="close-btn" @click="showTrackingModal = false">&times;</button>
            </div>
            <form @submit.prevent="saveTracking()">
                <label>Tracking Number</label>
                <input type="text" x-model="trackingForm.tracking_number" required>

                <label>Carrier (optional)</label>
                <input type="text" x-model="trackingForm.carrier" placeholder="USPS, FedEx, UPS...">

                <button type="submit" class="btn" style="width: 100%; margin-top: 8px;">SAVE TRACKING</button>
            </form>
        </div>
    </div>

    <script>
        // Generate pixel stars
        (function generateStars(){
            const container=document.getElementById('stars');
            const sizes=[2,3,4,6,8];
            for(let i=0;i<40;i++){
                const star=document.createElement('div');
                star.className='star'+(Math.random()>0.6?' twinkle':'');
                const size=sizes[Math.floor(Math.random()*sizes.length)];
                star.style.width=size+'px';
                star.style.height=size+'px';
                star.style.left=Math.random()*100+'%';
                star.style.top=Math.random()*100+'%';
                star.style.animationDelay=Math.random()*2+'s';
                container.appendChild(star);
            }
        })();

        function admin() {
            return {
                tab: 'dashboard',
                dashboard: {},
                products: [],
                orders: [],
                showProductModal: false,
                showOrderModal: false,
                showTrackingModal: false,
                editingProduct: null,
                selectedOrder: null,
                trackingOrderId: null,
                productForm: { name: '', description: '', price: 0, stock_quantity: 0 },
                trackingForm: { tracking_number: '', carrier: '' },
                previewImage: null,
                selectedFile: null,

                async init() {
                    await this.loadDashboard();
                },

                async loadDashboard() {
                    try {
                        const res = await fetch('/admin/api/dashboard');
                        this.dashboard = await res.json();
                    } catch (e) {
                        console.error('Failed to load dashboard:', e);
                    }
                },

                async loadProducts() {
                    try {
                        const res = await fetch('/admin/api/products');
                        this.products = await res.json();
                    } catch (e) {
                        console.error('Failed to load products:', e);
                    }
                },

                async loadOrders() {
                    try {
                        const res = await fetch('/admin/api/orders');
                        this.orders = await res.json();
                    } catch (e) {
                        console.error('Failed to load orders:', e);
                    }
                },

                openProductModal() {
                    this.editingProduct = null;
                    this.productForm = { name: '', description: '', price: 0, stock_quantity: 0 };
                    this.previewImage = null;
                    this.selectedFile = null;
                    this.showProductModal = true;
                },

                editProduct(product) {
                    this.editingProduct = product;
                    this.productForm = {
                        name: product.name,
                        description: product.description || '',
                        price: product.price,
                        stock_quantity: product.stock_quantity
                    };
                    this.previewImage = product.image_url || null;
                    this.selectedFile = null;
                    this.showProductModal = true;
                },

                handleImageSelect(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    this.selectedFile = file;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        this.previewImage = e.target.result;
                    };
                    reader.readAsDataURL(file);
                },

                async saveProduct() {
                    try {
                        const price_cents = Math.round(parseFloat(this.productForm.price) * 100);
                        const productData = {
                            name: this.productForm.name,
                            description: this.productForm.description,
                            price_cents: price_cents,
                            stock_quantity: parseInt(this.productForm.stock_quantity) || 0
                        };

                        let productId = this.editingProduct?.id;

                        if (this.editingProduct) {
                            await fetch(`/admin/api/products/${productId}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(productData)
                            });
                        } else {
                            const res = await fetch('/admin/api/products', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(productData)
                            });
                            const created = await res.json();
                            productId = created.id;
                        }

                        // Upload image if selected
                        if (this.selectedFile && productId) {
                            const formData = new FormData();
                            formData.append('file', this.selectedFile);
                            await fetch(`/admin/api/products/${productId}/image`, {
                                method: 'POST',
                                body: formData
                            });
                        }

                        this.showProductModal = false;
                        this.previewImage = null;
                        this.selectedFile = null;
                        await this.loadProducts();
                    } catch (e) {
                        console.error('Failed to save product:', e);
                    }
                },

                async toggleProductActive(product) {
                    try {
                        await fetch(`/admin/api/products/${product.id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ is_active: !product.is_active })
                        });
                        await this.loadProducts();
                    } catch (e) {
                        console.error('Failed to toggle product:', e);
                    }
                },

                async deleteProduct(id) {
                    if (!confirm('Delete this product?')) return;
                    try {
                        await fetch(`/admin/api/products/${id}`, { method: 'DELETE' });
                        await this.loadProducts();
                    } catch (e) {
                        console.error('Failed to delete product:', e);
                    }
                },

                viewOrder(order) {
                    this.selectedOrder = order;
                    this.showOrderModal = true;
                },

                async updateOrderStatus(orderId, status) {
                    try {
                        await fetch(`/admin/api/orders/${orderId}/status`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ status })
                        });
                        await this.loadOrders();
                    } catch (e) {
                        console.error('Failed to update order status:', e);
                    }
                },

                openTrackingModal(order) {
                    this.trackingOrderId = order.id;
                    this.trackingForm = { tracking_number: '', carrier: '' };
                    this.showTrackingModal = true;
                },

                async saveTracking() {
                    try {
                        await fetch(`/admin/api/orders/${this.trackingOrderId}/tracking`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.trackingForm)
                        });
                        this.showTrackingModal = false;
                        await this.loadOrders();
                    } catch (e) {
                        console.error('Failed to save tracking:', e);
                    }
                },

                logout() {
                    window.location.href = '/';
                }
            };
        }
    </script>
</body>
</html>
