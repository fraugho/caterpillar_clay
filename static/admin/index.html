<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caterpillar Clay - Admin</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root{
            --bg-primary:#F8F8F8;
            --bg-secondary:#FFFFFF;
            --bg-card:#FFFFFF;
            --text-primary:#18191B;
            --text-secondary:#666666;
            --accent:#97BAD9;
            --accent-hover:#7BA3C9;
            --border:#E0E0E0;
        }
        @media(prefers-color-scheme:dark){
            :root{
                --bg-primary:#18191B;
                --bg-secondary:#1E2022;
                --bg-card:#252729;
                --text-primary:#F8F8F8;
                --text-secondary:#A0A0A0;
                --accent:#97BAD9;
                --accent-hover:#AECCE8;
                --border:#333537;
            }
        }
        *{margin:0;padding:0;box-sizing:border-box;image-rendering:pixelated}
        body{font-family:'Press Start 2P',cursive;background:var(--bg-primary);color:var(--text-primary);min-height:100vh;position:relative}
        .stars{position:fixed;inset:0;pointer-events:none;z-index:0;overflow:hidden}
        .star{position:absolute;background:var(--accent);opacity:0.3}
        .star.twinkle{animation:twinkle 2s ease-in-out infinite}
        @keyframes twinkle{0%,100%{opacity:0.15}50%{opacity:0.4}}
        .container{max-width:1200px;margin:0 auto;padding:20px;position:relative;z-index:1}
        nav{background:var(--accent);padding:20px;margin-bottom:20px;position:relative;z-index:1}
        nav .inner{max-width:1200px;margin:0 auto;display:flex;justify-content:space-between;align-items:center}
        nav h1{font-size:14px;color:#18191B}
        .tabs{display:flex;gap:8px;margin-bottom:20px}
        .tab{background:var(--bg-card);color:var(--text-secondary);padding:12px 16px;font-family:inherit;font-size:8px;border:2px solid var(--border);border-radius:8px;cursor:pointer}
        .tab.active{background:var(--accent);color:#18191B;border-color:var(--accent)}
        .tab:hover{border-color:var(--accent)}
        .card{background:var(--bg-card);padding:20px;margin-bottom:20px;border:2px solid var(--border);border-radius:12px}
        .card h2{font-size:12px;margin-bottom:16px;color:var(--accent)}
        .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:20px}
        .stat{background:var(--bg-card);padding:16px;text-align:center;border:2px solid var(--border);border-radius:12px}
        .stat-value{font-size:18px;color:var(--accent);margin-bottom:8px}
        .stat-label{font-size:8px;color:var(--text-secondary)}
        table{width:100%;border-collapse:collapse;font-size:8px}
        th,td{padding:12px;text-align:left;border-bottom:1px solid var(--border)}
        th{color:var(--accent)}
        .btn{background:var(--accent);color:#18191B;padding:10px 14px;font-family:inherit;font-size:8px;border:none;cursor:pointer;border-radius:8px;transition:background .2s}
        .btn:hover{background:var(--accent-hover)}
        .btn-danger{background:#dc2626;color:#fff}
        .btn-danger:hover{background:#b91c1c}
        .btn-success{background:#16a34a;color:#fff}
        .btn-sm{padding:6px 10px;font-size:6px;border-radius:6px}
        input,textarea,select{width:100%;padding:10px;font-family:inherit;font-size:8px;margin-bottom:12px;background:var(--bg-secondary);color:var(--text-primary);border:2px solid var(--border);border-radius:8px}
        input:focus,textarea:focus,select:focus{outline:none;border-color:var(--accent)}
        .form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
        label{display:block;font-size:8px;margin-bottom:4px;color:var(--text-secondary)}
        .status{padding:4px 8px;font-size:6px;border-radius:6px}
        .status-pending{background:#eab308;color:#000}
        .status-paid{background:#22c55e;color:#000}
        .status-processing{background:#3b82f6;color:#fff}
        .status-shipped{background:#8b5cf6;color:#fff}
        .status-delivered{background:#10b981;color:#fff}
        .status-cancelled{background:#ef4444;color:#fff}
        .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;align-items:center;justify-content:center}
        .modal.active{display:flex}
        .modal-content{background:var(--bg-card);padding:24px;max-width:900px;width:90%;max-height:90vh;overflow-y:auto;border-radius:12px;border:2px solid var(--border)}
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
        .modal-header h3{font-size:10px;color:var(--accent)}
        .close-btn{background:none;border:none;color:var(--text-secondary);font-size:16px;cursor:pointer}
        .product-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:32px}
        .product-card{background:var(--bg-card);padding:24px;border:2px solid var(--border);border-radius:12px;text-align:center;transition:transform .2s,box-shadow .2s}
        .product-card:hover{transform:translateY(-4px);box-shadow:0 8px 24px rgba(0,0,0,0.1)}
        .product-card img,.product-card .placeholder-img,.product-card .carousel{width:100%;height:380px;object-fit:cover;background:var(--bg-secondary);margin-bottom:20px;border:2px solid var(--border);border-radius:8px}
        .product-card .placeholder-img{display:flex;align-items:center;justify-content:center;font-size:10px;color:var(--text-secondary)}
        .product-card h4{font-size:12px;margin-top:8px;margin-bottom:12px}
        .product-card .price{color:var(--accent);font-size:14px;margin-bottom:12px}
        .product-card .stock{font-size:10px;color:var(--text-secondary);margin-bottom:16px}
        .product-card .active-status{font-size:10px;margin-left:8px;color:var(--text-secondary)}
        .product-actions{display:flex;gap:12px;margin-top:16px;justify-content:center}
        .product-actions .btn{padding:12px 20px;font-size:10px}
        .alert{padding:12px;margin-bottom:16px;font-size:8px;border-radius:8px}
        .alert-warning{background:#fef3c7;color:#92400e}
        .alert-success{background:#d1fae5;color:#065f46}
        .toast{position:fixed;top:20px;right:20px;padding:16px 24px;border-radius:8px;font-size:10px;z-index:2000;animation:slideIn 0.3s ease;box-shadow:0 4px 12px rgba(0,0,0,0.3)}
        .toast.success{background:#22c55e;color:#fff}
        .toast.error{background:#ef4444;color:#fff}
        @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
        [x-cloak]{display:none!important}
        .toggle{position:relative;display:inline-block;width:48px;height:24px}
        .toggle input{opacity:0;width:0;height:0}
        .toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:var(--border);transition:.3s;border-radius:12px}
        .toggle-slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;bottom:3px;background:var(--text-secondary);transition:.3s;border-radius:50%}
        .toggle input:checked+.toggle-slider{background:#22c55e}
        .toggle input:checked+.toggle-slider:before{transform:translateX(24px);background:#fff}
        .preview-section{display:grid;grid-template-columns:1fr 1fr;gap:24px}
        .form-section,.preview-card{padding:20px}
        .preview-card{background:var(--bg-secondary);border:2px solid var(--border);border-radius:12px;text-align:center}
        .preview-card h4{font-size:10px;margin-bottom:10px}
        .preview-card .price{color:var(--accent);font-size:12px;margin-bottom:10px}
        .preview-card .stock{font-size:8px;color:var(--text-secondary);margin-bottom:14px}
        .preview-card img,.preview-card .preview-placeholder{width:100%;height:300px;object-fit:cover;background:var(--bg-primary);border:2px solid var(--border);border-radius:8px;margin-bottom:12px}
        .preview-card .preview-placeholder{display:flex;align-items:center;justify-content:center;font-size:10px;color:var(--text-secondary)}
        .preview-btn{background:var(--accent);color:#18191B;padding:14px 20px;font-family:inherit;font-size:8px;border:none;border-radius:8px;width:100%}
        .image-upload{border:2px dashed var(--border);border-radius:8px;padding:20px;text-align:center;cursor:pointer;transition:border-color .2s}
        .image-upload:hover{border-color:var(--accent)}
        .image-upload input{display:none}
        .image-upload img{max-width:100%;max-height:200px;margin-top:12px;border-radius:8px}
        .image-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:8px;margin-top:12px}
        .image-item{position:relative;aspect-ratio:1;background:var(--bg-secondary);border:2px solid var(--border);border-radius:8px;overflow:hidden;cursor:grab}
        .image-item.dragging{opacity:0.5;border-color:var(--accent)}
        .image-item.drag-over{border-color:var(--accent);border-style:dashed}
        .image-item img{width:100%;height:100%;object-fit:cover}
        .image-item .delete-btn{position:absolute;top:4px;right:4px;background:rgba(220,38,38,0.9);color:#fff;border:none;width:20px;height:20px;border-radius:4px;cursor:pointer;font-size:10px;display:flex;align-items:center;justify-content:center}
        .image-item .order-badge{position:absolute;bottom:4px;left:4px;background:rgba(0,0,0,0.7);color:#fff;font-size:6px;padding:2px 6px;border-radius:4px}
        .carousel{position:relative;width:100%;height:380px;overflow:hidden;border-radius:8px}
        .carousel-inner{display:flex;transition:transform 0.3s ease;height:100%}
        .carousel-inner img{min-width:100%;height:100%;object-fit:cover}
        .carousel-btn{position:absolute;top:50%;transform:translateY(-50%);background:rgba(0,0,0,0.5);color:#fff;border:none;padding:8px 12px;cursor:pointer;font-size:12px;border-radius:4px}
        .carousel-btn.prev{left:8px}
        .carousel-btn.next{right:8px}
        .carousel-dots{position:absolute;bottom:8px;left:50%;transform:translateX(-50%);display:flex;gap:4px}
        .carousel-dot{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,0.5);border:none;cursor:pointer}
        .carousel-dot.active{background:#fff}
        @media(max-width:768px){.preview-section{grid-template-columns:1fr}}
    </style>
</head>
<body x-data="admin()">
    <div class="stars" id="stars"></div>

    <!-- Toast Notification -->
    <div class="toast" :class="toast.type" x-show="toast.show" x-cloak x-text="toast.message" x-transition.duration.300ms></div>

    <nav>
        <div class="inner">
            <h1>CATERPILLAR CLAY ADMIN</h1>
            <button class="btn btn-sm" @click="logout()">LOGOUT</button>
        </div>
    </nav>

    <div class="container">
        <div class="tabs">
            <button class="tab" :class="{ active: tab === 'dashboard' }" @click="tab = 'dashboard'">DASHBOARD</button>
            <button class="tab" :class="{ active: tab === 'products' }" @click="tab = 'products'; loadProducts()">PRODUCTS</button>
            <button class="tab" :class="{ active: tab === 'orders' }" @click="tab = 'orders'; loadOrders()">ORDERS</button>
            <button class="tab" :class="{ active: tab === 'notify' }" @click="tab = 'notify'; loadNotifyProducts()">NOTIFY</button>
            <button class="tab" :class="{ active: tab === 'artist' }" @click="tab = 'artist'; loadArtistSettings()">ARTIST</button>
            <button class="tab" :class="{ active: tab === 'site' }" @click="tab = 'site'; loadSiteSettings()">SITE</button>
        </div>

        <!-- Dashboard -->
        <template x-if="tab === 'dashboard'">
            <div>
                <div class="stats">
                    <div class="stat">
                        <div class="stat-value" x-text="dashboard.total_orders || 0"></div>
                        <div class="stat-label">TOTAL ORDERS</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">$<span x-text="(dashboard.total_revenue || 0).toFixed(2)"></span></div>
                        <div class="stat-label">TOTAL REVENUE</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" x-text="dashboard.total_products || 0"></div>
                        <div class="stat-label">PRODUCTS</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" x-text="subscriberCount"></div>
                        <div class="stat-label">SUBSCRIBERS</div>
                    </div>
                </div>

                <template x-if="dashboard.low_stock_products && dashboard.low_stock_products.length">
                    <div class="card">
                        <h2>LOW STOCK ALERTS</h2>
                        <template x-for="p in dashboard.low_stock_products" :key="p.id">
                            <div class="alert alert-warning">
                                <span x-text="p.name"></span> - Only <span x-text="p.stock_quantity"></span> left
                            </div>
                        </template>
                    </div>
                </template>

                <div class="card">
                    <h2>RECENT ORDERS</h2>
                    <table>
                        <thead>
                            <tr><th>ID</th><th>STATUS</th><th>TOTAL</th><th>DATE</th></tr>
                        </thead>
                        <tbody>
                            <template x-for="o in dashboard.recent_orders || []" :key="o.id">
                                <tr>
                                    <td x-text="o.id.substring(0,8)"></td>
                                    <td><span class="status" :class="'status-' + o.status" x-text="o.status.toUpperCase()"></span></td>
                                    <td>$<span x-text="o.total.toFixed(2)"></span></td>
                                    <td x-text="new Date(o.created_at).toLocaleDateString()"></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </template>

        <!-- Products -->
        <template x-if="tab === 'products'">
            <div>
                <div style="margin-bottom: 16px;">
                    <button class="btn" @click="openProductModal()">+ ADD PRODUCT</button>
                </div>

                <div class="product-grid">
                    <template x-for="p in products" :key="p.id">
                        <div class="product-card" x-data="{ carouselIdx: 0 }">
                            <template x-if="p.images && p.images.length > 0">
                                <div class="carousel">
                                    <div class="carousel-inner" :style="`transform: translateX(-${carouselIdx * 100}%)`">
                                        <template x-for="img in p.images" :key="img.id">
                                            <img :src="img.image_url" :alt="p.name">
                                        </template>
                                    </div>
                                    <template x-if="p.images.length > 1">
                                        <button class="carousel-btn prev" @click="carouselIdx = (carouselIdx - 1 + p.images.length) % p.images.length">&lt;</button>
                                    </template>
                                    <template x-if="p.images.length > 1">
                                        <button class="carousel-btn next" @click="carouselIdx = (carouselIdx + 1) % p.images.length">&gt;</button>
                                    </template>
                                    <template x-if="p.images.length > 1">
                                        <div class="carousel-dots">
                                            <template x-for="(img, idx) in p.images" :key="img.id">
                                                <button class="carousel-dot" :class="{ active: idx === carouselIdx }" @click="carouselIdx = idx"></button>
                                            </template>
                                        </div>
                                    </template>
                                </div>
                            </template>
                            <template x-if="!p.images || p.images.length === 0">
                                <div class="placeholder-img">[NO IMAGE]</div>
                            </template>
                            <h4 x-text="p.name"></h4>
                            <div class="price">$<span x-text="p.price.toFixed(2)"></span></div>
                            <div class="stock" x-text="p.stock_quantity > 0 ? 'In Stock (' + p.stock_quantity + ')' : 'Out of Stock'"></div>
                            <div style="margin-top: 12px; display: flex; align-items: center; justify-content: center;">
                                <label class="toggle">
                                    <input type="checkbox" :checked="p.is_active" @change="toggleProductActive(p)">
                                    <span class="toggle-slider"></span>
                                </label>
                                <span class="active-status" x-text="p.is_active ? 'Active' : 'Inactive'"></span>
                            </div>
                            <div class="product-actions" style="flex-wrap:wrap">
                                <button class="btn" @click="editProduct(p)">EDIT</button>
                                <button class="btn btn-danger" @click="deleteProduct(p.id)">DELETE</button>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </template>

        <!-- Orders -->
        <template x-if="tab === 'orders'">
            <div class="card">
                <h2>ALL ORDERS</h2>
                <table>
                    <thead>
                        <tr><th>ID</th><th>CUSTOMER</th><th>STATUS</th><th>TOTAL</th><th>DATE</th><th>ACTIONS</th></tr>
                    </thead>
                    <tbody>
                        <template x-for="o in orders" :key="o.id">
                            <tr>
                                <td x-text="o.id.substring(0, 8)"></td>
                                <td x-text="o.user ? o.user.email : 'Guest'"></td>
                                <td>
                                    <select class="btn btn-sm" :value="o.status" @change="updateOrderStatus(o.id, $event.target.value)" style="width: auto;">
                                        <option value="pending">Pending</option>
                                        <option value="paid">Paid</option>
                                        <option value="processing">Processing</option>
                                        <option value="shipped">Shipped</option>
                                        <option value="delivered">Delivered</option>
                                        <option value="cancelled">Cancelled</option>
                                    </select>
                                </td>
                                <td>$<span x-text="o.total.toFixed(2)"></span></td>
                                <td x-text="new Date(o.created_at).toLocaleDateString()"></td>
                                <td>
                                    <button class="btn btn-sm" @click="viewOrder(o)">VIEW</button>
                                    <template x-if="!o.tracking_number && o.status !== 'pending'">
                                        <button class="btn btn-sm btn-success" @click="openTrackingModal(o)">ADD TRACKING</button>
                                    </template>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </template>

        <!-- Notify -->
        <template x-if="tab === 'notify'">
            <div>
                <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:20px;align-items:center">
                    <button class="btn btn-success" @click="sendBatchNotify('new')" :disabled="!hasSelectedProducts || sendingNotify">
                        <span x-text="sendingNotify ? 'SENDING...' : 'SEND NEW PRODUCTS EMAIL'"></span>
                    </button>
                    <button class="btn" style="background:#eab308;color:#000" @click="sendBatchNotify('restock')" :disabled="!hasSelectedProducts || sendingNotify">
                        <span x-text="sendingNotify ? 'SENDING...' : 'SEND IN STOCK EMAIL'"></span>
                    </button>
                    <button class="btn btn-sm" style="background:var(--bg-secondary);color:var(--text-primary)" @click="selectAllProducts()">SELECT ALL</button>
                    <button class="btn btn-sm" style="background:var(--bg-secondary);color:var(--text-primary)" @click="deselectAllProducts()">DESELECT ALL</button>
                    <span style="font-size:8px;color:var(--text-secondary)">Subscribers: <span x-text="subscriberCount"></span></span>
                </div>

                <div class="product-grid">
                    <template x-for="p in notifyProducts" :key="p.id">
                        <label class="product-card" style="cursor:pointer;position:relative" :style="{ borderColor: p.selected ? 'var(--accent)' : 'var(--border)', borderWidth: p.selected ? '3px' : '2px' }">
                            <input type="checkbox" x-model="p.selected" style="position:absolute;top:12px;left:12px;width:20px;height:20px;margin:0;z-index:10">
                            <template x-if="p.images && p.images.length > 0">
                                <img :src="p.images[0].image_url" :alt="p.name" class="product-img" style="height:280px">
                            </template>
                            <template x-if="!p.images || p.images.length === 0">
                                <div class="placeholder-img" style="height:280px">[NO IMAGE]</div>
                            </template>
                            <h4 x-text="p.name"></h4>
                            <div class="price">$<span x-text="p.price.toFixed(2)"></span></div>
                            <div class="stock" x-text="p.stock_quantity > 0 ? 'In Stock (' + p.stock_quantity + ')' : 'Out of Stock'"></div>
                        </label>
                    </template>
                </div>
            </div>
        </template>

        <!-- Artist -->
        <template x-if="tab === 'artist'">
            <div>
                <div class="card">
                    <h2>MEET THE ARTIST</h2>
                    <div class="preview-section">
                        <div class="form-section">
                            <form @submit.prevent="saveArtistSettings()">
                                <label>Photo</label>
                                <div class="image-upload" @click="$refs.artistImageInput.click()">
                                    <input type="file" x-ref="artistImageInput" @change="handleArtistImageSelect($event)" accept="image/*">
                                    <template x-if="artistSettings.image">
                                        <img :src="artistSettings.imagePreview || artistSettings.image" style="max-height:200px;border-radius:8px">
                                    </template>
                                    <template x-if="!artistSettings.image">
                                        <p style="font-size:8px;color:var(--text-secondary)">Click to upload artist image</p>
                                    </template>
                                </div>

                                <label style="margin-top:16px">Bio</label>
                                <textarea x-model="artistSettings.description" rows="6" style="min-height:150px"></textarea>

                                <button type="submit" class="btn" style="width: 100%; margin-top: 8px;" :disabled="savingArtist">
                                    <span x-text="savingArtist ? 'SAVING...' : 'SAVE'"></span>
                                </button>
                            </form>
                        </div>
                        <div class="preview-card">
                            <p style="font-size:8px;color:var(--text-secondary);margin-bottom:12px">ARTIST PAGE PREVIEW</p>
                            <template x-if="artistSettings.imagePreview || artistSettings.image">
                                <img :src="artistSettings.imagePreview || artistSettings.image" style="width:100%;max-height:300px;object-fit:cover;border-radius:8px;margin-bottom:12px">
                            </template>
                            <template x-if="!artistSettings.imagePreview && !artistSettings.image">
                                <div class="preview-placeholder">[ARTIST IMAGE]</div>
                            </template>
                            <div style="background:var(--accent);border-radius:8px;padding:16px;margin-top:12px">
                                <p style="font-size:8px;line-height:2;color:#18191B" x-text="artistSettings.description || 'Artist description will appear here...'"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </template>

        <!-- Site Settings -->
        <template x-if="tab === 'site'">
            <div>
                <div class="card">
                    <h2>FAVICON</h2>
                    <div style="display:flex;align-items:center;gap:20px">
                        <div class="image-upload" style="width:100px;height:100px;padding:10px" @click="$refs.faviconInput.click()">
                            <input type="file" x-ref="faviconInput" @change="handleFaviconSelect($event)" accept="image/png,image/x-icon">
                            <template x-if="faviconPreview || favicon">
                                <img :src="faviconPreview || favicon" style="width:64px;height:64px;object-fit:contain">
                            </template>
                            <template x-if="!faviconPreview && !favicon">
                                <p style="font-size:6px;color:var(--text-secondary);text-align:center">Click to upload</p>
                            </template>
                        </div>
                        <div>
                            <p style="font-size:8px;color:var(--text-secondary);margin-bottom:8px">Upload a PNG image (32x32 recommended)</p>
                            <button class="btn btn-sm" @click="saveFavicon()" :disabled="!faviconFile || savingFavicon">
                                <span x-text="savingFavicon ? 'SAVING...' : 'SAVE FAVICON'"></span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <!-- Product Modal -->
    <div class="modal" :class="{ active: showProductModal }">
        <div class="modal-content">
            <div class="modal-header">
                <h3 x-text="editingProduct ? 'EDIT PRODUCT' : 'ADD PRODUCT'"></h3>
                <button class="close-btn" @click="showProductModal = false">&times;</button>
            </div>
            <div class="preview-section">
                <div class="form-section">
                    <form @submit.prevent="saveProduct()">
                        <label>Product Images <span style="font-size:6px;color:var(--text-secondary)">(drag to reorder)</span></label>
                        <div class="image-upload" @click="$refs.imageInput.click()" @dragover.prevent @drop.prevent="handleImageDrop($event)">
                            <input type="file" x-ref="imageInput" @change="handleImageSelect($event)" accept="image/*" multiple>
                            <p style="font-size:8px;color:var(--text-secondary)">Click or drop images here</p>
                        </div>

                        <template x-if="productImages.length > 0">
                            <div class="image-grid">
                                <template x-for="(img, idx) in productImages" :key="img.id || idx">
                                    <div class="image-item"
                                         :class="{ dragging: dragIdx === idx, 'drag-over': dragOverIdx === idx }"
                                         draggable="true"
                                         @dragstart="startDrag(idx)"
                                         @dragend="endDrag()"
                                         @dragover.prevent="dragOverIdx = idx"
                                         @dragleave="dragOverIdx = null"
                                         @drop.prevent="handleDrop(idx)">
                                        <img :src="img.image_url || img.preview" :alt="'Image ' + (idx + 1)">
                                        <button type="button" class="delete-btn" @click.stop="removeImage(idx, img)">&times;</button>
                                        <span class="order-badge" x-text="idx + 1"></span>
                                    </div>
                                </template>
                            </div>
                        </template>

                        <label style="margin-top:16px">Name</label>
                        <input type="text" x-model="productForm.name" required>

                        <label>Description</label>
                        <textarea x-model="productForm.description" rows="3"></textarea>

                        <div class="form-row">
                            <div>
                                <label>Price ($)</label>
                                <input type="number" step="0.01" x-model="productForm.price" required>
                            </div>
                            <div>
                                <label>Stock</label>
                                <input type="number" x-model="productForm.stock_quantity">
                            </div>
                        </div>

                        <button type="submit" class="btn" style="width: 100%; margin-top: 8px;">SAVE PRODUCT</button>
                    </form>
                </div>
                <div class="preview-card" x-data="{ previewIdx: 0 }">
                    <p style="font-size:8px;color:var(--text-secondary);margin-bottom:12px">LISTING PREVIEW</p>
                    <template x-if="productImages.length > 0">
                        <div class="carousel" style="height:300px">
                            <div class="carousel-inner" :style="`transform: translateX(-${previewIdx * 100}%)`">
                                <template x-for="img in productImages" :key="img.id || img.preview">
                                    <img :src="img.image_url || img.preview" alt="Preview">
                                </template>
                            </div>
                            <template x-if="productImages.length > 1">
                                <button class="carousel-btn prev" @click="previewIdx = (previewIdx - 1 + productImages.length) % productImages.length">&lt;</button>
                            </template>
                            <template x-if="productImages.length > 1">
                                <button class="carousel-btn next" @click="previewIdx = (previewIdx + 1) % productImages.length">&gt;</button>
                            </template>
                        </div>
                    </template>
                    <template x-if="productImages.length === 0">
                        <div class="preview-placeholder">[IMAGE]</div>
                    </template>
                    <h4 x-text="productForm.name || 'Product Name'"></h4>
                    <div class="price">$<span x-text="(parseFloat(productForm.price) || 0).toFixed(2)"></span></div>
                    <div class="stock" x-text="productForm.stock_quantity > 0 ? 'In Stock' : 'Out of Stock'"></div>
                    <button class="preview-btn" disabled>ADD TO CART</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Detail Modal -->
    <div class="modal" :class="{ active: showOrderModal }">
        <div class="modal-content" style="max-width:500px">
            <div class="modal-header">
                <h3>ORDER DETAILS</h3>
                <button class="close-btn" @click="showOrderModal = false">&times;</button>
            </div>
            <template x-if="selectedOrder">
                <div>
                    <p style="font-size: 8px; margin-bottom: 8px;"><strong>ID:</strong> <span x-text="selectedOrder.id"></span></p>
                    <p style="font-size: 8px; margin-bottom: 8px;"><strong>Status:</strong> <span x-text="selectedOrder.status"></span></p>
                    <p style="font-size: 8px; margin-bottom: 8px;"><strong>Total:</strong> $<span x-text="selectedOrder.total.toFixed(2)"></span></p>

                    <template x-if="selectedOrder.shipping_address">
                        <div style="margin-bottom: 12px;">
                            <p style="font-size: 8px; color: var(--accent); margin-bottom: 4px;">SHIPPING ADDRESS</p>
                            <p style="font-size: 8px;" x-text="selectedOrder.shipping_address.name"></p>
                            <p style="font-size: 8px;" x-text="selectedOrder.shipping_address.street"></p>
                            <p style="font-size: 8px;" x-text="`${selectedOrder.shipping_address.city}, ${selectedOrder.shipping_address.state} ${selectedOrder.shipping_address.zip}`"></p>
                        </div>
                    </template>

                    <template x-if="selectedOrder.tracking_number">
                        <p style="font-size: 8px; margin-bottom: 8px;"><strong>Tracking:</strong> <span x-text="selectedOrder.tracking_number"></span></p>
                    </template>

                    <p style="font-size: 8px; color: var(--accent); margin: 12px 0 4px;">ITEMS</p>
                    <template x-for="item in selectedOrder.items" :key="item.product_id">
                        <p style="font-size: 8px; margin-bottom: 4px;">
                            <span x-text="item.product_name"></span> x<span x-text="item.quantity"></span> - $<span x-text="(item.price_cents / 100).toFixed(2)"></span>
                        </p>
                    </template>
                </div>
            </template>
        </div>
    </div>

    <!-- Tracking Modal -->
    <div class="modal" :class="{ active: showTrackingModal }">
        <div class="modal-content" style="max-width:400px">
            <div class="modal-header">
                <h3>ADD TRACKING</h3>
                <button class="close-btn" @click="showTrackingModal = false">&times;</button>
            </div>
            <form @submit.prevent="saveTracking()">
                <label>Tracking Number</label>
                <input type="text" x-model="trackingForm.tracking_number" required>

                <label>Carrier (optional)</label>
                <input type="text" x-model="trackingForm.carrier" placeholder="USPS, FedEx, UPS...">

                <button type="submit" class="btn" style="width: 100%; margin-top: 8px;">SAVE TRACKING</button>
            </form>
        </div>
    </div>

    <script>
        // Generate pixel stars
        (function generateStars(){
            const container=document.getElementById('stars');
            const sizes=[2,3,4,6,8];
            for(let i=0;i<40;i++){
                const star=document.createElement('div');
                star.className='star'+(Math.random()>0.6?' twinkle':'');
                const size=sizes[Math.floor(Math.random()*sizes.length)];
                star.style.width=size+'px';
                star.style.height=size+'px';
                star.style.left=Math.random()*100+'%';
                star.style.top=Math.random()*100+'%';
                star.style.animationDelay=Math.random()*2+'s';
                container.appendChild(star);
            }
        })();

        function admin() {
            return {
                tab: localStorage.getItem('adminTab') || 'dashboard',
                dashboard: {},
                products: [],
                orders: [],
                showProductModal: false,
                showOrderModal: false,
                showTrackingModal: false,
                editingProduct: null,
                selectedOrder: null,
                trackingOrderId: null,
                productForm: { name: '', description: '', price: 0, stock_quantity: 0 },
                trackingForm: { tracking_number: '', carrier: '' },
                productImages: [],
                newImages: [],
                dragIdx: null,
                dragOverIdx: null,
                artistSettings: { image: '', description: '', imagePreview: null, newImageFile: null },
                savingArtist: false,
                subscriberCount: 0,
                toast: { show: false, message: '', type: 'success' },
                notifyProducts: [],
                sendingNotify: false,
                favicon: null,
                faviconPreview: null,
                faviconFile: null,
                savingFavicon: false,

                async init() {
                    // Always load subscriber count for notifications
                    await this.loadSubscriberCount();

                    // Load data for saved tab
                    if (this.tab === 'products') {
                        await this.loadProducts();
                    } else if (this.tab === 'orders') {
                        await this.loadOrders();
                    } else if (this.tab === 'notify') {
                        await this.loadNotifyProducts();
                    } else if (this.tab === 'artist') {
                        await this.loadArtistSettings();
                    } else if (this.tab === 'site') {
                        await this.loadSiteSettings();
                    } else {
                        await this.loadDashboard();
                    }

                    // Watch for tab changes and save to localStorage
                    this.$watch('tab', (value) => {
                        localStorage.setItem('adminTab', value);
                    });
                },

                async loadDashboard() {
                    try {
                        const res = await fetch('/admin/api/dashboard');
                        this.dashboard = await res.json();
                    } catch (e) {
                        console.error('Failed to load dashboard:', e);
                    }
                },

                async loadSubscriberCount() {
                    try {
                        const res = await fetch('/admin/api/newsletter/subscribers');
                        const data = await res.json();
                        this.subscriberCount = data.count || 0;
                    } catch (e) {
                        console.error('Failed to load subscriber count:', e);
                    }
                },

                showToast(message, type = 'success') {
                    this.toast = { show: true, message, type };
                    setTimeout(() => { this.toast.show = false; }, 4000);
                },

                get hasSelectedProducts() {
                    return this.notifyProducts.some(p => p.selected);
                },

                async loadNotifyProducts() {
                    try {
                        const res = await fetch('/admin/api/products');
                        const products = await res.json();
                        this.notifyProducts = products.map(p => ({ ...p, selected: false }));
                    } catch (e) {
                        console.error('Failed to load products:', e);
                    }
                },

                selectAllProducts() {
                    this.notifyProducts.forEach(p => p.selected = true);
                },

                deselectAllProducts() {
                    this.notifyProducts.forEach(p => p.selected = false);
                },

                async sendBatchNotify(type) {
                    const selectedIds = this.notifyProducts.filter(p => p.selected).map(p => p.id);
                    if (selectedIds.length === 0) return;

                    const typeLabel = type === 'new' ? 'New Products' : 'Back in Stock';
                    if (!confirm(`Send "${typeLabel}" email with ${selectedIds.length} product(s) to ${this.subscriberCount} subscriber(s)?`)) return;

                    this.sendingNotify = true;
                    try {
                        const res = await fetch(`/admin/api/newsletter/notify-batch/${type}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ product_ids: selectedIds })
                        });
                        const data = await res.json();
                        if (data.success) {
                            this.showToast('Sent!', 'success');
                            this.deselectAllProducts();
                        } else {
                            this.showToast('Failed to send emails', 'error');
                        }
                    } catch (e) {
                        console.error('Failed to send batch notify:', e);
                        this.showToast('Failed to send emails', 'error');
                    } finally {
                        this.sendingNotify = false;
                    }
                },

                async loadProducts() {
                    try {
                        const res = await fetch('/admin/api/products');
                        this.products = await res.json();
                    } catch (e) {
                        console.error('Failed to load products:', e);
                    }
                },

                async loadOrders() {
                    try {
                        const res = await fetch('/admin/api/orders');
                        this.orders = await res.json();
                    } catch (e) {
                        console.error('Failed to load orders:', e);
                    }
                },

                openProductModal() {
                    this.editingProduct = null;
                    this.productForm = { name: '', description: '', price: 0, stock_quantity: 0 };
                    this.productImages = [];
                    this.newImages = [];
                    this.showProductModal = true;
                },

                editProduct(product) {
                    this.editingProduct = product;
                    this.productForm = {
                        name: product.name,
                        description: product.description || '',
                        price: product.price,
                        stock_quantity: product.stock_quantity
                    };
                    this.productImages = (product.images || []).map(img => ({
                        id: img.id,
                        image_url: img.image_url,
                        isExisting: true
                    }));
                    this.newImages = [];
                    this.showProductModal = true;
                },

                handleImageSelect(event) {
                    const files = Array.from(event.target.files);
                    this.addImages(files);
                    event.target.value = '';
                },

                handleImageDrop(event) {
                    const files = Array.from(event.dataTransfer.files).filter(f => f.type.startsWith('image/'));
                    this.addImages(files);
                },

                addImages(files) {
                    files.forEach(file => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            this.productImages.push({
                                file: file,
                                preview: e.target.result,
                                isNew: true
                            });
                            this.newImages.push(file);
                        };
                        reader.readAsDataURL(file);
                    });
                },

                startDrag(idx) {
                    this.dragIdx = idx;
                },

                endDrag() {
                    this.dragIdx = null;
                    this.dragOverIdx = null;
                },

                handleDrop(targetIdx) {
                    if (this.dragIdx === null || this.dragIdx === targetIdx) return;
                    const item = this.productImages.splice(this.dragIdx, 1)[0];
                    this.productImages.splice(targetIdx, 0, item);
                    this.dragIdx = null;
                    this.dragOverIdx = null;
                },

                async removeImage(idx, img) {
                    if (img.isExisting && this.editingProduct) {
                        try {
                            await fetch(`/admin/api/products/${this.editingProduct.id}/images/${img.id}`, {
                                method: 'DELETE'
                            });
                        } catch (e) {
                            console.error('Failed to delete image:', e);
                            return;
                        }
                    }
                    this.productImages.splice(idx, 1);
                    if (img.isNew) {
                        const fileIdx = this.newImages.indexOf(img.file);
                        if (fileIdx > -1) this.newImages.splice(fileIdx, 1);
                    }
                },

                async saveProduct() {
                    try {
                        const price_cents = Math.round(parseFloat(this.productForm.price) * 100);
                        const productData = {
                            name: this.productForm.name,
                            description: this.productForm.description,
                            price_cents: price_cents,
                            stock_quantity: parseInt(this.productForm.stock_quantity) || 0
                        };

                        let productId = this.editingProduct?.id;

                        if (this.editingProduct) {
                            await fetch(`/admin/api/products/${productId}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(productData)
                            });
                        } else {
                            const res = await fetch('/admin/api/products', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(productData)
                            });
                            const created = await res.json();
                            productId = created.id;
                        }

                        // Upload new images
                        for (const file of this.newImages) {
                            const formData = new FormData();
                            formData.append('file', file);
                            await fetch(`/admin/api/products/${productId}/images`, {
                                method: 'POST',
                                body: formData
                            });
                        }

                        // Reorder if editing and order changed
                        if (this.editingProduct) {
                            const imageIds = this.productImages.filter(img => img.isExisting).map(img => img.id);
                            if (imageIds.length > 0) {
                                await fetch(`/admin/api/products/${productId}/images/reorder`, {
                                    method: 'PUT',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ image_ids: imageIds })
                                });
                            }
                        }

                        this.showProductModal = false;
                        this.productImages = [];
                        this.newImages = [];
                        await this.loadProducts();
                    } catch (e) {
                        console.error('Failed to save product:', e);
                    }
                },

                async toggleProductActive(product) {
                    try {
                        await fetch(`/admin/api/products/${product.id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ is_active: !product.is_active })
                        });
                        await this.loadProducts();
                    } catch (e) {
                        console.error('Failed to toggle product:', e);
                    }
                },

                async deleteProduct(id) {
                    if (!confirm('Delete this product?')) return;
                    try {
                        await fetch(`/admin/api/products/${id}`, { method: 'DELETE' });
                        await this.loadProducts();
                    } catch (e) {
                        console.error('Failed to delete product:', e);
                    }
                },

                viewOrder(order) {
                    this.selectedOrder = order;
                    this.showOrderModal = true;
                },

                async updateOrderStatus(orderId, status) {
                    try {
                        await fetch(`/admin/api/orders/${orderId}/status`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ status })
                        });
                        await this.loadOrders();
                    } catch (e) {
                        console.error('Failed to update order status:', e);
                    }
                },

                openTrackingModal(order) {
                    this.trackingOrderId = order.id;
                    this.trackingForm = { tracking_number: '', carrier: '' };
                    this.showTrackingModal = true;
                },

                async saveTracking() {
                    try {
                        await fetch(`/admin/api/orders/${this.trackingOrderId}/tracking`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.trackingForm)
                        });
                        this.showTrackingModal = false;
                        await this.loadOrders();
                    } catch (e) {
                        console.error('Failed to save tracking:', e);
                    }
                },

                async loadArtistSettings() {
                    try {
                        const res = await fetch('/admin/api/settings/artist');
                        const data = await res.json();
                        this.artistSettings = {
                            image: data.image,
                            description: data.description,
                            imagePreview: null,
                            newImageFile: null
                        };
                    } catch (e) {
                        console.error('Failed to load artist settings:', e);
                    }
                },

                async loadSiteSettings() {
                    try {
                        const res = await fetch('/admin/api/settings/favicon');
                        const data = await res.json();
                        this.favicon = data.url;
                    } catch (e) {
                        console.error('Failed to load favicon:', e);
                    }
                },

                handleFaviconSelect(event) {
                    const file = event.target.files[0];
                    if (file) {
                        this.faviconFile = file;
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            this.faviconPreview = e.target.result;
                        };
                        reader.readAsDataURL(file);
                    }
                    event.target.value = '';
                },

                async saveFavicon() {
                    if (!this.faviconFile) return;
                    this.savingFavicon = true;
                    try {
                        const formData = new FormData();
                        formData.append('file', this.faviconFile);
                        const res = await fetch('/admin/api/settings/favicon', {
                            method: 'PUT',
                            body: formData
                        });
                        const data = await res.json();
                        this.favicon = data.url;
                        this.faviconPreview = null;
                        this.faviconFile = null;
                        this.showToast('Favicon saved!', 'success');
                    } catch (e) {
                        console.error('Failed to save favicon:', e);
                        this.showToast('Failed to save favicon', 'error');
                    } finally {
                        this.savingFavicon = false;
                    }
                },

                handleArtistImageSelect(event) {
                    const file = event.target.files[0];
                    if (file) {
                        this.artistSettings.newImageFile = file;
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            this.artistSettings.imagePreview = e.target.result;
                        };
                        reader.readAsDataURL(file);
                    }
                    event.target.value = '';
                },

                async saveArtistSettings() {
                    this.savingArtist = true;
                    try {
                        // Upload new image if selected
                        if (this.artistSettings.newImageFile) {
                            const formData = new FormData();
                            formData.append('file', this.artistSettings.newImageFile);
                            await fetch('/admin/api/settings/artist/image', {
                                method: 'PUT',
                                body: formData
                            });
                        }

                        // Save description
                        await fetch('/admin/api/settings/artist', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ description: this.artistSettings.description })
                        });

                        // Reload to get updated data
                        await this.loadArtistSettings();
                    } catch (e) {
                        console.error('Failed to save artist settings:', e);
                    } finally {
                        this.savingArtist = false;
                    }
                },

                logout() {
                    window.location.href = '/';
                }
            };
        }
    </script>
</body>
</html>
