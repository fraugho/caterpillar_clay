<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caterpillar Clay - Admin</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- Clerk - reads existing session from main site login -->
    <script async crossorigin="anonymous" data-clerk-publishable-key="pk_test_Y2FyaW5nLWpheWJpcmQtODYuY2xlcmsuYWNjb3VudHMuZGV2JA" src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js" type="text/javascript"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root{
            --bg-primary:#F8F8F8;
            --bg-secondary:#FFFFFF;
            --bg-card:#FFFFFF;
            --text-primary:#18191B;
            --text-secondary:#666666;
            --accent:#97BAD9;
            --accent-hover:#7BA3C9;
            --border:#E0E0E0;
        }
        @media(prefers-color-scheme:dark){
            :root{
                --bg-primary:#18191B;
                --bg-secondary:#1E2022;
                --bg-card:#252729;
                --text-primary:#F8F8F8;
                --text-secondary:#A0A0A0;
                --accent:#97BAD9;
                --accent-hover:#AECCE8;
                --border:#333537;
            }
        }
        *{margin:0;padding:0;box-sizing:border-box;image-rendering:pixelated}
        body{font-family:'Press Start 2P',cursive;background:var(--bg-primary);color:var(--text-primary);min-height:100vh;position:relative}
        .stars{position:fixed;inset:0;pointer-events:none;z-index:0;overflow:hidden}
        .star{position:absolute;background:var(--accent);opacity:0.3}
        .star.twinkle{animation:twinkle 2s ease-in-out infinite}
        @keyframes twinkle{0%,100%{opacity:0.15}50%{opacity:0.4}}
        .container{max-width:1200px;margin:0 auto;padding:20px;position:relative;z-index:1}
        nav{background:var(--accent);padding:20px;margin-bottom:20px;position:relative;z-index:1}
        nav .inner{max-width:1200px;margin:0 auto;display:flex;justify-content:space-between;align-items:center}
        nav h1{font-size:14px;color:#18191B}
        .tabs{display:flex;gap:8px;margin-bottom:20px}
        .tab{background:var(--bg-card);color:var(--text-secondary);padding:12px 16px;font-family:inherit;font-size:8px;border:2px solid var(--border);border-radius:8px;cursor:pointer}
        .tab.active{background:var(--accent);color:#18191B;border-color:var(--accent)}
        .tab:hover{border-color:var(--accent)}
        .card{background:var(--bg-card);padding:20px;margin-bottom:20px;border:2px solid var(--border);border-radius:12px}
        .card h2{font-size:12px;margin-bottom:16px;color:var(--accent)}
        .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:20px}
        .stat{background:var(--bg-card);padding:16px;text-align:center;border:2px solid var(--border);border-radius:12px}
        .stat-value{font-size:18px;color:var(--accent);margin-bottom:8px}
        .stat-label{font-size:8px;color:var(--text-secondary)}
        table{width:100%;border-collapse:collapse;font-size:8px}
        th,td{padding:12px;text-align:left;border-bottom:1px solid var(--border)}
        th{color:var(--accent)}
        .btn{background:var(--accent);color:#18191B;padding:10px 14px;font-family:inherit;font-size:8px;border:none;cursor:pointer;border-radius:8px;transition:background .2s;-moz-appearance:none}
        .btn:not(:active):not(:focus){filter:none}
        .btn:hover{background:var(--accent-hover)}
        .btn-danger{background:#dc2626;color:#fff}
        .btn-danger:hover{background:#b91c1c}
        .btn-success{background:#16a34a;color:#fff}
        .btn-sm{padding:6px 10px;font-size:6px;border-radius:6px}
        input,textarea,select{width:100%;padding:10px;font-family:inherit;font-size:8px;margin-bottom:12px;background:var(--bg-secondary);color:var(--text-primary);border:2px solid var(--border);border-radius:8px}
        input:focus,textarea:focus,select:focus{outline:none;border-color:var(--accent)}
        .form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
        label{display:block;font-size:8px;margin-bottom:4px;color:var(--text-secondary)}
        .status{padding:4px 8px;font-size:6px;border-radius:6px}
        .status-pending{background:#eab308;color:#000}
        .status-paid{background:#22c55e;color:#000}
        .status-processing{background:#3b82f6;color:#fff}
        .status-shipped{background:#8b5cf6;color:#fff}
        .status-delivered{background:#10b981;color:#fff}
        .status-cancelled{background:#ef4444;color:#fff}
        .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;align-items:center;justify-content:center}
        .modal.active{display:flex}
        .modal-content{background:var(--bg-card);padding:24px;max-width:900px;width:90%;max-height:90vh;overflow-y:auto;border-radius:12px;border:2px solid var(--border)}
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
        .modal-header h3{font-size:10px;color:var(--accent)}
        .close-btn{background:none;border:none;color:var(--text-secondary);font-size:16px;cursor:pointer}
        .product-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:32px}
        .product-card{background:var(--bg-card);padding:24px;border:2px solid var(--border);border-radius:12px;text-align:center;transition:transform .2s,box-shadow .2s}
        .product-card:hover{transform:translateY(-4px);box-shadow:0 8px 24px rgba(0,0,0,0.1)}
        .product-card img,.product-card .placeholder-img,.product-card .carousel{width:100%;height:380px;object-fit:cover;background:var(--bg-secondary);margin-bottom:20px;border:2px solid var(--border);border-radius:8px}
        .product-card .placeholder-img{display:flex;align-items:center;justify-content:center;font-size:10px;color:var(--text-secondary)}
        .product-card h4{font-size:12px;margin-top:8px;margin-bottom:12px}
        .product-card .price{color:var(--accent);font-size:14px;margin-bottom:12px}
        .product-card .stock{font-size:10px;color:var(--text-secondary);margin-bottom:16px}
        .product-card .active-status{font-size:10px;margin-left:8px;color:var(--text-secondary)}
        .product-actions{display:flex;gap:12px;margin-top:16px;justify-content:center}
        .product-actions .btn{padding:12px 20px;font-size:10px}
        .alert{padding:12px;margin-bottom:16px;font-size:8px;border-radius:8px}
        .alert-warning{background:#fef3c7;color:#92400e}
        .alert-success{background:#d1fae5;color:#065f46}
        .toast{position:fixed;top:20px;right:20px;padding:16px 24px;border-radius:8px;font-size:10px;z-index:2000;animation:slideIn 0.3s ease;box-shadow:0 4px 12px rgba(0,0,0,0.3)}
        .toast.success{background:#22c55e;color:#fff}
        .toast.error{background:#ef4444;color:#fff}
        @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
        @keyframes pulse{0%,100%{opacity:0.4}50%{opacity:1}}
        [x-cloak]{display:none!important}
        .toggle{position:relative;display:inline-block;width:48px;height:24px}
        .toggle input{opacity:0;width:0;height:0}
        .toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:var(--border);transition:.3s;border-radius:12px}
        .toggle-slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;bottom:3px;background:var(--text-secondary);transition:.3s;border-radius:50%}
        .toggle input:checked+.toggle-slider{background:#22c55e}
        .toggle input:checked+.toggle-slider:before{transform:translateX(24px);background:#fff}
        .preview-section{display:grid;grid-template-columns:1fr 1fr;gap:24px}
        .form-section,.preview-card{padding:20px}
        .preview-card{background:var(--bg-secondary);border:2px solid var(--border);border-radius:12px;text-align:center}
        .preview-card h4{font-size:10px;margin-bottom:10px}
        .preview-card .price{color:var(--accent);font-size:12px;margin-bottom:10px}
        .preview-card .stock{font-size:8px;color:var(--text-secondary);margin-bottom:14px}
        .preview-card img,.preview-card .preview-placeholder{width:100%;height:300px;object-fit:cover;background:var(--bg-primary);border:2px solid var(--border);border-radius:8px;margin-bottom:12px}
        .preview-card .preview-placeholder{display:flex;align-items:center;justify-content:center;font-size:10px;color:var(--text-secondary)}
        .preview-btn{background:var(--accent);color:#18191B;padding:14px 20px;font-family:inherit;font-size:8px;border:none;border-radius:8px;width:100%}
        .image-upload{border:2px dashed var(--border);border-radius:8px;padding:20px;text-align:center;cursor:pointer;transition:border-color .2s}
        .image-upload:hover{border-color:var(--accent)}
        .image-upload input{display:none}
        .image-upload img{max-width:100%;max-height:200px;margin-top:12px;border-radius:8px}
        .image-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:8px;margin-top:12px}
        .image-item{position:relative;aspect-ratio:1;background:var(--bg-secondary);border:2px solid var(--border);border-radius:8px;overflow:hidden;cursor:grab}
        .image-item.dragging{opacity:0.5;border-color:var(--accent)}
        .image-item.drag-over{border-color:var(--accent);border-style:dashed}
        .image-item img{width:100%;height:100%;object-fit:cover}
        .image-item .delete-btn{position:absolute;top:4px;right:4px;background:rgba(220,38,38,0.9);color:#fff;border:none;width:20px;height:20px;border-radius:4px;cursor:pointer;font-size:10px;display:flex;align-items:center;justify-content:center}
        .image-item .order-badge{position:absolute;bottom:4px;left:4px;background:rgba(0,0,0,0.7);color:#fff;font-size:6px;padding:2px 6px;border-radius:4px}
        .carousel{position:relative;width:100%;height:380px;overflow:hidden;border-radius:8px}
        .carousel-inner{display:flex;transition:transform 0.3s ease;height:100%}
        .carousel-inner img{min-width:100%;height:100%;object-fit:cover}
        .carousel-btn{position:absolute;top:50%;transform:translateY(-50%);background:rgba(0,0,0,0.5);color:#fff;border:none;padding:8px 12px;cursor:pointer;font-size:12px;border-radius:4px}
        .carousel-btn.prev{left:8px}
        .carousel-btn.next{right:8px}
        .carousel-dots{position:absolute;bottom:8px;left:50%;transform:translateX(-50%);display:flex;gap:4px}
        .carousel-dot{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,0.5);border:none;cursor:pointer}
        .carousel-dot.active{background:#fff}
        @media(max-width:768px){.preview-section{grid-template-columns:1fr}}
    </style>
</head>
<body x-data="admin()">
    <div class="stars" id="stars"></div>

    <!-- Toast Notification -->
    <div class="toast" :class="toast.type" x-show="toast.show" x-cloak x-text="toast.message" x-transition.duration.300ms></div>

    <nav>
        <div class="inner">
            <h1>CATERPILLAR CLAY ADMIN</h1>
            <button type="button" autocomplete="off" class="btn" style="font-size:10px;padding:12px 16px" @click.prevent="logout($event)">LOGOUT</button>
        </div>
    </nav>

    <div class="container">
        <div class="tabs">
            <button class="tab" :class="{ active: tab === 'dashboard' }" @click="tab = 'dashboard'">DASHBOARD</button>
            <button class="tab" :class="{ active: tab === 'products' }" @click="tab = 'products'; loadProducts()">PRODUCTS</button>
            <button class="tab" :class="{ active: tab === 'orders' }" @click="tab = 'orders'; loadOrders()">ORDERS</button>
            <button class="tab" :class="{ active: tab === 'artist' }" @click="tab = 'artist'; loadArtistSettings()">ABOUT ME</button>
            <button class="tab" :class="{ active: tab === 'site' }" @click="tab = 'site'; loadSiteSettings()">SITE</button>
            <button class="tab" :class="{ active: tab === 'shipping' }" @click="tab = 'shipping'; loadShippingSettings()">SHIPPING</button>
        </div>

        <!-- Dashboard -->
        <template x-if="tab === 'dashboard'">
            <div>
                <div class="stats">
                    <div class="stat">
                        <div class="stat-value" x-text="dashboard.total_orders || 0"></div>
                        <div class="stat-label">TOTAL ORDERS</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">$<span x-text="(dashboard.total_revenue || 0).toFixed(2)"></span></div>
                        <div class="stat-label">TOTAL REVENUE</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" x-text="dashboard.total_products || 0"></div>
                        <div class="stat-label">PRODUCTS</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" x-text="subscriberCount"></div>
                        <div class="stat-label">SUBSCRIBERS</div>
                    </div>
                </div>

                <template x-if="dashboard.low_stock_products && dashboard.low_stock_products.length">
                    <div class="card">
                        <h2>LOW STOCK ALERTS</h2>
                        <template x-for="p in dashboard.low_stock_products" :key="p.id">
                            <div class="alert alert-warning">
                                <span x-text="p.name"></span> - Only <span x-text="p.stock_quantity"></span> left
                            </div>
                        </template>
                    </div>
                </template>

                <div class="card">
                    <h2>RECENT ORDERS</h2>
                    <table>
                        <thead>
                            <tr><th>ID</th><th>STATUS</th><th>TOTAL</th><th>DATE</th></tr>
                        </thead>
                        <tbody>
                            <template x-for="o in dashboard.recent_orders || []" :key="o.id">
                                <tr>
                                    <td x-text="o.id.substring(0,8)"></td>
                                    <td><span class="status" :class="'status-' + o.status" x-text="o.status.toUpperCase()"></span></td>
                                    <td>$<span x-text="o.total.toFixed(2)"></span></td>
                                    <td x-text="new Date(o.created_ts * 1000).toLocaleDateString()"></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </template>

        <!-- Products -->
        <template x-if="tab === 'products'">
            <div>
                <div style="display:flex;gap:12px;margin-bottom:16px;align-items:center;flex-wrap:wrap">
                    <button class="btn" @click="openProductModal()">+ ADD PRODUCT</button>
                    <template x-if="hasPendingChanges">
                        <button class="btn btn-success" @click="openReviewModal()">
                            REVIEW & SAVE (<span x-text="Object.keys(pendingChanges).length"></span> changes)
                        </button>
                    </template>
                    <template x-if="hasPendingChanges">
                        <button class="btn" style="background:var(--border);color:var(--text-primary)" @click="discardChanges()">DISCARD</button>
                    </template>
                    <span style="font-size:8px;color:var(--text-secondary)">Subscribers: <span x-text="subscriberCount"></span></span>
                </div>

                <div class="product-grid">
                    <template x-for="p in products" :key="p.id">
                        <div class="product-card" style="position:relative" x-data="{ carouselIdx: 0, editing: false, imgLoaded: false }" :style="{ borderColor: pendingChanges[p.id] ? '#f59e0b' : 'var(--border)', borderWidth: pendingChanges[p.id] ? '3px' : '2px' }">
                            <template x-if="pendingChanges[p.id]">
                                <div style="position:absolute;top:8px;right:8px;background:#f59e0b;color:#000;font-size:6px;padding:4px 8px;border-radius:4px;z-index:10">MODIFIED</div>
                            </template>
                            <template x-if="p.images && p.images.length > 0">
                                <div class="carousel" style="position:relative">
                                    <!-- Loading skeleton -->
                                    <div x-show="!imgLoaded" style="position:absolute;inset:0;background:var(--bg-secondary);display:flex;align-items:center;justify-content:center;border-radius:6px">
                                        <span style="font-size:8px;color:var(--text-secondary);animation:pulse 1.5s infinite">Loading...</span>
                                    </div>
                                    <div class="carousel-inner" :style="`transform: translateX(-${carouselIdx * 100}%); opacity: ${imgLoaded ? 1 : 0}; transition: opacity 0.3s`">
                                        <template x-for="(img, imgIdx) in p.images" :key="img.id">
                                            <img :src="img.image_url" :alt="p.name" @load="if(imgIdx === 0) imgLoaded = true">
                                        </template>
                                    </div>
                                    <template x-if="p.images.length > 1">
                                        <button class="carousel-btn prev" @click="carouselIdx = (carouselIdx - 1 + p.images.length) % p.images.length">&lt;</button>
                                    </template>
                                    <template x-if="p.images.length > 1">
                                        <button class="carousel-btn next" @click="carouselIdx = (carouselIdx + 1) % p.images.length">&gt;</button>
                                    </template>
                                    <template x-if="p.images.length > 1">
                                        <div class="carousel-dots">
                                            <template x-for="(img, idx) in p.images" :key="img.id">
                                                <button class="carousel-dot" :class="{ active: idx === carouselIdx }" @click="carouselIdx = idx"></button>
                                            </template>
                                        </div>
                                    </template>
                                </div>
                            </template>
                            <template x-if="!p.images || p.images.length === 0">
                                <div class="placeholder-img">[NO IMAGE]</div>
                            </template>

                            <!-- Inline editing -->
                            <template x-if="!editing">
                                <div>
                                    <h4 x-text="p.name"></h4>
                                    <div class="price">$<span x-text="p.price.toFixed(2)"></span></div>
                                    <div class="stock" x-text="getStockDisplay(p)"></div>
                                </div>
                            </template>
                            <template x-if="editing">
                                <div style="text-align:left;padding:0 8px">
                                    <label style="font-size:6px">Name</label>
                                    <input type="text" x-model="p.name" @input="trackChange(p, 'name', p.name)" style="margin-bottom:8px">
                                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                                        <div>
                                            <label style="font-size:6px">Price ($)</label>
                                            <input type="number" step="0.01" :value="p.price" @input="p.price = parseFloat($event.target.value) || 0; trackChange(p, 'price_cents', Math.round(p.price * 100))" style="margin-bottom:8px">
                                        </div>
                                        <div>
                                            <label style="font-size:6px">Stock</label>
                                            <input type="number" x-model.number="p.stock_quantity" @input="trackChange(p, 'stock_quantity', p.stock_quantity)" style="margin-bottom:8px">
                                        </div>
                                    </div>
                                </div>
                            </template>

                            <div style="margin-top:12px;display:flex;align-items:center;justify-content:center">
                                <label class="toggle">
                                    <input type="checkbox" :checked="p.is_active" @change="p.is_active = !p.is_active; trackChange(p, 'is_active', p.is_active)">
                                    <span class="toggle-slider"></span>
                                </label>
                                <span class="active-status" x-text="p.is_active ? 'Active' : 'Inactive'"></span>
                            </div>
                            <div class="product-actions" style="flex-wrap:wrap">
                                <button class="btn btn-sm" @click="editing = !editing" x-text="editing ? 'DONE' : 'EDIT'"></button>
                                <button class="btn btn-sm" @click="editProduct(p)">IMAGES</button>
                                <button class="btn btn-sm" @click="openStylesModal(p)">STYLES</button>
                                <button class="btn btn-sm btn-danger" @click="deleteProduct(p.id)">DELETE</button>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </template>

        <!-- Orders -->
        <template x-if="tab === 'orders'">
            <div class="card">
                <h2>ALL ORDERS</h2>
                <table>
                    <thead>
                        <tr><th>ID</th><th>CUSTOMER</th><th>STATUS</th><th>TOTAL</th><th>DATE</th><th>ACTIONS</th></tr>
                    </thead>
                    <tbody>
                        <template x-for="o in orders" :key="o.id">
                            <tr>
                                <td x-text="o.id.substring(0, 8)"></td>
                                <td x-text="o.user ? o.user.email : 'Guest'"></td>
                                <td>
                                    <select class="btn btn-sm" :value="o.status" @change="updateOrderStatus(o.id, $event.target.value)" style="width: auto;">
                                        <option value="pending">Pending</option>
                                        <option value="paid">Paid</option>
                                        <option value="processing">Processing</option>
                                        <option value="shipped">Shipped</option>
                                        <option value="delivered">Delivered</option>
                                        <option value="cancelled">Cancelled</option>
                                        <option value="refunded">Refunded</option>
                                    </select>
                                </td>
                                <td>$<span x-text="o.total.toFixed(2)"></span></td>
                                <td x-text="new Date(o.created_ts * 1000).toLocaleDateString()"></td>
                                <td>
                                    <button class="btn btn-sm" @click="viewOrder(o)">VIEW</button>
                                    <template x-if="!o.label_url && !o.tracking_number && ['paid', 'processing'].includes(o.status)">
                                        <button class="btn btn-sm" style="background:#8b5cf6;color:#fff" @click="openBuyLabelModal(o)">BUY LABEL</button>
                                    </template>
                                    <template x-if="o.label_url">
                                        <a :href="o.label_url" target="_blank" class="btn btn-sm btn-success" style="text-decoration:none">PRINT LABEL</a>
                                    </template>
                                    <template x-if="!o.tracking_number && !o.label_url && o.status !== 'pending' && o.status !== 'refunded'">
                                        <button class="btn btn-sm btn-success" @click="openTrackingModal(o)">ADD TRACKING</button>
                                    </template>
                                    <template x-if="o.stripe_payment_intent_id && ['paid', 'processing', 'shipped', 'delivered'].includes(o.status)">
                                        <button class="btn btn-sm btn-danger" @click="refundOrder(o)" style="background:#dc2626;">REFUND</button>
                                    </template>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </template>

        <!-- Artist -->
        <template x-if="tab === 'artist'">
            <div>
                <div class="card">
                    <h2>ABOUT ME</h2>
                    <div class="preview-section">
                        <div class="form-section">
                            <form @submit.prevent="saveArtistSettings()">
                                <label>Photo</label>
                                <div class="image-upload" @click="$refs.artistImageInput.click()">
                                    <input type="file" x-ref="artistImageInput" @change="handleArtistImageSelect($event)" accept="image/*">
                                    <template x-if="artistSettings.image">
                                        <img :src="artistSettings.imagePreview || artistSettings.image" style="max-height:200px;border-radius:8px">
                                    </template>
                                    <template x-if="!artistSettings.image">
                                        <p style="font-size:8px;color:var(--text-secondary)">Click to upload artist image</p>
                                    </template>
                                </div>

                                <label style="margin-top:16px">Bio</label>
                                <textarea x-model="artistSettings.description" rows="6" style="min-height:150px"></textarea>

                                <button type="submit" class="btn" style="width: 100%; margin-top: 8px;" :disabled="savingArtist">
                                    <span x-text="savingArtist ? 'SAVING...' : 'SAVE'"></span>
                                </button>
                            </form>
                        </div>
                        <div class="preview-card">
                            <p style="font-size:8px;color:var(--text-secondary);margin-bottom:12px">ABOUT ME PAGE PREVIEW</p>
                            <template x-if="artistSettings.imagePreview || artistSettings.image">
                                <img :src="artistSettings.imagePreview || artistSettings.image" style="width:100%;max-height:300px;object-fit:cover;border-radius:8px;margin-bottom:12px">
                            </template>
                            <template x-if="!artistSettings.imagePreview && !artistSettings.image">
                                <div class="preview-placeholder">[ARTIST IMAGE]</div>
                            </template>
                            <div style="background:var(--accent);border-radius:8px;padding:16px;margin-top:12px">
                                <p style="font-size:8px;line-height:2;color:#18191B" x-text="artistSettings.description || 'Artist description will appear here...'"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </template>

        <!-- Site Settings -->
        <template x-if="tab === 'site'">
            <div>
                <div class="card">
                    <h2>FAVICON</h2>
                    <div style="display:flex;align-items:center;gap:20px">
                        <div class="image-upload" style="width:100px;height:100px;padding:10px" @click="$refs.faviconInput.click()">
                            <input type="file" x-ref="faviconInput" @change="handleFaviconSelect($event)" accept="image/png,image/x-icon">
                            <template x-if="faviconPreview || favicon">
                                <img :src="faviconPreview || favicon" style="width:64px;height:64px;object-fit:contain">
                            </template>
                            <template x-if="!faviconPreview && !favicon">
                                <p style="font-size:6px;color:var(--text-secondary);text-align:center">Click to upload</p>
                            </template>
                        </div>
                        <div>
                            <p style="font-size:8px;color:var(--text-secondary);margin-bottom:8px">Upload a PNG image (32x32 recommended)</p>
                            <button class="btn btn-sm" @click="saveFavicon()" :disabled="!faviconFile || savingFavicon">
                                <span x-text="savingFavicon ? 'SAVING...' : 'SAVE FAVICON'"></span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </template>

        <!-- Shipping Settings -->
        <template x-if="tab === 'shipping'">
            <div>
                <div class="card">
                    <h2>SHIP FROM ADDRESS</h2>
                    <p style="font-size:8px;color:var(--text-secondary);margin-bottom:16px">This is the origin address used to calculate shipping rates.</p>
                    <form @submit.prevent="saveShopAddress()">
                        <label>Business / Shop Name</label>
                        <input type="text" x-model="shippingSettings.address.name" required>

                        <label>Street Address</label>
                        <input type="text" x-model="shippingSettings.address.street1" required>

                        <label>Apt / Suite (optional)</label>
                        <input type="text" x-model="shippingSettings.address.street2">

                        <div class="form-row">
                            <div>
                                <label>City</label>
                                <input type="text" x-model="shippingSettings.address.city" required>
                            </div>
                            <div>
                                <label>State / Province</label>
                                <input type="text" x-model="shippingSettings.address.state" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div>
                                <label>ZIP / Postal Code</label>
                                <input type="text" x-model="shippingSettings.address.zip" required>
                            </div>
                            <div>
                                <label>Country Code</label>
                                <input type="text" x-model="shippingSettings.address.country" placeholder="US" required>
                            </div>
                        </div>

                        <label>Phone (optional)</label>
                        <input type="tel" x-model="shippingSettings.address.phone">

                        <button type="submit" class="btn" style="width:100%;margin-top:8px" :disabled="savingShipping">
                            <span x-text="savingShipping ? 'SAVING...' : 'SAVE ADDRESS'"></span>
                        </button>
                    </form>
                </div>

                <div class="card">
                    <h2>UNIT SYSTEM</h2>
                    <p style="font-size:8px;color:var(--text-secondary);margin-bottom:16px">Choose the measurement system for product weights and dimensions.</p>
                    <div style="display:flex;gap:12px;flex-wrap:wrap">
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:12px 16px;background:var(--bg-secondary);border:2px solid var(--border);border-radius:8px" :style="{ borderColor: shippingSettings.unit_system === 'metric' ? 'var(--accent)' : 'var(--border)' }">
                            <input type="radio" name="unit_system" value="metric" x-model="shippingSettings.unit_system" @change="saveUnitSystem()" style="width:auto;margin:0">
                            <span style="font-size:10px">Metric (g, cm)</span>
                        </label>
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:12px 16px;background:var(--bg-secondary);border:2px solid var(--border);border-radius:8px" :style="{ borderColor: shippingSettings.unit_system === 'us' ? 'var(--accent)' : 'var(--border)' }">
                            <input type="radio" name="unit_system" value="us" x-model="shippingSettings.unit_system" @change="saveUnitSystem()" style="width:auto;margin:0">
                            <span style="font-size:10px">US (oz, in)</span>
                        </label>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <!-- Product Modal -->
    <div class="modal" :class="{ active: showProductModal }">
        <div class="modal-content">
            <div class="modal-header">
                <h3 x-text="editingProduct ? 'EDIT PRODUCT' : 'ADD PRODUCT'"></h3>
                <button class="close-btn" @click="showProductModal = false">&times;</button>
            </div>
            <div class="preview-section">
                <div class="form-section">
                    <form @submit.prevent="saveProduct()">
                        <label>Product Images <span style="font-size:6px;color:var(--text-secondary)">(drag to reorder)</span></label>
                        <div class="image-upload" @click="$refs.imageInput.click()" @dragover.prevent @drop.prevent="handleImageDrop($event)">
                            <input type="file" x-ref="imageInput" @change="handleImageSelect($event)" accept="image/*" multiple>
                            <p style="font-size:8px;color:var(--text-secondary)">Click or drop images here</p>
                        </div>

                        <template x-if="productImages.length > 0">
                            <div class="image-grid">
                                <template x-for="(img, idx) in productImages" :key="img.id || idx">
                                    <div class="image-item"
                                         :class="{ dragging: dragIdx === idx, 'drag-over': dragOverIdx === idx }"
                                         draggable="true"
                                         @dragstart="startDrag(idx)"
                                         @dragend="endDrag()"
                                         @dragover.prevent="dragOverIdx = idx"
                                         @dragleave="dragOverIdx = null"
                                         @drop.prevent="handleDrop(idx)">
                                        <img :src="img.image_url || img.preview" :alt="'Image ' + (idx + 1)">
                                        <button type="button" class="delete-btn" @click.stop="removeImage(idx, img)">&times;</button>
                                        <span class="order-badge" x-text="idx + 1"></span>
                                    </div>
                                </template>
                            </div>
                        </template>

                        <label style="margin-top:16px">Name</label>
                        <input type="text" x-model="productForm.name" required>

                        <label>Description</label>
                        <textarea x-model="productForm.description" rows="3"></textarea>

                        <div class="form-row">
                            <div>
                                <label>Price ($)</label>
                                <input type="number" step="0.01" x-model="productForm.price" required>
                            </div>
                            <div>
                                <label>Stock</label>
                                <input type="number" x-model="productForm.stock_quantity">
                            </div>
                        </div>

                        <p style="font-size:8px;color:var(--accent);margin:16px 0 8px">SHIPPING DIMENSIONS (optional)</p>
                        <div class="form-row">
                            <div>
                                <label>Weight (g)</label>
                                <input type="number" x-model.number="productForm.weight_grams" placeholder="500">
                            </div>
                            <div>
                                <label>Length (cm)</label>
                                <input type="number" step="0.1" x-model.number="productForm.length_cm" placeholder="15">
                            </div>
                        </div>
                        <div class="form-row">
                            <div>
                                <label>Width (cm)</label>
                                <input type="number" step="0.1" x-model.number="productForm.width_cm" placeholder="15">
                            </div>
                            <div>
                                <label>Height (cm)</label>
                                <input type="number" step="0.1" x-model.number="productForm.height_cm" placeholder="10">
                            </div>
                        </div>
                        <p style="font-size:6px;color:var(--text-secondary);margin-bottom:12px">If not set, defaults to 500g and 15x15x10cm for shipping calculations.</p>

                        <button type="submit" class="btn" style="width: 100%; margin-top: 8px;">SAVE PRODUCT</button>
                    </form>
                </div>
                <div class="preview-card" x-data="{ previewIdx: 0 }">
                    <p style="font-size:8px;color:var(--text-secondary);margin-bottom:12px">LISTING PREVIEW</p>
                    <template x-if="productImages.length > 0">
                        <div class="carousel" style="height:300px">
                            <div class="carousel-inner" :style="`transform: translateX(-${previewIdx * 100}%)`">
                                <template x-for="img in productImages" :key="img.id || img.preview">
                                    <img :src="img.image_url || img.preview" alt="Preview">
                                </template>
                            </div>
                            <template x-if="productImages.length > 1">
                                <button class="carousel-btn prev" @click="previewIdx = (previewIdx - 1 + productImages.length) % productImages.length">&lt;</button>
                            </template>
                            <template x-if="productImages.length > 1">
                                <button class="carousel-btn next" @click="previewIdx = (previewIdx + 1) % productImages.length">&gt;</button>
                            </template>
                        </div>
                    </template>
                    <template x-if="productImages.length === 0">
                        <div class="preview-placeholder">[IMAGE]</div>
                    </template>
                    <h4 x-text="productForm.name || 'Product Name'"></h4>
                    <div class="price">$<span x-text="(parseFloat(productForm.price) || 0).toFixed(2)"></span></div>
                    <div class="stock" x-text="productForm.stock_quantity > 0 ? 'In Stock' : 'Out of Stock'"></div>
                    <button class="preview-btn" disabled>ADD TO CART</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Detail Modal -->
    <div class="modal" :class="{ active: showOrderModal }">
        <div class="modal-content" style="max-width:500px">
            <div class="modal-header">
                <h3>ORDER DETAILS</h3>
                <button class="close-btn" @click="showOrderModal = false">&times;</button>
            </div>
            <template x-if="selectedOrder">
                <div>
                    <p style="font-size: 8px; margin-bottom: 8px;"><strong>ID:</strong> <span x-text="selectedOrder.id"></span></p>
                    <p style="font-size: 8px; margin-bottom: 8px;"><strong>Status:</strong> <span x-text="selectedOrder.status"></span></p>
                    <p style="font-size: 8px; margin-bottom: 8px;"><strong>Total:</strong> $<span x-text="selectedOrder.total.toFixed(2)"></span></p>

                    <template x-if="selectedOrder.shipping_address">
                        <div style="margin-bottom: 12px;">
                            <p style="font-size: 8px; color: var(--accent); margin-bottom: 4px;">SHIPPING ADDRESS</p>
                            <p style="font-size: 8px;" x-text="selectedOrder.shipping_address.name"></p>
                            <p style="font-size: 8px;" x-text="selectedOrder.shipping_address.street"></p>
                            <p style="font-size: 8px;" x-text="`${selectedOrder.shipping_address.city}, ${selectedOrder.shipping_address.state} ${selectedOrder.shipping_address.zip}`"></p>
                        </div>
                    </template>

                    <template x-if="selectedOrder.tracking_number">
                        <p style="font-size: 8px; margin-bottom: 8px;"><strong>Tracking:</strong> <span x-text="selectedOrder.tracking_number"></span></p>
                    </template>

                    <template x-if="selectedOrder.label_url">
                        <p style="font-size: 8px; margin-bottom: 8px;"><strong>Label:</strong> <a :href="selectedOrder.label_url" target="_blank" style="color:var(--accent)">Download PDF</a></p>
                    </template>

                    <template x-if="selectedOrder.shipping_carrier || selectedOrder.shipping_service">
                        <p style="font-size: 8px; margin-bottom: 8px;"><strong>Shipping:</strong> <span x-text="(selectedOrder.shipping_carrier || '') + ' ' + (selectedOrder.shipping_service || '')"></span></p>
                    </template>

                    <p style="font-size: 8px; color: var(--accent); margin: 12px 0 4px;">ITEMS</p>
                    <template x-for="item in selectedOrder.items" :key="item.product_id">
                        <p style="font-size: 8px; margin-bottom: 4px;">
                            <span x-text="item.product_name"></span> x<span x-text="item.quantity"></span> - $<span x-text="(item.price_cents / 100).toFixed(2)"></span>
                        </p>
                    </template>
                </div>
            </template>
        </div>
    </div>

    <!-- Tracking Modal -->
    <div class="modal" :class="{ active: showTrackingModal }">
        <div class="modal-content" style="max-width:400px">
            <div class="modal-header">
                <h3>ADD TRACKING</h3>
                <button class="close-btn" @click="showTrackingModal = false">&times;</button>
            </div>
            <form @submit.prevent="saveTracking()">
                <label>Tracking Number</label>
                <input type="text" x-model="trackingForm.tracking_number" required>

                <label>Carrier (optional)</label>
                <input type="text" x-model="trackingForm.carrier" placeholder="USPS, FedEx, UPS...">

                <button type="submit" class="btn" style="width: 100%; margin-top: 8px;">SAVE TRACKING</button>
            </form>
        </div>
    </div>

    <!-- Buy Label Modal -->
    <div class="modal" :class="{ active: showBuyLabelModal }">
        <div class="modal-content" style="max-width:500px">
            <div class="modal-header">
                <h3>BUY SHIPPING LABEL</h3>
                <button class="close-btn" @click="showBuyLabelModal = false">&times;</button>
            </div>
            <template x-if="labelOrderId">
                <div>
                    <template x-if="loadingLabelRates">
                        <p style="font-size:10px;text-align:center;padding:20px">Loading shipping rates...</p>
                    </template>
                    <template x-if="!loadingLabelRates && labelRates.length === 0">
                        <p style="font-size:10px;text-align:center;padding:20px;color:#ef4444">No shipping rates available. Make sure shop address is configured.</p>
                    </template>
                    <template x-if="!loadingLabelRates && labelRates.length > 0">
                        <div>
                            <p style="font-size:8px;color:var(--text-secondary);margin-bottom:12px">Select a shipping option:</p>
                            <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:16px;max-height:300px;overflow-y:auto">
                                <template x-for="rate in labelRates" :key="rate.rate_id">
                                    <label style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg-secondary);border:2px solid var(--border);border-radius:8px;cursor:pointer" :style="{ borderColor: selectedLabelRate && selectedLabelRate.rate_id === rate.rate_id ? 'var(--accent)' : 'var(--border)' }" @click="selectedLabelRate = rate">
                                        <input type="radio" name="label_rate" :value="rate.rate_id" :checked="selectedLabelRate && selectedLabelRate.rate_id === rate.rate_id" style="width:auto;margin:0">
                                        <div style="flex:1">
                                            <p style="font-size:9px;margin-bottom:2px"><span x-text="rate.carrier"></span> - <span x-text="rate.service"></span></p>
                                            <p style="font-size:7px;color:var(--text-secondary)" x-text="rate.estimated_days ? 'Est. ' + rate.estimated_days + ' days' : ''"></p>
                                        </div>
                                        <p style="font-size:10px;color:var(--accent)">$<span x-text="(rate.price_cents / 100).toFixed(2)"></span></p>
                                    </label>
                                </template>
                            </div>
                            <button class="btn" style="width:100%" @click="purchaseLabel()" :disabled="!selectedLabelRate || purchasingLabel">
                                <span x-text="purchasingLabel ? 'PURCHASING...' : 'PURCHASE LABEL'"></span>
                            </button>
                        </div>
                    </template>
                </div>
            </template>
        </div>
    </div>

    <!-- Review Changes Modal -->
    <div class="modal" :class="{ active: showReviewModal }">
        <div class="modal-content" style="max-width:700px">
            <div class="modal-header">
                <h3>REVIEW CHANGES</h3>
                <button class="close-btn" @click="showReviewModal = false">&times;</button>
            </div>

            <!-- Changes List -->
            <div style="margin-bottom:20px">
                <h4 style="font-size:10px;color:var(--accent);margin-bottom:12px">CHANGES TO SAVE</h4>
                <template x-for="change in changesList" :key="change.id">
                    <div style="background:var(--bg-secondary);padding:12px;margin-bottom:8px;border-radius:8px;border:2px solid var(--border)">
                        <p style="font-size:10px;font-weight:bold;margin-bottom:8px" x-text="change.name"></p>
                        <template x-for="(val, field) in change.changes" :key="field">
                            <p style="font-size:8px;color:var(--text-secondary)">
                                <span x-text="field.replace('_', ' ').replace('cents', '')"></span>:
                                <span style="color:#ef4444" x-text="field === 'price_cents' ? '$' + (val.from / 100).toFixed(2) : val.from"></span>
                                â†’
                                <span style="color:#22c55e" x-text="field === 'price_cents' ? '$' + (val.to / 100).toFixed(2) : val.to"></span>
                            </p>
                        </template>
                        <template x-if="change.wasOutOfStock && change.newStock > 0">
                            <p style="font-size:8px;color:#f59e0b;margin-top:4px">âš¡ RESTOCK - will notify customers</p>
                        </template>
                    </div>
                </template>
            </div>

            <!-- Email Preview Section -->
            <template x-if="restockedProducts.length > 0">
                <div style="margin-bottom:20px">
                    <h4 style="font-size:10px;color:#f59e0b;margin-bottom:12px">ðŸ“§ RESTOCK EMAILS WILL BE SENT</h4>
                    <div style="background:var(--bg-secondary);padding:16px;border-radius:8px;border:2px solid #f59e0b">
                        <p style="font-size:8px;color:var(--text-secondary);margin-bottom:8px">
                            Customers who clicked "Notify Me" will receive emails for:
                        </p>
                        <template x-for="p in restockedProducts" :key="p.id">
                            <p style="font-size:9px;margin-bottom:4px">â€¢ <span x-text="p.name"></span></p>
                        </template>
                    </div>
                </div>
            </template>

            <template x-if="newProducts.length > 0">
                <div style="margin-bottom:20px">
                    <h4 style="font-size:10px;color:#22c55e;margin-bottom:12px">ðŸ“§ NEW PRODUCT EMAILS WILL BE SENT</h4>
                    <div style="background:var(--bg-secondary);padding:16px;border-radius:8px;border:2px solid #22c55e">
                        <p style="font-size:8px;color:var(--text-secondary);margin-bottom:8px">
                            <span x-text="subscriberCount"></span> newsletter subscribers will be notified about:
                        </p>
                        <template x-for="p in newProducts" :key="p.id">
                            <p style="font-size:9px;margin-bottom:4px">â€¢ <span x-text="p.name"></span></p>
                        </template>
                    </div>
                </div>
            </template>

            <!-- Action Buttons -->
            <div style="display:flex;gap:12px;flex-wrap:wrap">
                <button class="btn" style="flex:1;background:var(--border);color:var(--text-primary)" @click="showReviewModal = false">CANCEL</button>
                <button class="btn" style="flex:1" @click="saveAllChanges(false)" :disabled="savingChanges">
                    <span x-text="savingChanges ? 'SAVING...' : 'SAVE WITHOUT EMAILS'"></span>
                </button>
                <template x-if="restockedProducts.length > 0 || newProducts.length > 0">
                    <button class="btn btn-success" style="flex:1" @click="saveAllChanges(true)" :disabled="savingChanges">
                        <span x-text="savingChanges ? 'SAVING...' : 'SAVE & SEND EMAILS'"></span>
                    </button>
                </template>
            </div>
        </div>
    </div>

    <!-- Styles Modal -->
    <div class="modal" :class="{ active: showStylesModal }">
        <div class="modal-content" style="max-width:700px">
            <div class="modal-header">
                <h3 x-text="stylesProduct ? 'STYLES: ' + stylesProduct.name : 'STYLES'"></h3>
                <button class="close-btn" @click="showStylesModal = false">&times;</button>
            </div>

            <template x-if="stylesProduct">
                <div>
                    <!-- Add New Style -->
                    <div style="background:var(--bg-secondary);padding:16px;border-radius:8px;margin-bottom:20px;border:2px solid var(--border)">
                        <h4 style="font-size:10px;color:var(--accent);margin-bottom:12px">ADD NEW STYLE</h4>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                            <!-- Form fields -->
                            <div>
                                <div style="display:grid;grid-template-columns:2fr 1fr;gap:12px;margin-bottom:12px">
                                    <div>
                                        <label style="font-size:6px">Name</label>
                                        <input type="text" x-model="newStyleName" placeholder="e.g., Small Caterpillar" style="margin-bottom:0">
                                    </div>
                                    <div>
                                        <label style="font-size:6px">Stock</label>
                                        <input type="number" x-model.number="newStyleStock" style="margin-bottom:0">
                                    </div>
                                </div>
                                <label style="font-size:6px">Select Image (click to choose)</label>
                                <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(50px,1fr));gap:6px;margin-bottom:12px;max-height:120px;overflow-y:auto;padding:4px">
                                    <!-- No image option -->
                                    <div @click="newStyleImageId = ''" style="width:50px;height:50px;background:var(--bg-primary);border-radius:4px;display:flex;align-items:center;justify-content:center;cursor:pointer;border:2px solid var(--border)" :style="{ borderColor: !newStyleImageId ? 'var(--accent)' : 'var(--border)' }">
                                        <span style="font-size:6px;color:var(--text-secondary)">None</span>
                                    </div>
                                    <template x-for="(img, idx) in stylesProduct.images" :key="img.id">
                                        <div @click="newStyleImageId = img.id" style="width:50px;height:50px;border-radius:4px;overflow:hidden;cursor:pointer;border:2px solid var(--border);position:relative" :style="{ borderColor: newStyleImageId === img.id ? 'var(--accent)' : 'var(--border)' }">
                                            <img :src="img.image_url" style="width:100%;height:100%;object-fit:cover">
                                            <span style="position:absolute;bottom:1px;right:1px;background:rgba(0,0,0,0.7);color:#fff;font-size:5px;padding:1px 3px;border-radius:2px" x-text="idx + 1"></span>
                                        </div>
                                    </template>
                                </div>
                                <button class="btn" style="width:100%" @click="addStyle()" :disabled="!newStyleName.trim() || savingStyle">ADD STYLE</button>
                            </div>
                            <!-- Image Preview -->
                            <div style="display:flex;align-items:center;justify-content:center;background:var(--bg-primary);border-radius:8px;border:2px solid var(--border);min-height:150px;padding:8px">
                                <template x-if="getImageUrlById(newStyleImageId)">
                                    <img :src="getImageUrlById(newStyleImageId)" style="max-width:100%;max-height:200px;object-fit:contain;border-radius:6px">
                                </template>
                                <template x-if="!getImageUrlById(newStyleImageId)">
                                    <span style="font-size:8px;color:var(--text-secondary);text-align:center">Select an image<br>to preview</span>
                                </template>
                            </div>
                        </div>
                    </div>

                    <!-- Existing Styles -->
                    <template x-if="stylesProduct.styles && stylesProduct.styles.length > 0">
                        <div>
                            <h4 style="font-size:10px;color:var(--accent);margin-bottom:12px">EXISTING STYLES (<span x-text="stylesProduct.styles.length"></span>) - Total: <span x-text="stylesProduct.styles.reduce((sum, s) => sum + (s.stock_quantity || 0), 0)"></span> <span style="font-size:7px;color:var(--text-secondary)">(drag to reorder)</span></h4>
                            <template x-for="(style, styleIdx) in stylesProduct.styles" :key="style.id">
                                <div x-data="{ showImagePicker: false }"
                                     draggable="true"
                                     @dragstart="styleDragIdx = styleIdx"
                                     @dragend="styleDragIdx = null; styleDragOverIdx = null"
                                     @dragover.prevent="styleDragOverIdx = styleIdx"
                                     @dragleave="if(styleDragOverIdx === styleIdx) styleDragOverIdx = null"
                                     @drop.prevent="handleStyleDrop(styleIdx)"
                                     style="background:var(--bg-secondary);padding:12px;margin-bottom:8px;border-radius:8px;border:2px solid var(--border);cursor:grab;transition:opacity 0.2s, border-color 0.2s"
                                     :style="{ opacity: styleDragIdx === styleIdx ? 0.5 : 1, borderColor: styleDragOverIdx === styleIdx ? 'var(--accent)' : 'var(--border)', borderStyle: styleDragOverIdx === styleIdx ? 'dashed' : 'solid' }">
                                    <div style="display:grid;grid-template-columns:24px 60px 2fr 80px auto auto;gap:12px;align-items:center">
                                        <!-- Drag handle -->
                                        <div style="font-size:12px;color:var(--text-secondary);cursor:grab;text-align:center">â‹®â‹®</div>
                                        <!-- Image preview thumbnail - clickable to change -->
                                        <div @click="showImagePicker = !showImagePicker" style="width:60px;height:60px;background:var(--bg-primary);border-radius:6px;overflow:hidden;display:flex;align-items:center;justify-content:center;border:2px solid var(--border);cursor:pointer" :style="{ borderColor: showImagePicker ? 'var(--accent)' : 'var(--border)' }">
                                            <template x-if="getImageUrlById(style.image_id)">
                                                <img :src="getImageUrlById(style.image_id)" style="width:100%;height:100%;object-fit:cover">
                                            </template>
                                            <template x-if="!getImageUrlById(style.image_id)">
                                                <span style="font-size:6px;color:var(--text-secondary);text-align:center">Click to<br>select</span>
                                            </template>
                                        </div>
                                        <input type="text" x-model="style.name" style="margin-bottom:0" @change="updateStyle(style)">
                                        <input type="number" x-model.number="style.stock_quantity" style="margin-bottom:0" @change="updateStyle(style)">
                                        <span :style="{ color: style.stock_quantity > 0 ? '#22c55e' : '#ef4444' }" style="font-size:8px;white-space:nowrap" x-text="style.stock_quantity > 0 ? 'In Stock' : 'Out'"></span>
                                        <button class="btn btn-sm btn-danger" @click="deleteStyle(style.id)">X</button>
                                    </div>
                                    <!-- Image picker grid -->
                                    <template x-if="showImagePicker">
                                        <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border)">
                                            <p style="font-size:8px;color:var(--text-secondary);margin-bottom:8px">Select an image:</p>
                                            <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(60px,1fr));gap:8px">
                                                <!-- No image option -->
                                                <div @click="style.image_id = ''; updateStyle(style); showImagePicker = false" style="width:60px;height:60px;background:var(--bg-primary);border-radius:6px;display:flex;align-items:center;justify-content:center;cursor:pointer;border:2px solid var(--border)" :style="{ borderColor: !style.image_id ? 'var(--accent)' : 'var(--border)' }">
                                                    <span style="font-size:6px;color:var(--text-secondary)">None</span>
                                                </div>
                                                <template x-for="(img, idx) in stylesProduct.images" :key="img.id">
                                                    <div @click="style.image_id = img.id; updateStyle(style); showImagePicker = false" style="width:60px;height:60px;border-radius:6px;overflow:hidden;cursor:pointer;border:2px solid var(--border);position:relative" :style="{ borderColor: style.image_id === img.id ? 'var(--accent)' : 'var(--border)' }">
                                                        <img :src="img.image_url" style="width:100%;height:100%;object-fit:cover">
                                                        <span style="position:absolute;bottom:2px;right:2px;background:rgba(0,0,0,0.7);color:#fff;font-size:6px;padding:1px 4px;border-radius:2px" x-text="idx + 1"></span>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </template>
                        </div>
                    </template>

                    <template x-if="!stylesProduct.styles || stylesProduct.styles.length === 0">
                        <p style="font-size:10px;color:var(--text-secondary);text-align:center;padding:20px">No styles yet. Add one above.</p>
                    </template>
                </div>
            </template>

            <div style="margin-top:20px">
                <button class="btn" style="width:100%" @click="showStylesModal = false">DONE</button>
            </div>
        </div>
    </div>

    <script>
        // Fix Firefox bfcache restoring button states
        window.addEventListener('pageshow', function(e) {
            if (e.persisted) {
                document.querySelectorAll('button').forEach(b => b.blur());
            }
        });

        // Generate pixel stars
        (function generateStars(){
            const container=document.getElementById('stars');
            const sizes=[2,3,4,6,8];
            for(let i=0;i<40;i++){
                const star=document.createElement('div');
                star.className='star'+(Math.random()>0.6?' twinkle':'');
                const size=sizes[Math.floor(Math.random()*sizes.length)];
                star.style.width=size+'px';
                star.style.height=size+'px';
                star.style.left=Math.random()*100+'%';
                star.style.top=Math.random()*100+'%';
                star.style.animationDelay=Math.random()*2+'s';
                container.appendChild(star);
            }
        })();

        function admin() {
            const validTabs = ['dashboard', 'products', 'orders', 'artist', 'site', 'shipping'];
            const savedTab = localStorage.getItem('adminTab');
            return {
                tab: (savedTab && validTabs.includes(savedTab)) ? savedTab : 'dashboard',
                dashboard: {},
                products: [],
                orders: [],
                showProductModal: false,
                showOrderModal: false,
                showTrackingModal: false,
                showBuyLabelModal: false,
                labelOrderId: null,
                labelRates: [],
                selectedLabelRate: null,
                loadingLabelRates: false,
                purchasingLabel: false,
                editingProduct: null,
                selectedOrder: null,
                trackingOrderId: null,
                productForm: { name: '', description: '', price: 0, stock_quantity: 0, weight_grams: null, length_cm: null, width_cm: null, height_cm: null },
                trackingForm: { tracking_number: '', carrier: '' },
                productImages: [],
                newImages: [],
                dragIdx: null,
                dragOverIdx: null,
                artistSettings: { image: '', description: '', imagePreview: null, newImageFile: null },
                savingArtist: false,
                subscriberCount: 0,
                toast: { show: false, message: '', type: 'success' },
                favicon: null,
                // Change tracking
                originalProducts: {},
                pendingChanges: {},
                showReviewModal: false,
                savingChanges: false,
                faviconPreview: null,
                faviconFile: null,
                savingFavicon: false,
                // Styles modal
                showStylesModal: false,
                stylesProduct: null,
                newStyleName: '',
                newStyleStock: 0,
                newStyleImageId: '',
                savingStyle: false,
                styleDragIdx: null,
                styleDragOverIdx: null,
                // Shipping settings
                shippingSettings: {
                    address: { name: '', street1: '', street2: '', city: '', state: '', zip: '', country: 'US', phone: '' },
                    unit_system: 'metric'
                },
                savingShipping: false,

                // Auth helper - gets token from Clerk session and adds to request
                async authFetch(url, options = {}) {
                    // Wait for Clerk to load if needed
                    if (!window.Clerk) {
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                    if (!window.Clerk) {
                        throw new Error('Auth not loaded');
                    }
                    await window.Clerk.load();

                    if (!window.Clerk.session) {
                        // Not logged in - redirect to main site
                        window.location.href = '/?login=admin';
                        throw new Error('Not authenticated');
                    }

                    const token = await window.Clerk.session.getToken();
                    const headers = {
                        ...options.headers,
                        'Authorization': `Bearer ${token}`
                    };
                    return fetch(url, { ...options, headers });
                },

                async init() {
                    // Always load subscriber count for notifications
                    await this.loadSubscriberCount();

                    // Load data for saved tab
                    if (this.tab === 'products') {
                        await this.loadProducts();
                    } else if (this.tab === 'orders') {
                        await this.loadOrders();
                    } else if (this.tab === 'artist') {
                        await this.loadArtistSettings();
                    } else if (this.tab === 'site') {
                        await this.loadSiteSettings();
                    } else if (this.tab === 'shipping') {
                        await this.loadShippingSettings();
                    } else {
                        await this.loadDashboard();
                    }

                    // Watch for tab changes and save to localStorage
                    this.$watch('tab', (value) => {
                        localStorage.setItem('adminTab', value);
                    });
                },

                async loadDashboard() {
                    try {
                        const res = await this.authFetch('/gallium/api/dashboard');
                        this.dashboard = await res.json();
                    } catch (e) {
                        console.error('Failed to load dashboard:', e);
                    }
                },

                async loadSubscriberCount() {
                    try {
                        const res = await this.authFetch('/gallium/api/newsletter/subscribers');
                        const data = await res.json();
                        this.subscriberCount = data.count || 0;
                    } catch (e) {
                        console.error('Failed to load subscriber count:', e);
                    }
                },

                showToast(message, type = 'success') {
                    this.toast = { show: true, message, type };
                    setTimeout(() => { this.toast.show = false; }, 4000);
                },

                // Change tracking methods
                get hasPendingChanges() {
                    return Object.keys(this.pendingChanges).length > 0;
                },

                get changesList() {
                    const changes = [];
                    for (const [id, change] of Object.entries(this.pendingChanges)) {
                        changes.push(change);
                    }
                    return changes;
                },

                get newProducts() {
                    return this.changesList.filter(c => c.isNew);
                },

                get restockedProducts() {
                    return this.changesList.filter(c => !c.isNew && c.wasOutOfStock && c.newStock > 0);
                },

                trackChange(product, field, newValue) {
                    const original = this.originalProducts[product.id];
                    if (!this.pendingChanges[product.id]) {
                        this.pendingChanges[product.id] = {
                            id: product.id,
                            name: product.name,
                            changes: {},
                            isNew: false,
                            wasOutOfStock: original?.stock_quantity === 0,
                            newStock: product.stock_quantity
                        };
                    }

                    // Get original value - handle price_cents specially
                    let originalValue;
                    if (field === 'price_cents') {
                        originalValue = original ? Math.round(original.price * 100) : null;
                    } else {
                        originalValue = original ? original[field] : null;
                    }

                    if (newValue !== originalValue) {
                        this.pendingChanges[product.id].changes[field] = {
                            from: originalValue,
                            to: newValue
                        };
                        // Update the display name
                        this.pendingChanges[product.id].name = product.name;
                    } else {
                        delete this.pendingChanges[product.id].changes[field];
                    }

                    // Update newStock for restock detection
                    if (field === 'stock_quantity') {
                        this.pendingChanges[product.id].newStock = newValue;
                    }

                    // Remove if no changes left
                    if (Object.keys(this.pendingChanges[product.id].changes).length === 0) {
                        delete this.pendingChanges[product.id];
                    }
                },

                discardChanges() {
                    this.pendingChanges = {};
                    this.loadProducts();
                },

                openReviewModal() {
                    this.showReviewModal = true;
                },

                async saveAllChanges(sendEmails = false) {
                    this.savingChanges = true;
                    try {
                        // Prepare batch update data
                        const updates = [];
                        for (const [id, change] of Object.entries(this.pendingChanges)) {
                            const product = this.products.find(p => p.id === id);
                            if (!product) {
                                console.error('Product not found in local list:', id);
                                continue;
                            }

                            updates.push({
                                id: product.id,
                                name: product.name,
                                description: product.description || null,
                                price_cents: Math.round(product.price * 100),
                                stock_quantity: parseInt(product.stock_quantity) || 0,
                                is_active: product.is_active,
                                was_out_of_stock: change.wasOutOfStock,
                                is_new: change.isNew
                            });
                        }

                        console.log('Sending batch update:', JSON.stringify({ updates, send_emails: sendEmails }, null, 2));

                        // Send batch update to backend
                        const res = await this.authFetch('/gallium/api/products-batch', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                updates: updates,
                                send_emails: sendEmails
                            })
                        });

                        let data;
                        const text = await res.text();
                        try {
                            data = text ? JSON.parse(text) : {};
                        } catch (e) {
                            console.error('Failed to parse response:', text);
                            throw new Error('Server returned invalid response: ' + text.substring(0, 100));
                        }

                        if (res.ok) {
                            this.showReviewModal = false;
                            this.pendingChanges = {};
                            await this.loadProducts();

                            if (sendEmails && data.emails_sent > 0) {
                                this.showToast(`Saved! ${data.emails_sent} emails sent.`, 'success');
                            } else {
                                this.showToast('Changes saved!', 'success');
                            }
                        } else {
                            this.showToast(data.error || 'Failed to save changes', 'error');
                        }
                    } catch (e) {
                        console.error('Failed to save changes:', e);
                        this.showToast('Failed to save changes', 'error');
                    } finally {
                        this.savingChanges = false;
                    }
                },

                getStockDisplay(product) {
                    // If product has styles, sum up the style quantities
                    if (product.styles && product.styles.length > 0) {
                        const totalStock = product.styles.reduce((sum, s) => sum + (s.stock_quantity || 0), 0);
                        return totalStock > 0 ? `In Stock (${totalStock})` : 'Out of Stock';
                    }
                    // Otherwise use the product's stock_quantity
                    return product.stock_quantity > 0 ? `In Stock (${product.stock_quantity})` : 'Out of Stock';
                },

                getImageById(imageId) {
                    if (!imageId || !this.stylesProduct || !this.stylesProduct.images) return null;
                    return this.stylesProduct.images.find(i => i.id === imageId);
                },

                getImageUrlById(imageId) {
                    const img = this.getImageById(imageId);
                    return img ? img.image_url : null;
                },

                async loadProducts() {
                    try {
                        const res = await this.authFetch('/gallium/api/products');
                        this.products = await res.json();
                        // Store original state for change tracking
                        this.originalProducts = {};
                        this.pendingChanges = {};
                        for (const p of this.products) {
                            this.originalProducts[p.id] = JSON.parse(JSON.stringify(p));
                        }
                    } catch (e) {
                        console.error('Failed to load products:', e);
                    }
                },

                async loadOrders() {
                    try {
                        const res = await this.authFetch('/gallium/api/orders');
                        this.orders = await res.json();
                    } catch (e) {
                        console.error('Failed to load orders:', e);
                    }
                },

                openProductModal() {
                    this.editingProduct = null;
                    this.productForm = { name: '', description: '', price: 0, stock_quantity: 0, weight_grams: null, length_cm: null, width_cm: null, height_cm: null };
                    this.productImages = [];
                    this.newImages = [];
                    this.showProductModal = true;
                },

                editProduct(product) {
                    this.editingProduct = product;
                    this.productForm = {
                        name: product.name,
                        description: product.description || '',
                        price: product.price,
                        stock_quantity: product.stock_quantity,
                        weight_grams: product.weight_grams || null,
                        length_cm: product.length_cm || null,
                        width_cm: product.width_cm || null,
                        height_cm: product.height_cm || null
                    };
                    this.productImages = (product.images || []).map(img => ({
                        id: img.id,
                        image_url: img.image_url,
                        isExisting: true
                    }));
                    this.newImages = [];
                    this.showProductModal = true;
                },

                openStylesModal(product) {
                    this.stylesProduct = product;
                    this.newStyleName = '';
                    this.newStyleStock = 0;
                    this.newStyleImageId = '';
                    this.showStylesModal = true;
                },

                async addStyle() {
                    if (!this.newStyleName.trim() || !this.stylesProduct) return;
                    this.savingStyle = true;
                    try {
                        const res = await fetch(`/gallium/api/products/${this.stylesProduct.id}/styles`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                name: this.newStyleName.trim(),
                                stock_quantity: this.newStyleStock || 0,
                                image_id: this.newStyleImageId || null
                            })
                        });
                        const updated = await res.json();
                        // Update the product in our list
                        const idx = this.products.findIndex(p => p.id === this.stylesProduct.id);
                        if (idx !== -1) {
                            this.products[idx] = updated;
                            this.stylesProduct = updated;
                        }
                        this.newStyleName = '';
                        this.newStyleStock = 0;
                        this.newStyleImageId = '';
                        this.showToast('Style added');
                    } catch (e) {
                        console.error('Failed to add style:', e);
                        this.showToast('Failed to add style', 'error');
                    } finally {
                        this.savingStyle = false;
                    }
                },

                async updateStyle(style) {
                    if (!this.stylesProduct) return;
                    try {
                        const res = await fetch(`/gallium/api/products/${this.stylesProduct.id}/styles/${style.id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                name: style.name,
                                stock_quantity: style.stock_quantity || 0,
                                image_id: style.image_id || null
                            })
                        });
                        const updated = await res.json();
                        const idx = this.products.findIndex(p => p.id === this.stylesProduct.id);
                        if (idx !== -1) {
                            this.products[idx] = updated;
                            this.stylesProduct = updated;
                        }
                    } catch (e) {
                        console.error('Failed to update style:', e);
                        this.showToast('Failed to update style', 'error');
                    }
                },

                async deleteStyle(styleId) {
                    if (!this.stylesProduct || !confirm('Delete this style?')) return;
                    try {
                        const res = await fetch(`/gallium/api/products/${this.stylesProduct.id}/styles/${styleId}`, {
                            method: 'DELETE'
                        });
                        const updated = await res.json();
                        const idx = this.products.findIndex(p => p.id === this.stylesProduct.id);
                        if (idx !== -1) {
                            this.products[idx] = updated;
                            this.stylesProduct = updated;
                        }
                        this.showToast('Style deleted');
                    } catch (e) {
                        console.error('Failed to delete style:', e);
                        this.showToast('Failed to delete style', 'error');
                    }
                },

                async handleStyleDrop(targetIdx) {
                    if (this.styleDragIdx === null || this.styleDragIdx === targetIdx || !this.stylesProduct) return;

                    // Reorder locally first for instant feedback
                    const styles = [...this.stylesProduct.styles];
                    const [moved] = styles.splice(this.styleDragIdx, 1);
                    styles.splice(targetIdx, 0, moved);
                    this.stylesProduct.styles = styles;

                    // Send reorder request to server
                    const styleIds = styles.map(s => s.id);
                    try {
                        const res = await fetch(`/gallium/api/products/${this.stylesProduct.id}/styles/reorder`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ style_ids: styleIds })
                        });
                        const updated = await res.json();
                        const idx = this.products.findIndex(p => p.id === this.stylesProduct.id);
                        if (idx !== -1) {
                            this.products[idx] = updated;
                            this.stylesProduct = updated;
                        }
                    } catch (e) {
                        console.error('Failed to reorder styles:', e);
                        this.showToast('Failed to reorder styles', 'error');
                    }

                    this.styleDragIdx = null;
                    this.styleDragOverIdx = null;
                },

                handleImageSelect(event) {
                    const files = Array.from(event.target.files);
                    this.addImages(files);
                    event.target.value = '';
                },

                handleImageDrop(event) {
                    const files = Array.from(event.dataTransfer.files).filter(f => f.type.startsWith('image/'));
                    this.addImages(files);
                },

                addImages(files) {
                    files.forEach(file => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            this.productImages.push({
                                file: file,
                                preview: e.target.result,
                                isNew: true
                            });
                            this.newImages.push(file);
                        };
                        reader.readAsDataURL(file);
                    });
                },

                startDrag(idx) {
                    this.dragIdx = idx;
                },

                endDrag() {
                    this.dragIdx = null;
                    this.dragOverIdx = null;
                },

                handleDrop(targetIdx) {
                    if (this.dragIdx === null || this.dragIdx === targetIdx) return;
                    const item = this.productImages.splice(this.dragIdx, 1)[0];
                    this.productImages.splice(targetIdx, 0, item);
                    this.dragIdx = null;
                    this.dragOverIdx = null;
                },

                async removeImage(idx, img) {
                    if (img.isExisting && this.editingProduct) {
                        try {
                            await fetch(`/gallium/api/products/${this.editingProduct.id}/images/${img.id}`, {
                                method: 'DELETE'
                            });
                        } catch (e) {
                            console.error('Failed to delete image:', e);
                            return;
                        }
                    }
                    this.productImages.splice(idx, 1);
                    if (img.isNew) {
                        const fileIdx = this.newImages.indexOf(img.file);
                        if (fileIdx > -1) this.newImages.splice(fileIdx, 1);
                    }
                },

                async saveProduct() {
                    try {
                        const price_cents = Math.round(parseFloat(this.productForm.price) * 100);
                        const productData = {
                            name: this.productForm.name,
                            description: this.productForm.description,
                            price_cents: price_cents,
                            stock_quantity: parseInt(this.productForm.stock_quantity) || 0,
                            weight_grams: this.productForm.weight_grams || null,
                            length_cm: this.productForm.length_cm || null,
                            width_cm: this.productForm.width_cm || null,
                            height_cm: this.productForm.height_cm || null
                        };

                        let productId = this.editingProduct?.id;

                        if (this.editingProduct) {
                            await fetch(`/gallium/api/products/${productId}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(productData)
                            });
                        } else {
                            const res = await this.authFetch('/gallium/api/products', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(productData)
                            });
                            const created = await res.json();
                            productId = created.id;
                        }

                        // Upload new images
                        for (const file of this.newImages) {
                            const formData = new FormData();
                            formData.append('file', file);
                            await fetch(`/gallium/api/products/${productId}/images`, {
                                method: 'POST',
                                body: formData
                            });
                        }

                        // Reorder if editing and order changed
                        if (this.editingProduct) {
                            const imageIds = this.productImages.filter(img => img.isExisting).map(img => img.id);
                            if (imageIds.length > 0) {
                                await fetch(`/gallium/api/products/${productId}/images/reorder`, {
                                    method: 'PUT',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ image_ids: imageIds })
                                });
                            }
                        }

                        this.showProductModal = false;
                        this.productImages = [];
                        this.newImages = [];
                        await this.loadProducts();
                    } catch (e) {
                        console.error('Failed to save product:', e);
                    }
                },

                async toggleProductActive(product) {
                    try {
                        await fetch(`/gallium/api/products/${product.id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ is_active: !product.is_active })
                        });
                        await this.loadProducts();
                    } catch (e) {
                        console.error('Failed to toggle product:', e);
                    }
                },

                async deleteProduct(id) {
                    if (!confirm('Delete this product?')) return;
                    try {
                        await fetch(`/gallium/api/products/${id}`, { method: 'DELETE' });
                        await this.loadProducts();
                    } catch (e) {
                        console.error('Failed to delete product:', e);
                    }
                },

                viewOrder(order) {
                    this.selectedOrder = order;
                    this.showOrderModal = true;
                },

                async updateOrderStatus(orderId, status) {
                    try {
                        await fetch(`/gallium/api/orders/${orderId}/status`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ status })
                        });
                        await this.loadOrders();
                    } catch (e) {
                        console.error('Failed to update order status:', e);
                    }
                },

                async refundOrder(order) {
                    if (!confirm(`Refund $${order.total.toFixed(2)} for order ${order.id.substring(0, 8)}?\n\nThis will:\n- Issue a full refund via Stripe\n- Restore product stock\n- Send refund confirmation email`)) {
                        return;
                    }
                    try {
                        const res = await fetch(`/gallium/api/orders/${order.id}/refund`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ reason: 'requested_by_customer' })
                        });
                        if (!res.ok) {
                            const err = await res.json();
                            throw new Error(err.error || 'Refund failed');
                        }
                        const result = await res.json();
                        alert(`Refund processed: $${(result.amount_cents / 100).toFixed(2)}`);
                        await this.loadOrders();
                    } catch (e) {
                        alert('Refund failed: ' + e.message);
                        console.error('Failed to refund order:', e);
                    }
                },

                openTrackingModal(order) {
                    this.trackingOrderId = order.id;
                    this.trackingForm = { tracking_number: '', carrier: '' };
                    this.showTrackingModal = true;
                },

                async saveTracking() {
                    try {
                        await fetch(`/gallium/api/orders/${this.trackingOrderId}/tracking`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.trackingForm)
                        });
                        this.showTrackingModal = false;
                        await this.loadOrders();
                    } catch (e) {
                        console.error('Failed to save tracking:', e);
                    }
                },

                async openBuyLabelModal(order) {
                    this.labelOrderId = order.id;
                    this.labelRates = [];
                    this.selectedLabelRate = null;
                    this.showBuyLabelModal = true;
                    this.loadingLabelRates = true;
                    try {
                        const res = await fetch(`/gallium/api/orders/${order.id}/shipping-rates`);
                        if (res.ok) {
                            this.labelRates = await res.json();
                            if (this.labelRates.length > 0) {
                                this.selectedLabelRate = this.labelRates[0];
                            }
                        } else {
                            const err = await res.json();
                            this.showToast(err.error || 'Failed to load rates', 'error');
                        }
                    } catch (e) {
                        console.error('Failed to load shipping rates:', e);
                        this.showToast('Failed to load shipping rates', 'error');
                    } finally {
                        this.loadingLabelRates = false;
                    }
                },

                async purchaseLabel() {
                    if (!this.selectedLabelRate || !this.labelOrderId) return;
                    this.purchasingLabel = true;
                    try {
                        const res = await fetch(`/gallium/api/orders/${this.labelOrderId}/buy-label`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ rate_id: this.selectedLabelRate.rate_id })
                        });
                        if (res.ok) {
                            const data = await res.json();
                            this.showToast('Label purchased! Tracking: ' + data.tracking_number, 'success');
                            this.showBuyLabelModal = false;
                            await this.loadOrders();
                            // Open the label PDF in a new tab
                            if (data.label_url) {
                                window.open(data.label_url, '_blank');
                            }
                        } else {
                            const err = await res.json();
                            this.showToast(err.error || 'Failed to purchase label', 'error');
                        }
                    } catch (e) {
                        console.error('Failed to purchase label:', e);
                        this.showToast('Failed to purchase label', 'error');
                    } finally {
                        this.purchasingLabel = false;
                    }
                },

                async loadArtistSettings() {
                    try {
                        const res = await this.authFetch('/gallium/api/settings/artist');
                        const data = await res.json();
                        this.artistSettings = {
                            image: data.image,
                            description: data.description,
                            imagePreview: null,
                            newImageFile: null
                        };
                    } catch (e) {
                        console.error('Failed to load artist settings:', e);
                    }
                },

                async loadSiteSettings() {
                    try {
                        const res = await this.authFetch('/gallium/api/settings/favicon');
                        const data = await res.json();
                        this.favicon = data.url;
                    } catch (e) {
                        console.error('Failed to load favicon:', e);
                    }
                },

                async loadShippingSettings() {
                    try {
                        const res = await this.authFetch('/gallium/api/settings/shipping');
                        const data = await res.json();
                        this.shippingSettings.unit_system = data.unit_system || 'metric';
                        if (data.address) {
                            this.shippingSettings.address = {
                                name: data.address.name || '',
                                street1: data.address.street1 || '',
                                street2: data.address.street2 || '',
                                city: data.address.city || '',
                                state: data.address.state || '',
                                zip: data.address.zip || '',
                                country: data.address.country || 'US',
                                phone: data.address.phone || ''
                            };
                        }
                    } catch (e) {
                        console.error('Failed to load shipping settings:', e);
                    }
                },

                async saveShopAddress() {
                    this.savingShipping = true;
                    try {
                        const res = await this.authFetch('/gallium/api/settings/shipping/address', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.shippingSettings.address)
                        });
                        if (res.ok) {
                            this.showToast('Address saved!', 'success');
                        } else {
                            const err = await res.json();
                            this.showToast(err.error || 'Failed to save address', 'error');
                        }
                    } catch (e) {
                        console.error('Failed to save shop address:', e);
                        this.showToast('Failed to save address', 'error');
                    } finally {
                        this.savingShipping = false;
                    }
                },

                async saveUnitSystem() {
                    try {
                        const res = await this.authFetch('/gallium/api/settings/shipping/units', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ unit_system: this.shippingSettings.unit_system })
                        });
                        if (res.ok) {
                            this.showToast('Unit system updated!', 'success');
                        }
                    } catch (e) {
                        console.error('Failed to save unit system:', e);
                    }
                },

                handleFaviconSelect(event) {
                    const file = event.target.files[0];
                    if (file) {
                        this.faviconFile = file;
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            this.faviconPreview = e.target.result;
                        };
                        reader.readAsDataURL(file);
                    }
                    event.target.value = '';
                },

                async saveFavicon() {
                    if (!this.faviconFile) return;
                    this.savingFavicon = true;
                    try {
                        const formData = new FormData();
                        formData.append('file', this.faviconFile);
                        const res = await this.authFetch('/gallium/api/settings/favicon', {
                            method: 'PUT',
                            body: formData
                        });
                        const data = await res.json();
                        this.favicon = data.url;
                        this.faviconPreview = null;
                        this.faviconFile = null;
                        this.showToast('Favicon saved!', 'success');
                    } catch (e) {
                        console.error('Failed to save favicon:', e);
                        this.showToast('Failed to save favicon', 'error');
                    } finally {
                        this.savingFavicon = false;
                    }
                },

                handleArtistImageSelect(event) {
                    const file = event.target.files[0];
                    if (file) {
                        this.artistSettings.newImageFile = file;
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            this.artistSettings.imagePreview = e.target.result;
                        };
                        reader.readAsDataURL(file);
                    }
                    event.target.value = '';
                },

                async saveArtistSettings() {
                    this.savingArtist = true;
                    try {
                        // Upload new image if selected
                        if (this.artistSettings.newImageFile) {
                            const formData = new FormData();
                            formData.append('file', this.artistSettings.newImageFile);
                            await this.authFetch('/gallium/api/settings/artist/image', {
                                method: 'PUT',
                                body: formData
                            });
                        }

                        // Save description
                        await this.authFetch('/gallium/api/settings/artist', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ description: this.artistSettings.description })
                        });

                        // Reload to get updated data
                        await this.loadArtistSettings();
                    } catch (e) {
                        console.error('Failed to save artist settings:', e);
                    } finally {
                        this.savingArtist = false;
                    }
                },

                async logout(e) {
                    // Guard against Firefox bfcache auto-triggering
                    if (!e || !e.isTrusted) return;
                    if (window.Clerk) {
                        await window.Clerk.signOut();
                    }
                    window.location.href = '/';
                }
            };
        }
    </script>
</body>
</html>
